<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Moore's Daily Summary</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    /* Copied styles from index.html for design consistency */
    body {
      margin: 0;
      background-color: #f4f4f4;
      font-family: "Inter", "system-ui", "Segoe UI", "Helvetica Neue", Arial, sans-serif;
      font-size: 13.5px;
      font-weight: 400;
      line-height: 1.35;
      letter-spacing: 0.15px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
      padding-top: env(safe-area-inset-top, 0);
    }

    .main-container {
      max-width: 400px;
      margin: 10px auto;
      padding: 0 5px;
    }

    .freeze-pane {
      position: sticky;
      top: env(safe-area-inset-top, 0);
      z-index: 100;
      background: #f4f4f4;
      padding: 0;
    }

    .header-box {
      background-color: #1e3a8a;
      border-radius: 10px 10px 0 0;
      padding: 5px;
      text-align: center;
      margin-bottom: 0;
    }

    .header-box h2 {
      margin: 0;
      font-size: 18px;
      font-weight: bold;
      color: white;
      padding: 2px 0;
      white-space: nowrap;
    }

    .control-bar {
      background-color: #eeeeee;
      padding: 4px 6px;
      border-radius: 12px;
    }

    .control-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 2px;
      margin: 0;
    }

    .control-half {
      width: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      white-space: nowrap;
    }

    button {
      padding: 6px 12px;
      font-size: 14px;
      font-weight: 600;
      font-family: "Inter", sans-serif;
      background-color: #FFA500;
      color: rgb(77, 75, 71);
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.3s ease, transform 0.1s ease;
      display: inline-block;
      margin: 2px 0;
      white-space: nowrap;
      line-height: 1.2;
      letter-spacing: 0.3px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.15);
    }

    button:hover {
      background-color: #e59400;
      transform: scale(1.02);
    }

    button:disabled {
      background-color: gray;
      cursor: not-allowed;
      opacity: 0.7;
    }
    
    .summary-for-box {
      background: #26A69A;
      color: #fff;
      padding: 8px 12px;
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(38, 166, 154, 0.3);
      font-family: "Rubik", sans-serif;
      font-weight: 700;
      text-align: center;
      margin: 8px auto;
    }
    .summary-for-box span {
      display: block;
      font-size: 14px;
      line-height: 1.2;
    }
    .summary-for-box .date {
      font-size: 16px;
      letter-spacing: 1px;
    }

    #weatherData {
      background: #ffffff;
      padding: 8px 10px 12px 10px;
      border-radius: 0 0 12px 12px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
      font-size: 13.5px;
      color: #222;
      text-align: left;
      margin-bottom: 15px;
    }

    #weatherData p { margin: 2px 0; line-height: 1.4; white-space: nowrap; }
    hr { border: none; border-top: 1px solid #ccc; margin: 5px 0; clear: both; width: 100%; }

    .header-content { display: flex; justify-content: space-between; align-items: center; margin: 5px 0; white-space: nowrap; }
    .title-date-container { display: flex; flex-direction: column; white-space: nowrap; }
    .address-title { font-size: 18px; font-weight: bold; margin: 0 0 2px 0; color: #00008B; white-space: nowrap; }
    .date-time p { margin: 0; line-height: 1.3; white-space: nowrap; }
    .logo-container { display: flex; gap: 5px; margin: 0; padding: 0; }
    .logo-container img { height: 60px; width: auto; margin: 0; display: block; border-radius: 8px; }
    .logo-container img:last-child { padding-right: 4px; }
    
    .wind-logger-container { display: flex; justify-content: space-between; gap: 10px; margin: 5px 0; white-space: nowrap; }
    .wind-column { width: 60%; white-space: nowrap; }
    .logger-column { width: 40%; display: flex; flex-direction: column; align-items: center; justify-content: center; white-space: nowrap; }
    
    .big-temp-box {
      width: 98px; height: 38px; padding: 4px 6px; border-radius: 10px;
      background: linear-gradient(to bottom, rgba(255,255,255,0.1), rgba(0,0,0,0.15));
      box-shadow: inset 0 0 4px rgba(0, 0, 0, 0.25), 0 2px 6px rgba(0, 0, 0, 0.2);
      font-size: 16px; font-family: 'Rubik', sans-serif; font-weight: bold; text-align: center; color: #FFF;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      word-wrap: break-word; line-height: 1; letter-spacing: 0.2px; border: 1px solid rgba(255,255,255,0.4);
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
    }
    .big-temp-box span.label { font-size: 12px; font-weight: 600; color: white; margin-top: 1px; line-height: 1.1; letter-spacing: 0.2px; }
    .big-temp-box + .big-temp-box { margin-top: 8px; }

    .rain-container { margin-top: 7px; margin-bottom: 3px; padding: 1px; border: 1px solid #ccc; border-radius: 8px; background: #f9f9f9; white-space: nowrap; }
    .evap-battery { display: flex; justify-content: space-between; margin: 5px 0; white-space: nowrap; }
    .evap-col, .battery-col { width: 48%; white-space: nowrap; }
    .soil-moisture { display: flex; justify-content: space-between; margin: 5px 0; white-space: nowrap; }
    .soiltemp-col, .moisture-col { width: 48%; white-space: nowrap; }

    .spinner-container { display: none; margin: 20px auto; width: 40px; height: 40px; }
    .spinner { width: 100%; height: 100%; border: 4px solid #f3f3f3; border-top: 4px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .error-message { color: #d32f2f; text-align: center; margin: 10px 0; font-weight: bold; }
    
    @media only screen and (max-width: 600px) {
      .main-container { max-width: 400px; margin: 5px auto; padding: 0 5px; }
      .header-box { padding: 0; }
    }
  </style>
</head>
<body>
  <div class="main-container">
    <div class="freeze-pane">
      <div class="header-box">
        <h2>Moore's Daily Summary</h2>
      </div>

      <div id="weatherData">
        <div class="control-bar">
          <div class="control-container">
            <div class="control-half">
              <button class="back-button" onclick="location.href='index.html'">‚Üê Current Readings</button>
            </div>
            <div class="control-half">
              <button id="forceUpdateBtn" onclick="forceSummaryFetch()">üîÅ Force Update</button>
            </div>
          </div>
        </div>

        <hr>

        <div class="header-content">
          <div class="title-date-container">
            <div class="address-title">WEST WARWICK, QLD</div>
            <div class="date-time">
              <p><b>üìÜ Date Generated:</b> <span id="summaryDate">--</span></p>
              <p><b>‚è∞ Time Generated:</b> <span id="summaryTime">--</span></p>
            </div>
          </div>
          <div class="logo-container">
            <img src="/Weather_Station_App.png" alt="Weather Station Icon">
            <a href="index.html" aria-label="View live readings">
              <img src="/Station_Label.png" alt="Environdata Weather Maestro">
            </a>
          </div>
        </div>
        
        <div id="summaryForContainer" class="summary-for-box">
          <span>Daily Summary for:</span>
          <span id="summaryForDay" class="date">--</span>
        </div>
        <hr>

        <div class="wind-logger-container">
          <div class="wind-column">
            <p><b>üí® Avg/Max Wind Speed:</b> <span id="windAvg">--</span> / <span id="windMax">--</span> km/h</p>
            <p><b>üß≠ Avg Wind Direction:</b> <span id="windDir">--</span>¬∞ (<span id="windDirText">--</span>)</p>
            <p><b>üí¶ Avg Humidity:</b> <span id="humidityAvg">--</span>%</p>
            <p><b>üå°Ô∏è Min/Avg/Max Temp:</b> <span id="tempMin">--</span>/<span id="tempAvg">--</span>/<span id="tempMax">--</span> ¬∞C</p>
            <p><b>‚òÄÔ∏è Avg/Max Solar:</b> <span id="solarAvg">--</span> / <span id="solarMax">--</span> W/m¬≤</p>
            <p><b>üîò Min/Avg/Max Globe:</b> <span id="globeMin">--</span>/<span id="globeAvg">--</span>/<span id="globeMax">--</span> ¬∞C</p>
            <p><b>üå± Min/Avg/Max Garden:</b> <span id="dirtMin">--</span>/<span id="dirtAvg">--</span>/<span id="dirtMax">--</span> ¬∞C</p>
            <p><b>üåÄ Avg Pressure:</b> <span id="pressureAvg">--</span> hPa</p>
            <div class="rain-container">
              <p><b>üåßÔ∏è Total Rainfall:</b> <span id="rainTotal">--</span> mm</p>
            </div>
          </div>
          <div class="logger-column">
            <div class="big-temp-box" id="airTempBox">
              <span id="bigTempAvg">--</span>
              <span class="label">Avg Air Temp</span>
            </div>
            <div class="big-temp-box" id="radiantDiffBox">
              <span id="radiantDiffAvg">--</span>
              <span class="label">Avg Rad. Heat Diff</span>
            </div>
            <div class="big-temp-box" id="dewDiffBox">
              <span id="dewDiffAvg">--</span>
              <span class="label">Avg Temp > Dew P.</span>
            </div>
          </div>        
        </div>
        <hr>
        
        <div class="evap-battery">
          <div class="evap-col">
            <p><b>‚¨ÜÔ∏è Total Daily Evap:</b> <span id="evapTotal">--</span> mm</p>
            <p><b>üíß Avg Dew Point:</b> <span id="dewAvg">--</span>¬∞C</p>
          </div>
          <div class="battery-col">
            <p><b>üå¨Ô∏è Peak Wind Gust:</b> <span id="gustPeak">--</span> km/h</p>
            <p><b>üîã Min Battery:</b> <span id="batteryMin">--</span> V</p>
          </div>
        </div>
        <hr>

        <div class="soil-moisture">
          <div class="soiltemp-col">
            <p><b>üå°Ô∏è Avg Soil Temp:</b> <span id="soilTemp">--</span>¬∞C</p>
          </div>
          <div class="moisture-col">
            <p><b>üíß Avg Soil Moisture:</b> <span id="soilMoisture">--</span>%</p>
          </div>
        </div>
        <hr>
      </div>

      <div id="spinnerContainer" class="spinner-container"><div class="spinner"></div></div>
      <div id="errorMessage" class="error-message" style="display: none;"></div>
    </div>
  </div>

  <script>
    const SUMMARY_ENDPOINT = "/daily";

    /********************
    * HELPER FUNCTIONS (from index.html)
    ********************/
    function getWindDirection(degrees) {
      const directions = ["N", "NNE", "NE", "ENE", "E", "ESE", "SE", "SSE", "S", "SSW", "SW", "WSW", "W", "WNW", "NW", "NNW"];
      return directions[Math.round(degrees / 22.5) % 16];
    }

    function getTemperatureColor(temp) {
      if (temp < -20) return "#000000";
      if (temp < -10) return "#191970";
      if (temp < 0) return "#00008B";
      if (temp < 6) return "#104E8B";
      if (temp < 11) return "#4682B4";
      if (temp < 16) return "#32CD32";
      if (temp < 21) return "#228B22";
      if (temp < 28) return "#D4A017";
      if (temp < 32) return "#FF8C00";
      if (temp < 36) return "#FF4500";
      if (temp < 41) return "#B22222";
      if (temp <= 60) return "#8B0000";
      return "#000000";
    }

    /*****************************
    * MAIN UPDATE FUNCTION
    *****************************/
    function updateSummaryUI(data) {
      const fields = data.split(',');
      if (fields.length !== 43) {
        document.getElementById("errorMessage").textContent = `Error: Invalid data format. Received ${fields.length} fields, expected 43.`;
        document.getElementById("errorMessage").style.display = "block";
        return;
      }

      // --- DESTRUCTURE AND PARSE VALUES ---
      const [date, time, ...vals] = fields;
      const tempAvg = parseFloat(vals[13]);
      const globeAvg = parseFloat(vals[38]);
      const dewAvg = parseFloat(vals[17]);

      // --- POPULATE UI ELEMENTS ---
      document.getElementById("summaryDate").textContent = date ? `${date} (${new Date(date).toLocaleString('en-US', { weekday: 'long' })})` : "--";
      document.getElementById("summaryTime").textContent = time ? `${time} AEST` : "--";
      
      document.getElementById("rainTotal").textContent = vals[14] || "--";
      document.getElementById("tempMax").textContent = vals[11] || "--";
      document.getElementById("tempMin").textContent = vals[12] || "--";
      document.getElementById("tempAvg").textContent = vals[13] || "--";
      document.getElementById("globeMax").textContent = vals[39] || "--";
      document.getElementById("globeMin").textContent = vals[40] || "--";
      document.getElementById("globeAvg").textContent = vals[38] || "--";
      document.getElementById("solarMax").textContent = vals[37] || "--";
      document.getElementById("solarAvg").textContent = vals[15] || "--";
      document.getElementById("humidityAvg").textContent = vals[10] || "--";
      document.getElementById("dewAvg").textContent = dewAvg.toFixed(1) || "--";
      document.getElementById("evapTotal").textContent = vals[16] || "--";
      document.getElementById("dirtMax").textContent = vals[32] || "--";
      document.getElementById("dirtMin").textContent = vals[33] || "--";
      document.getElementById("dirtAvg").textContent = vals[31] || "--";
      document.getElementById("windMax").textContent = vals[0] || "--";
      document.getElementById("windAvg").textContent = vals[1] || "--";
      document.getElementById("gustPeak").textContent = vals[5] || "--";
      const windDirAvg = parseFloat(vals[7]);
      document.getElementById("windDir").textContent = isNaN(windDirAvg) ? "--" : windDirAvg.toFixed(1);
      document.getElementById("windDirText").textContent = isNaN(windDirAvg) ? "--" : getWindDirection(windDirAvg);
      document.getElementById("pressureAvg").textContent = vals[34] || "--";
      document.getElementById("soilTemp").textContent = vals[23] || "--";
      document.getElementById("soilMoisture").textContent = vals[27] || "--";
      document.getElementById("batteryMin").textContent = vals[18] || "--";

      // --- BIG TEMP BOXES (with average values) ---
      const bigTempAvgElem = document.getElementById("bigTempAvg");
      bigTempAvgElem.textContent = tempAvg.toFixed(1) + "¬∞C";
      document.getElementById("airTempBox").style.backgroundColor = getTemperatureColor(tempAvg);

      const radiantDiffAvg = globeAvg - tempAvg;
      const radiantDiffAvgElem = document.getElementById("radiantDiffAvg");
      radiantDiffAvgElem.textContent = (radiantDiffAvg >= 0 ? "+" : "") + radiantDiffAvg.toFixed(1) + "¬∞C";
      document.getElementById("radiantDiffBox").style.backgroundColor = radiantDiffAvg >= 0 ? "#d94a38" : "#4682B4";

      const dewDiffAvg = tempAvg - dewAvg;
      const dewDiffAvgElem = document.getElementById("dewDiffAvg");
      dewDiffAvgElem.textContent = (dewDiffAvg >= 0 ? "+" : "") + dewDiffAvg.toFixed(1) + "¬∞C";
      document.getElementById("dewDiffBox").style.backgroundColor = dewDiffAvg < 1.5 ? "#A6C6C9" : "#BBAA98";

      // --- SUMMARY FOR DAY BOX ---
      if (date && date !== "--") {
        try {
          const [year, month, day] = date.split('/');
          const dateObj = new Date(`${year}-${month}-${day}`);
          dateObj.setDate(dateObj.getDate() - 1); // Summary is for the previous day
          const dayNames = ["SUN", "MON", "TUES", "WED", "THURS", "FRI", "SAT"];
          const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
          const dayName = dayNames[dateObj.getDay()];
          const monthName = monthNames[dateObj.getMonth()];
          const dayWithSuffix = dateObj.getDate() + (dateObj.getDate() % 10 === 1 && dateObj.getDate() !== 11 ? "st" : dateObj.getDate() % 10 === 2 && dateObj.getDate() !== 12 ? "nd" : dateObj.getDate() % 10 === 3 && dateObj.getDate() !== 13 ? "rd" : "th");
          document.getElementById("summaryForDay").textContent = `${dayName} ${dayWithSuffix} ${monthName} ${dateObj.getFullYear()}`;
        } catch (e) {
          document.getElementById("summaryForDay").textContent = "--";
        }
      } else {
        document.getElementById("summaryForDay").textContent = "--";
      }

      document.getElementById("errorMessage").style.display = "none";
    }

    /*****************************
    * FETCH & POLLING LOGIC (from original daily.html)
    *****************************/
    function forceSummaryFetch(isInitialLoad = false) {
      const spinner = document.getElementById("spinnerContainer");
      const errorMessage = document.getElementById("errorMessage");
      const forceBtn = document.getElementById("forceUpdateBtn");
      const url = isInitialLoad ? SUMMARY_ENDPOINT : `${SUMMARY_ENDPOINT}?force=1`;

      spinner.style.display = "block";
      errorMessage.style.display = "none";
      forceBtn.disabled = true;

      fetch(url)
        .then(response => {
          if (!response.ok) throw new Error(`Server responded with ${response.status}`);
          return response.text();
        })
        .then(data => {
          if (data && data.includes(',')) {
            updateSummaryUI(data.trim());
          } else {
            throw new Error(data || "Empty or invalid response from server.");
          }
        })
        .catch(error => {
          console.error("Fetch error:", error);
          errorMessage.textContent = `Error: ${error.message}`;
          errorMessage.style.display = "block";
        })
        .finally(() => {
          spinner.style.display = "none";
          forceBtn.disabled = false;
        });
    }

    function startInitialFetch() {
      const now = new Date();
      // Fetch data on load. The server-side caching will handle providing stale data until the 9AM update.
      forceSummaryFetch(true); 
    }

    window.addEventListener("load", startInitialFetch);
  </script>
</body>
</html>