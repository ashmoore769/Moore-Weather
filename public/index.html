<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Link the apple-touch-icon relative to the root if served statically -->
  <link rel="apple-touch-icon" href="/Weather_Station_App.png">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Rubik:wght@600&display=swap" rel="stylesheet">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Moore's LIVE Weather Data</title>
  <style>
    /* Base Styles - FROM THE WORKING VERSION */
    :root {
        --bg-color: #f4f4f4;
        --card-bg: #ffffff;
        --primary-text: #222;
        --header-bg: #00008B;
        --header-text: white;
        --button-bg: #FFA500;
        --button-text: black;
        --button-hover-bg: #e59400;
        --status-connected-bg: #006400;
        --status-connected-text: white;
        --status-connected-border: #006400;
        --status-fetching-text: #DAA520;
        --status-fetching-border: #DAA520;
        --status-error-text: #B22222;
        --status-error-border: #B22222;
        --border-color: #ccc;
        --shadow-color: rgba(0, 0, 0, 0.08);
        --inset-shadow-color: rgba(0, 0, 0, 0.25);
        --outer-shadow-color: rgba(0, 0, 0, 0.2);
        --label-text: #555; /* Softer label color */
    }

    body {
      margin: 0;
      background-color: var(--bg-color);
      font-family: "Inter", "system-ui", "Segoe UI", "Helvetica Neue", Arial, sans-serif;
      font-size: 13.5px;
      font-weight: 400;
      line-height: 1.35;
      letter-spacing: 0.15px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
      padding-top: env(safe-area-inset-top, 0);
      color: var(--primary-text);
    }

    .main-container {
      max-width: 400px;
      margin: 10px auto;
      padding: 0 5px;
    }

    /* --- Animations --- */
    @keyframes pulse {
      0% { transform: scale(1); box-shadow: inset 0 0 4px var(--inset-shadow-color), 0 2px 6px var(--outer-shadow-color); }
      50% { transform: scale(1.03); box-shadow: inset 0 0 6px var(--inset-shadow-color), 0 4px 8px var(--outer-shadow-color); }
      100% { transform: scale(1); box-shadow: inset 0 0 4px var(--inset-shadow-color), 0 2px 6px var(--outer-shadow-color); }
    }

    .big-temp-box.updated {
      animation: pulse 0.3s ease-in-out;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* --- Sticky Header & Controls --- */
    .freeze-pane {
      position: sticky;
      top: env(safe-area-inset-top, 0);
      z-index: 100;
      background: var(--bg-color);
      padding: 0;
    }

    .header-box {
      background-color: var(--header-bg);
      border-radius: 10px;
      padding: 5px;
      text-align: center;
    }

    .header-box h2 {
      margin: 0;
      font-size: 18px;
      font-weight: bold;
      color: var(--header-text);
      padding: 4px 0;
      white-space: nowrap;
    }

    .control-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 2px;
      margin-bottom: 0;
      margin-top: 2px;
    }

    .control-half {
      width: 50%;
      text-align: center;
      white-space: nowrap;
    }

    button {
      padding: 6px 12px;
      font-size: 14px;
      font-weight: 600;
      font-family: "Inter", "system-ui", "Segoe UI", "Helvetica Neue", Arial, sans-serif;
      background-color: var(--button-bg);
      color: var(--button-text);
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.1s ease, box-shadow 0.3s ease;
      display: inline-block;
      margin: 2px 0;
      white-space: nowrap;
      line-height: 1.2;
      letter-spacing: 0.3px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.15);
    }

    button:hover:not(:disabled) {
      background-color: var(--button-hover-bg);
      transform: scale(1.02);
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    button:disabled {
      background-color: gray;
      cursor: not-allowed;
      opacity: 0.7;
      box-shadow: none;
      transform: none;
    }

    #status {
      padding: 0;
      margin: 0;
    }

    .status-badge {
      display: inline-block;
      padding: 6px 12px;
      font-size: 14px;
      font-weight: bold;
      border-radius: 10px;
      background-color: var(--card-bg);
      color: var(--label-text);
      border: 2px solid var(--label-text);
      line-height: 1;
      transition: all 0.3s ease;
      white-space: nowrap;
    }
    /* Add waiting class style */
     .status-badge.waiting {
      color: var(--label-text);
      border-color: var(--label-text);
     }
    .status-badge.connected {
      background-color: var(--status-connected-bg);
      color: var(--status-connected-text);
      border-color: var(--status-connected-border);
    }
    .status-badge.fetching {
      color: var(--status-fetching-text);
      border-color: var(--status-fetching-border);
      background-color: var(--card-bg);
    }
    .status-badge.error {
      color: var(--status-error-text);
      border-color: var(--status-error-border);
      background-color: var(--card-bg);
    }

    /* --- Spinner --- */
    .spinner-container {
      display: none;
      margin: 20px auto;
      width: 40px;
      height: 40px;
    }
    .spinner {
      width: 100%;
      height: 100%;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #007bff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    /* --- Weather Data Container & Content - FROM WORKING VERSION --- */
    #weatherData {
      background: var(--card-bg);
      padding: 8px 10px 12px 10px;
      border-radius: 12px;
      box-shadow: 0 2px 4px var(--shadow-color);
      font-size: 13.5px;
      color: var(--primary-text);
      text-align: left;
      margin-top: 5px;
      margin-bottom: 15px;
    }

    #weatherData p {
      margin: 2px 0; /* Keep original spacing */
      line-height: 1.4; /* Slightly increase for emoji height */
      white-space: nowrap;
      /* Keep original display (likely block or default) */
    }
    /* Styling for bold labels within <p> - KEEPING MIN-WIDTH AND ::AFTER */
    #weatherData p b {
        color: var(--label-text);
        font-weight: 600;
        display: inline-block; /* Crucial */
        min-width: 120px;      /* Crucial for alignment */
        margin-right: 4px;    /* Space before value */
    }
    #weatherData p b::after {
        content: ":";         /* Add colon separator via CSS */
        margin-left: -1px;    /* Fine-tune colon position */
    }

     /* Adjust specific label widths as before */
    #weatherData .evap-battery p b,
    #weatherData .soil-moisture p b {
        min-width: 95px;
    }
    #weatherData .rain-container p b {
        min-width: 100px;
    }
    /* Keep date/time specific adjustments */
    .date-time p b {
      min-width: 45px;
      margin-right: 4px; /* Consistent spacing */
    }
    .date-time p b::after {
       content: ":"; margin-left: -1px;
    }

    /* ‚ú® NEW MINIMAL CSS FOR EMOJI SPACING ‚ú® */
    #weatherData p .emoji {
        display: inline-block; /* Allow margin */
        margin-right: 6px;    /* Space between emoji and label */
        width: 1.1em;         /* Give it a bit of defined space */
        text-align: center;   /* Center emoji if width is noticeable */
        vertical-align: baseline; /* Align with text */
    }
    /* Special adjustment for date/time emoji if needed */
    .date-time p .emoji {
        margin-right: 4px; /* Slightly tighter spacing maybe */
    }
     /* Special adjustment for rain container emoji */
    .rain-container p .emoji {
        margin-right: 6px; /* Consistent spacing */
    }

    hr {
      border: none;
      border-top: 1px solid var(--border-color);
      margin: 5px 0;
      clear: both;
      width: 100%;
    }

    /* --- Header Layout within Weather Data --- */
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 5px 0;
      white-space: nowrap;
    }
    .title-date-container { display: flex; flex-direction: column; white-space: nowrap; }
    .address-title { font-size: 18px; font-weight: bold; margin: 0 0 2px 0; color: var(--header-bg); white-space: nowrap; }
    .date-time { margin: 0; }
    .date-time p { margin: 0; line-height: 1.3; } /* Restore tighter line height specific to date/time */

    .logo-container { display: flex; gap: 5px; margin: 0; padding: 0; }
    .logo-container img { height: 60px; width: auto; margin: 0; display: block; border-radius: 8px; }
    .logo-container img:last-child { padding-right: 4px; }

    /* --- Main Data Layout --- */
    .wind-logger-container { display: flex; justify-content: space-between; gap: 10px; margin: 5px 0; white-space: nowrap; }
    .wind-column { width: 60%; }
    .logger-column { width: 40%; display: flex; flex-direction: column; align-items: center; justify-content: center; }

    /* Big Temp Box Styles - FROM WORKING VERSION */
    .big-temp-box {
        width: 98px; height: 38px; padding: 4px 6px; border-radius: 10px;
        background: linear-gradient(to bottom, rgba(255,255,255,0.1), rgba(0,0,0,0.15));
        box-shadow: inset 0 0 4px var(--inset-shadow-color), 0 2px 6px var(--outer-shadow-color);
        font-size: 16px; font-family: 'Rubik', sans-serif; font-weight: 600;
        text-align: center; color: var(--header-text); text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        word-wrap: break-word; line-height: 1; letter-spacing: 0.2px;
        border: 1px solid rgba(255,255,255,0.4);
        transition: background-color 0.3s ease, box-shadow 0.3s ease, transform 0.1s ease;
        -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
    }
    .big-temp-box span.label { font-size: 11px; font-weight: 600; color: white; margin-top: 2px; line-height: 1.1; letter-spacing: 0.2px; }
    .big-temp-box + .big-temp-box { margin-top: 8px; }

    /* --- Other Data Sections --- */
    .rain-container { margin-top: 7px; margin-bottom: 3px; padding: 3px 8px; border: 1px solid var(--border-color); border-radius: 8px; background: #f9f9f9; }
    .evap-battery, .soil-moisture { display: flex; justify-content: space-between; margin: 5px 0; }
    .evap-col { width: 52%; }
    .battery-col { width: 48%; }
    .soiltemp-col, .moisture-col { width: 48%; }

    /* --- Media Queries - FROM WORKING VERSION --- */
    @media only screen and (max-width: 600px) {
      .main-container { max-width: 100%; margin: 5px auto; padding: 0 5px; }
      .header-box { padding: 0; }
       #weatherData p b { min-width: 110px; } /* Adjusted label width for mobile */
       #weatherData .evap-battery p b,
       #weatherData .soil-moisture p b { min-width: 85px; }
       #weatherData .rain-container p b { min-width: 90px; }
       .date-time p b { min-width: 40px;}
       /* NEW: Adjust emoji spacing slightly if needed */
       #weatherData p .emoji { margin-right: 4px; width: 1em; }

    }
     @media only screen and (max-width: 360px) {
         #weatherData p b { min-width: 100px; }
         #weatherData .evap-battery p b,
         #weatherData .soil-moisture p b { min-width: 75px; }
         #weatherData .rain-container p b { min-width: 80px; }
         .date-time p b { min-width: 35px;}
         .logo-container img { height: 50px; }
         .address-title { font-size: 16px; }
         .header-box h2 { font-size: 16px; }
          /* NEW: Adjust emoji spacing slightly if needed */
         #weatherData p .emoji { margin-right: 3px; }
     }
  </style>
</head>
<body>
  <div class="main-container">
    <!-- Sticky Header (Unchanged) -->
    <div class="freeze-pane">
      <div class="header-box">
        <h2>Moore's LIVE Weather Data</h2>
      </div>
      <div class="control-container">
        <div class="control-half">
          <button id="fetchBtn" onclick="manualFetch()">CURRENT READINGS</button>
        </div>
        <div class="control-half">
           <p id="status" aria-live="polite">
             <span id="statusBadge" class="status-badge waiting">‚è≥ Status: Waiting...</span>
           </p>
        </div>
      </div>
    </div>

    <!-- Weather Data Section - EMOJIS ADDED CAREFULLY -->
    <div id="weatherData">
      <!-- Header Section -->
      <div class="header-content">
        <div class="title-date-container">
          <div class="address-title">WEST WARWICK, QLD</div>
          <div class="date-time">
             <!-- Emojis added before <b> tags -->
            <p><span class="emoji">üìÜ</span><b>Date</b><span id="dateVal">--</span></p>
            <p><span class="emoji">‚è∞</span><b>Time</b><span id="timeVal">--</span></p>
          </div>
        </div>
        <div class="logo-container">
           <img src="/Weather_Station_App.png" alt="Weather Station Icon">
           <img src="/Station_Label.png" alt="Environdata Weather Maestro">
        </div>
      </div>
      <hr>

      <!-- Main Data Columns -->
      <div class="wind-logger-container">
        <div class="wind-column">
           <!-- Emojis added before <b> tags -->
           <p><span class="emoji">üí®</span><b>Wind Speed</b><span id="windSpeedVal">--</span> km/h</p>
           <p><span class="emoji">üß≠</span><b>Wind Dir.</b><span id="windDirDegVal">--</span>¬∞ (<span id="windDirTextVal">--</span>)</p>
           <p><span class="emoji">üí¶</span><b>Humidity</b><span id="humidityVal">--</span>% (<span id="humidityDescVal">--</span>)</p>
           <p><span class="emoji">üå°Ô∏è</span><b>Temperature</b>
            <span id="tempVal" style="font-weight:bold;">--</span>
            (<span id="tempDescVal">--</span>)
           </p>
           <p><span class="emoji">‚òÄÔ∏è</span><b>Solar Rad.</b><span id="solarRadVal">--</span></p>
           <p><span class="emoji">‚ö´</span><b>Black Globe</b><span id="blackGlobeTempVal">--</span>¬∞C</p>
           <p><span class="emoji">üå±</span><b>Garden Bed</b><span id="gardenBedTempVal">--</span>¬∞C</p>
           <p><span class="emoji">üåÄ</span><b>Pressure</b><span id="pressureVal">--</span></p>
           <div class="rain-container">
             <p><span class="emoji">üåßÔ∏è</span><b>Rain Since 9AM</b><span id="rainSince9Val">--</span></p>
             <p><span class="emoji">üíß</span><b>Rain / Last Min</b><span id="rainInLastMinVal">--</span></p>
           </div>
        </div>
        <div class="logger-column">
            <!-- Big temp boxes remain unchanged -->
          <div class="big-temp-box" id="airTempBox">
            <span id="bigTempVal">--¬∞C</span>
            <span class="label">Air Temp</span>
          </div>
          <div class="big-temp-box" id="radiantDiffBox">
            <span id="radiantDiffVal">--</span>
            <span class="label" aria-label="Difference between black globe and air temperature">Rad. Heat Diff</span>
          </div>
        </div>
      </div>
      <hr>
      <!-- Evaporation and Battery Section -->
      <div class="evap-battery">
        <div class="evap-col">
           <!-- Emojis added before <b> tags -->
           <p><span class="emoji">‚§¥Ô∏è</span><b>Evap/Hr</b><span id="evapRateVal">--</span> mm/h</p>
           <p><span class="emoji">‚¨ÜÔ∏è</span><b>Daily Evap</b><span id="dailyEvapVal">--</span> mm</p>
           <p><span class="emoji">üíß</span><b>Dew Point</b><span id="dewPointVal">--</span>¬∞C</p>
           <p><span class="emoji">üå¨Ô∏è</span><b>Max WS Gust</b><span id="peakWindGustVal">--</span></p>
        </div>
        <div class="battery-col">
           <!-- Emojis added before <b> tags -->
           <p><span class="emoji">üîã</span><b>Battery</b><span id="batteryVal">--</span></p>
           <p><span class="emoji">‚ö°</span><b>Load</b><span id="loadVal">--</span> mA</p>
           <p><span class="emoji">‚òÄÔ∏è</span><b>Solar Panel</b><span id="solarPanelVal">--</span></p>
           <p><span class="emoji">üîå</span><b>Charge</b><span id="chargeVal">--</span></p>
        </div>
      </div>
      <hr>
      <!-- Additional Data -->
       <!-- Emojis added before <b> tags -->
       <p><span class="emoji">üçÉ</span><b>Vector Wind Spd</b><span id="vectorWindSpeedVal">--</span> km/h</p>
       <p><span class="emoji">üß≠</span><b>Vector Wind Dir</b>
        <span id="vectorWindDirDegVal">--</span>¬∞ (<span id="vectorWindDirTextVal">--</span>)
       </p>
      <hr>
      <div class="soil-moisture">
        <div class="soiltemp-col">
           <!-- Emojis added before <b> tags -->
           <p><span class="emoji">üå°Ô∏è</span><b>S.Temp 10cm</b><span id="soilTemp10Val">--</span>¬∞C</p>
           <p><span class="emoji">üå°Ô∏è</span><b>S.Temp 20cm</b><span id="soilTemp20Val">--</span>¬∞C</p>
           <p><span class="emoji">üå°Ô∏è</span><b>S.Temp 30cm</b><span id="soilTemp30Val">--</span>¬∞C</p>
           <p><span class="emoji">üå°Ô∏è</span><b>S.Temp 40cm</b><span id="soilTemp40Val">--</span>¬∞C</p>
        </div>
        <div class="moisture-col">
           <!-- Emojis added before <b> tags -->
           <p><span class="emoji">üíß</span><b>Moist. 10cm</b><span id="moisture10Val">--</span>%</p>
           <p><span class="emoji">üíß</span><b>Moist. 20cm</b><span id="moisture20Val">--</span>%</p>
           <p><span class="emoji">üíß</span><b>Moist. 30cm</b><span id="moisture30Val">--</span>%</p>
           <p><span class="emoji">üíß</span><b>Moist. 40cm</b><span id="moisture40Val">--</span>%</p>
        </div>
      </div>
      <hr>
    </div>

    <!-- Spinner (Unchanged) -->
    <div id="spinnerContainer" class="spinner-container">
      <div class="spinner"></div>
    </div>
  </div>

  <script>
    // JAVASCRIPT FROM THE WORKING VERSION (UNCHANGED)
    // (Includes: Helper Functions, Global State, updateWeatherData, fetchWeather, scheduleNextFetch, manualFetch, load event listener)

    /********************
    * HELPER FUNCTIONS *
    ********************/
    function getWindDirection(degrees) {
      const directions = ["N", "NNE", "NE", "ENE", "E", "ESE", "SE", "SSE",
        "S", "SSW", "SW", "WSW", "W", "WNW", "NW", "NNW"];
      if (isNaN(degrees)) return '--';
      return directions[Math.round(degrees / 22.5) % 16];
    }

    function setStatusBadge(statusText, statusClass) {
      const icons = {
        connected: "‚úÖ",
        fetching: "üîÑ",
        error: "‚ö†Ô∏è",
        waiting: "‚è≥"
      };
      const icon = icons[statusClass] || "";
      const badge = document.getElementById("statusBadge");
      badge.textContent = `${icon} Status: ${statusText}`;
      // Robust class update
      badge.className = 'status-badge'; // Reset completely
      badge.classList.add(statusClass); // Add the specific class
    }

    function formatDateString(dateStr) {
      // Expects YYYY/MM/DD
      const parts = dateStr.split("/");
      if (parts.length === 3) {
        const [year, month, day] = parts.map(Number); // Convert to numbers
        // Basic validation
        if (!isNaN(year) && !isNaN(month) && !isNaN(day) && month >= 1 && month <= 12 && day >= 1 && day <= 31) {
            try {
                // More robust check using Date object
                const dateObj = new Date(year, month - 1, day);
                // Verify the date wasn't adjusted (e.g., Feb 30 becoming Mar 2)
                if (dateObj && dateObj.getFullYear() === year && dateObj.getMonth() === month - 1 && dateObj.getDate() === day) {
                    const formattedDay = String(day).padStart(2, '0');
                    const formattedMonth = String(month).padStart(2, '0');
                    const formattedDate = `${formattedDay}/${formattedMonth}/${year}`;
                    const dayNames = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
                    return `${formattedDate} (${dayNames[dateObj.getDay()]})`;
                }
            } catch (e) {
                console.warn("Error creating date object for:", dateStr, e);
            }
        }
      }
      console.warn("Could not parse date string:", dateStr);
      return dateStr || '--'; // Return original or default '--'
    }


    function getTemperatureColorAndDesc(temp) {
       let color, desc;
       if (isNaN(temp)) return { color: 'inherit', desc: '--' };
       if (temp < -20) { color = "#000000"; desc = ""; } // Black
        else if (temp < -10) { color = "#191970"; desc = "Severely cold"; } // MidnightBlue
        else if (temp < 0) { color = "#0000CD"; desc = "Extremely cold"; } // MediumBlue
        else if (temp < 6) { color = "#4682B4"; desc = "Very cold"; } // SteelBlue
        else if (temp < 11) { color = "#87CEEB"; desc = "Cold"; } // SkyBlue (lighter cold)
        else if (temp < 16) { color = "#90EE90"; desc = "Cool"; } // LightGreen
        else if (temp < 21) { color = "#32CD32"; desc = "Mild"; } // LimeGreen
        else if (temp < 28) { color = "#FFD700"; desc = "Warm"; } // Gold
        else if (temp < 32) { color = "#FFA500"; desc = "Warmer"; } // Orange
        else if (temp < 36) { color = "#FF6347"; desc = "Hot"; } // Tomato
        else if (temp < 41) { color = "#DC143C"; desc = "Very hot"; } // Crimson
        else if (temp <= 60) { color = "#B22222"; desc = "Extremely hot"; } // Firebrick
        else { color = "#8B0000"; desc = ""; } // DarkRed for extreme >60
       return { color, desc };
     }


    function getHumidityDesc(humidity) {
      if (isNaN(humidity)) return '--';
      if (humidity <= 20) { return "Very Dry"; }
      else if (humidity <= 40) { return "Dry"; }
      else if (humidity <= 60) { return "Comfortable"; }
      else if (humidity <= 80) { return "Humid"; }
      else { return "Very Humid"; }
    }

    function colorMoisture(val) {
        if (isNaN(val)) return '--';
        let display = val.toFixed(1);
        // Adjusted colors for visibility and meaning
        if (val < 20) { // Very dry
            display = `<span style="color:#CD853F; font-weight:bold;">${display}</span>`; // Peru (brownish orange)
        } else if (val > 85) { // Very wet
            display = `<span style="color:#1E90FF; font-weight:bold;">${display}</span>`; // DodgerBlue
        }
        // Add more ranges if needed (e.g., optimal range in green?)
        // else if (val >= 40 && val <= 60) { display = `<span style="color:green;">${display}</span>`; }
        return display;
    }


    // Helper to safely get numeric value
    function safeGetLineValue(lines, index, defaultValue = NaN) {
        if (index >= lines.length || typeof lines[index] === 'undefined' || lines[index] === null || lines[index].trim() === '') {
             return defaultValue;
        }
        const val = parseFloat(lines[index]);
        return isNaN(val) ? defaultValue : val;
    }
     // Helper to safely get string value
     function safeGetLineString(lines, index, defaultValue = '--') {
         if (index >= lines.length || typeof lines[index] === 'undefined' || lines[index] === null || lines[index].trim() === '') {
             return defaultValue;
         }
         // Added trim here
         const trimmedVal = lines[index].trim();
         // Return default if empty after trimming
         return trimmedVal === '' ? defaultValue : trimmedVal;
     }


    /*****************************
    * GLOBAL STATE & RETRIES *
    *****************************/
    let initialLoadComplete = false;
    let refreshTimeout;
    let retryAttempts = 0;
    const MAX_RETRY_ATTEMPTS = 3;
    const LONG_RETRY_DELAY = 30000;
    const WEATHER_ENDPOINT = "/weather";

    /*****************************
    * MAIN UPDATE FUNCTION *
    *****************************/
    function updateWeatherData(data) {
        const cleanedData = data.replace(/^r3\s*/, '').replace(/\r/g, '').trim();
        const lines = cleanedData.split(",");
        console.log(`Parsed ${lines.length} fields from CSV.`);
        const EXPECTED_FIELDS = 31;
        if (lines.length < EXPECTED_FIELDS) {
            console.error(`Incomplete data received. Expected >= ${EXPECTED_FIELDS}, got: ${lines.length}`, lines);
            setStatusBadge("Data Error", "error");
            return;
        }

        try {
            // Use safe helpers to extract
            const dateStr = safeGetLineString(lines, 0);
            const timeStr = safeGetLineString(lines, 1);
            const windSpeed = safeGetLineValue(lines, 2);
            const windDirDeg = safeGetLineValue(lines, 3);
            const humidityRaw = safeGetLineValue(lines, 4);
            const temperatureRaw = safeGetLineValue(lines, 5);
            let rainInLastMinRaw = safeGetLineValue(lines, 6, 0.0);
            const solarRadRaw = safeGetLineValue(lines, 7);
            const pressureRaw = safeGetLineValue(lines, 8);
            const gardenBedTemp = safeGetLineValue(lines, 9);
            const batteryVoltageVal = safeGetLineValue(lines, 10);
            const loadCurrent = safeGetLineValue(lines, 11);
            const rawSolarVoltage = safeGetLineValue(lines, 12);
            const chargeCurrent = safeGetLineValue(lines, 13);
            const peakWindGustVal = safeGetLineValue(lines, 14);
            const vectorWindSpeedVal = safeGetLineValue(lines, 15);
            const vectorWindDirVal = safeGetLineValue(lines, 16);
            const rainSince9 = safeGetLineValue(lines, 17);
            const evapRate = safeGetLineValue(lines, 18);
            const dailyEvap = safeGetLineValue(lines, 20);
            const dewPoint = safeGetLineValue(lines, 21);
            const soilTemp10 = safeGetLineValue(lines, 22);
            const soilTemp20 = safeGetLineValue(lines, 23);
            const soilTemp30 = safeGetLineValue(lines, 24);
            const soilTemp40 = safeGetLineValue(lines, 25);
            const moisture10Val = safeGetLineValue(lines, 26);
            const moisture20Val = safeGetLineValue(lines, 27);
            const moisture30Val = safeGetLineValue(lines, 28);
            const moisture40Val = safeGetLineValue(lines, 29);
            const blackGlobeTemp = safeGetLineValue(lines, 30);

            // *** UPDATE DOM ELEMENTS ***
            const updateElementText = (id, value) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = (value === null || (typeof value === 'number' && isNaN(value))) ? '--' : value;
                }
            };
             const updateElementHTML = (id, value) => {
                const element = document.getElementById(id);
                if (element) {
                    element.innerHTML = (value === null || value === undefined) ? '--' : value;
                }
            };

            // DATE & TIME
            updateElementText("dateVal", formatDateString(dateStr));
            updateElementText("timeVal", timeStr !== '--' ? timeStr + " AEST" : '--');

            // WIND
            updateElementText("windSpeedVal", isNaN(windSpeed) ? '--' : windSpeed.toFixed(1));
            updateElementText("windDirDegVal", isNaN(windDirDeg) ? '--' : windDirDeg.toFixed(1));
            updateElementText("windDirTextVal", getWindDirection(windDirDeg));

            // HUMIDITY
            updateElementText("humidityVal", isNaN(humidityRaw) ? '--' : humidityRaw.toFixed(1));
            updateElementText("humidityDescVal", getHumidityDesc(humidityRaw));

            // TEMPERATURE
            const tempSpan = document.getElementById("tempVal");
            const tempDescSpan = document.getElementById("tempDescVal");
            const bigTempElement = document.getElementById("bigTempVal");
            const bigTempContainer = document.getElementById("airTempBox");

            if (!isNaN(temperatureRaw)) {
                const tempData = getTemperatureColorAndDesc(temperatureRaw);
                tempSpan.textContent = temperatureRaw.toFixed(1) + "¬∞C";
                tempSpan.style.color = tempData.color;
                tempDescSpan.textContent = tempData.desc;

                bigTempElement.textContent = temperatureRaw.toFixed(1) + "¬∞C";
                bigTempContainer.style.backgroundColor = tempData.color;
                bigTempElement.style.color = "#FFF";

                bigTempContainer.classList.add('updated');
                setTimeout(() => bigTempContainer.classList.remove('updated'), 300);
            } else {
                tempSpan.textContent = '--¬∞C';
                tempSpan.style.color = 'inherit';
                tempDescSpan.textContent = '--';
                bigTempElement.textContent = '--¬∞C';
                bigTempContainer.style.backgroundColor = 'grey';
            }

             // RAIN SINCE 9AM
             let rainSince9Display = !isNaN(rainSince9) ? rainSince9.toFixed(1) + " mm" : '-- mm';
             if (!isNaN(rainSince9) && rainSince9 >= 0.2) {
                 rainSince9Display = `<span style="color:#1E90FF; font-weight:bold;">${rainSince9Display}</span>`;
             }
             updateElementHTML("rainSince9Val", rainSince9Display);

             // RAIN IN LAST MINUTE
             let rainInLastMinDisplay = rainInLastMinRaw.toFixed(1) + " mm"; // Defaulted to 0 if NaN
             if (rainInLastMinRaw >= 0.2) {
                 rainInLastMinDisplay = `<span style="color:#1E90FF; font-weight:bold;">${rainInLastMinDisplay}</span>`;
             }
             updateElementHTML("rainInLastMinVal", rainInLastMinDisplay);


             // SOLAR RADIATION
            const solarRad = !isNaN(solarRadRaw) ? Math.max(0, solarRadRaw) : NaN;
            let solarRadDisplay = '-- W/m¬≤';
            let solarEmoji = ''; // Store emoji separately
            if (!isNaN(solarRad)) {
                let solarRadColor = solarRad < 5 ? "#4B0082" : // Indigo for night/low
                    solarRad <= 100 ? "#6495ED" : // CornflowerBlue for low light
                    solarRad <= 299 ? "#87CEEB" : // SkyBlue for moderate
                    solarRad <= 600 ? "#FFD700" : // Gold for sunny
                    solarRad <= 800 ? "#FFA500" : // Orange for very sunny
                    solarRad <= 1100 ? "#FF6347" : // Tomato for intense
                    "#DC143C"; // Crimson for extreme
                solarRadDisplay = solarRad.toFixed(1) + " W/m¬≤";
                solarEmoji = solarRad < 5 ? 'üåô' : '‚òÄÔ∏è'; // Select emoji based on value
                solarRadDisplay = `<span style="font-weight:${solarRad >= 5 ? 'bold' : 'normal'}; color:${solarRadColor};">${solarRadDisplay}</span>`;
            }
             // Update both the value span and the emoji span (if you add one specifically for it, otherwise the logic below handles the combined update)
             updateElementHTML("solarRadVal", solarRadDisplay + ' ' + solarEmoji); // Add emoji after value span


            // BLACK GLOBE & RADIANT HEAT DIFF
            const globeElemVal = document.getElementById("blackGlobeTempVal"); // The span for the value
            const radiantDiffElem = document.getElementById("radiantDiffVal");
            const radiantDiffBox = document.getElementById("radiantDiffBox");

            if (!isNaN(blackGlobeTemp)) {
                 const globeTempData = getTemperatureColorAndDesc(blackGlobeTemp);
                 globeElemVal.textContent = blackGlobeTemp.toFixed(1);
                 globeElemVal.style.color = globeTempData.color; // Style the number span

                if (!isNaN(temperatureRaw)) {
                    const radiantDiff = blackGlobeTemp - temperatureRaw;
                    const diffFormatted = (radiantDiff >= 0 ? "+" : "") + radiantDiff.toFixed(1) + "¬∞C";
                    radiantDiffElem.textContent = diffFormatted;
                    radiantDiffBox.style.backgroundColor = radiantDiff >= 0 ? "#d94a38" : "#4682B4"; // Reddish / Blueish
                    radiantDiffElem.style.color = "white";
                } else {
                    radiantDiffElem.textContent = '--¬∞C';
                    radiantDiffBox.style.backgroundColor = 'grey';
                }
            } else {
                 globeElemVal.textContent = '--';
                 globeElemVal.style.color = 'inherit';
                 radiantDiffElem.textContent = '--¬∞C';
                 radiantDiffBox.style.backgroundColor = 'grey';
            }

             // GARDEN BED TEMP
             updateElementText("gardenBedTempVal", isNaN(gardenBedTemp) ? '--' : gardenBedTemp.toFixed(1));


             // PRESSURE (with offset)
             let pressureDisplay = '-- hPa';
             if (!isNaN(pressureRaw)) {
                 let adjustedPressure = pressureRaw - 1.9;
                 pressureDisplay = adjustedPressure.toFixed(1) + " hPa";
                 if (adjustedPressure >= 1021.5) {
                     pressureDisplay = `<span style="color:green; font-weight:bold;">${pressureDisplay} üëç</span>`;
                 } else if (adjustedPressure < 1005) {
                     pressureDisplay = `<span style="color:#4682B4; font-weight:bold;">${pressureDisplay}</span>`; // Low pressure indicator
                 }
             }
             updateElementHTML("pressureVal", pressureDisplay);

            // BATTERY
            let batteryVoltageDisplay = '-- V';
            if (!isNaN(batteryVoltageVal)) {
                const batteryVoltage = batteryVoltageVal.toFixed(1);
                let batteryStyle = "color:";
                if (batteryVoltageVal < 12.4) { // Threshold for red warning
                    batteryStyle += "red; font-weight:bold;";
                } else if (batteryVoltageVal >= 13.9) { // Threshold for bold green (full)
                     batteryStyle += "green; font-weight:bold;";
                } else { // Normal range
                    batteryStyle += "green;";
                }
                batteryVoltageDisplay = `<span style="${batteryStyle}">${batteryVoltage} V</span>`;
            }
            updateElementHTML("batteryVal", batteryVoltageDisplay);


             // LOAD
             updateElementText("loadVal", isNaN(loadCurrent) ? '--' : loadCurrent.toFixed(1));

             // SOLAR PANEL
            let solarPanelDisplay = '-- V';
            let solarPanelEmoji = '';
            if (!isNaN(rawSolarVoltage) && !isNaN(batteryVoltageVal)) {
                const effectiveSolarVoltage = (rawSolarVoltage < batteryVoltageVal || rawSolarVoltage < 1.0 ) ? 0.0 : rawSolarVoltage;
                solarPanelDisplay = effectiveSolarVoltage.toFixed(1) + " V";
                solarPanelEmoji = effectiveSolarVoltage <= 0.1 ? 'üåô' : '‚òÄÔ∏è';
            }
             // Update the span - assuming the emoji is directly in HTML now
            updateElementHTML("solarPanelVal", solarPanelDisplay + ' ' + solarPanelEmoji); // Combine value and emoji


             // CHARGE
             let chargeDisplay = '-- mA';
             if (!isNaN(chargeCurrent) && !isNaN(loadCurrent) && !isNaN(batteryVoltageVal)) {
                 chargeDisplay = chargeCurrent.toFixed(1) + " mA";
                 let chargeStyle = "";
                 if (batteryVoltageVal < 13.9) {
                     chargeStyle = chargeCurrent > loadCurrent ? "color:green; font-weight:bold;" : "color:red;"; // Bold green if charging > load
                 } else if (chargeCurrent > 0.1) { // Use a small threshold for trickle charge indication
                     chargeStyle = "color:green;"; // Green if still charging when full
                 }
                 chargeDisplay = `<span style="${chargeStyle}">${chargeDisplay}</span>`;
             }
             updateElementHTML("chargeVal", chargeDisplay);

             // PEAK WIND GUST
            let peakWindGustDisplay = '-- km/h';
            if (!isNaN(peakWindGustVal)) {
                peakWindGustDisplay = peakWindGustVal.toFixed(1) + " km/h";
                if (peakWindGustVal > 30) { // Higher threshold for red
                    peakWindGustDisplay = `<span style="color:red; font-weight:bold;">${peakWindGustDisplay}</span>`;
                } else if (peakWindGustVal > 15) { // Higher threshold for orange
                    peakWindGustDisplay = `<span style="color:#FF8C00; font-weight:bold;">${peakWindGustDisplay}</span>`;
                }
            }
            updateElementHTML("peakWindGustVal", peakWindGustDisplay);

            // VECTOR WIND
            updateElementText("vectorWindSpeedVal", isNaN(vectorWindSpeedVal) ? '--' : vectorWindSpeedVal.toFixed(1));
            updateElementText("vectorWindDirDegVal", isNaN(vectorWindDirVal) ? '--' : vectorWindDirVal.toFixed(1));
            updateElementText("vectorWindDirTextVal", getWindDirection(vectorWindDirVal));

            // EVAP & DEW POINT
            updateElementText("evapRateVal", isNaN(evapRate) ? '--' : evapRate.toFixed(3));
            updateElementText("dailyEvapVal", isNaN(dailyEvap) ? '--' : dailyEvap.toFixed(3));
            updateElementText("dewPointVal", isNaN(dewPoint) ? '--' : dewPoint.toFixed(1));

            // SOIL TEMPS
            updateElementText("soilTemp10Val", isNaN(soilTemp10) ? '--' : soilTemp10.toFixed(1));
            updateElementText("soilTemp20Val", isNaN(soilTemp20) ? '--' : soilTemp20.toFixed(1));
            updateElementText("soilTemp30Val", isNaN(soilTemp30) ? '--' : soilTemp30.toFixed(1));
            updateElementText("soilTemp40Val", isNaN(soilTemp40) ? '--' : soilTemp40.toFixed(1));

            // SOIL MOISTURE
            updateElementHTML("moisture10Val", colorMoisture(moisture10Val));
            updateElementHTML("moisture20Val", colorMoisture(moisture20Val));
            updateElementHTML("moisture30Val", colorMoisture(moisture30Val));
            updateElementHTML("moisture40Val", colorMoisture(moisture40Val));

        } catch (error) {
            console.error("Error processing weather data:", error);
            setStatusBadge("Processing Error", "error");
        }
    }


    /*****************************
     * FETCH & AUTO-REFRESH LOGIC *
     *****************************/
    function fetchWeather() {
        const spinnerContainer = document.getElementById("spinnerContainer");
        const fetchBtn = document.getElementById("fetchBtn");
        const currentStatus = document.getElementById("statusBadge").classList;

        // Show spinner only if not connected/retrying or on first load
        if (!initialLoadComplete || currentStatus.contains('error') || currentStatus.contains('waiting') || currentStatus.contains('fetching')) {
             spinnerContainer.style.display = "block";
        }
        setStatusBadge("Fetching", "fetching");
        fetchBtn.disabled = true;

        fetch(WEATHER_ENDPOINT)
            .then(response => {
                if (!response.ok) { throw new Error(`Server responded ${response.status}`); }
                return response.text();
            })
            .then(data => {
                if (!data || data.trim() === "" || !data.includes(',')) { throw new Error("Received empty or invalid data"); }
                updateWeatherData(data);
                setStatusBadge("Connected", "connected");
                retryAttempts = 0;
                if (!initialLoadComplete) { initialLoadComplete = true; }
                scheduleNextFetch(); // Schedule next *after* success
            })
            .catch(error => {
                console.error("Fetch error:", error.message);
                retryAttempts++;
                initialLoadComplete = true; // Mark load attempted

                if (retryAttempts <= MAX_RETRY_ATTEMPTS) {
                    setStatusBadge(`Retrying (${retryAttempts}/${MAX_RETRY_ATTEMPTS})`, "fetching");
                    const retryDelay = retryAttempts * 1000; // 1s, 2s, 3s
                    console.log(`Retrying fetch in ${retryDelay}ms...`);
                    refreshTimeout = setTimeout(fetchWeather, retryDelay);
                } else {
                    setStatusBadge("Error", "error");
                    console.log(`Max retries reached. Retrying in ${LONG_RETRY_DELAY / 1000}s...`);
                    refreshTimeout = setTimeout(fetchWeather, LONG_RETRY_DELAY);
                }
            })
            .finally(() => {
                // Hide spinner unless actively fetching/retrying
                if (!document.getElementById("statusBadge").classList.contains('fetching')) {
                     spinnerContainer.style.display = "none";
                }
                fetchBtn.disabled = false;
            });
    }

    function scheduleNextFetch() {
        if (refreshTimeout) { clearTimeout(refreshTimeout); }
        const now = new Date();
        const seconds = now.getSeconds();
        const milliseconds = now.getMilliseconds();
        const targetSecond = 20; // Target second past the minute
        let delay = seconds < targetSecond
            ? (targetSecond - seconds) * 1000 - milliseconds
            : ((60 - seconds) + targetSecond) * 1000 - milliseconds;
        delay = Math.max(delay, 1000); // Minimum 1s delay
        console.log(`Next auto fetch scheduled in ${Math.round(delay / 1000)}s`);
        refreshTimeout = setTimeout(fetchWeather, delay);
    }

    function manualFetch() {
        console.log("Manual fetch requested.");
        if (refreshTimeout) { clearTimeout(refreshTimeout); }
        retryAttempts = 0;
        fetchWeather();
    }

    // Initial state setup
    window.addEventListener("load", () => {
         setStatusBadge("Waiting", "waiting");
         console.log("Page loaded, initiating first fetch...");
         fetchWeather();
    });

  </script>

</body>
</html>