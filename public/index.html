<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="apple-touch-icon" href="/Weather_Station_App.png">
  <!-- Consolidated Font Link -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Moore's LIVE Weather Data</title>
  <style>
    /* Base Styles */
    body {
      margin: 0;
      background-color: #f4f4f4;
      font-family: "Inter", "system-ui", "Segoe UI", "Helvetica Neue", Arial, sans-serif;
      font-size: 13.5px;
      font-weight: 400;
      line-height: 1.35;
      letter-spacing: 0.15px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
      padding-top: env(safe-area-inset-top, 0);
      padding-left: env(safe-area-inset-left, 0);
      padding-right: env(safe-area-inset-right, 0);
      padding-bottom: env(safe-area-inset-bottom, 0);
    }

    .main-container {
      max-width: 400px;
      margin: 5px auto; /* Reduced top/bottom margin */
      padding: 0 5px;
    }

    /* Pulse animation for updated temp box */
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    .big-temp-box.updated {
      animation: pulse 0.3s ease-in-out;
    }

    .freeze-pane {
      position: sticky;
      top: env(safe-area-inset-top, 0);
      z-index: 100;
      background: #f4f4f4;
      padding: 0;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08); /* Slightly softer shadow */
      /* Removed margin-bottom to tighten space */
      margin-bottom: 0;
    }

    .header-box {
      background-color: #00008B;
      border-radius: 10px;
      padding: 5px;
      text-align: center;
      /* Added slight margin-bottom for separation from controls */
      margin-bottom: 3px;
    }

    .header-box h2 {
      margin: 0;
      font-size: 18px;
      font-weight: bold;
      color: white;
      padding: 4px 0;
      white-space: nowrap;
    }

    .control-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 2px;
      /* Removed margin-top/bottom, rely on header/data spacing */
      margin: 0;
      /* Add margin-bottom to create space before data */
      margin-bottom: 5px;
    }

    .control-half {
      width: 50%;
      text-align: center;
      white-space: nowrap;
    }

    button {
      padding: 6px 12px;
      font-size: 14px;
      font-weight: 600;
      font-family: "Inter", "system-ui", "Segoe UI", "Helvetica Neue", Arial, sans-serif;
      background-color: #FFA500;
      color: black;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.3s ease, transform 0.1s ease, box-shadow 0.2s ease;
      display: inline-block;
      margin: 2px 0;
      white-space: nowrap;
      line-height: 1.2;
      letter-spacing: 0.3px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.15);
      -webkit-tap-highlight-color: transparent;
    }

    button:hover {
      background-color: #e59400;
      transform: scale(1.02);
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    button:active {
        transform: scale(0.98);
        box-shadow: inset 0 1px 2px rgba(0,0,0,0.2);
    }

    button:disabled {
      background-color: #cccccc;
      color: #666666;
      cursor: not-allowed;
      opacity: 0.7;
      box-shadow: none;
      transform: none;
    }

    #status {
      white-space: nowrap;
      padding: 0;
      text-align: center;
    }

    .status-badge {
      display: inline-block;
      padding: 6px 12px;
      font-size: 14px;
      font-weight: bold;
      border-radius: 10px;
      background-color: white;
      color: #808080;
      border: 2px solid #808080;
      line-height: 1;
      transition: all 0.3s ease;
      vertical-align: middle;
    }

    .status-badge.connected {
      background-color: #006400;
      color: white;
      border-color: #006400;
    }

    .status-badge.fetching {
      color: #DAA520;
      border-color: #DAA520;
      background-color: white;
    }

    .status-badge.error {
      color: #B22222;
      border-color: #B22222;
      background-color: white;
    }

    /* REMOVED Spinner Styles */

    /* Weather Data Container */
    #weatherData {
      background: #ffffff;
      /* Reduced top padding */
      padding: 5px 10px 12px 10px;
      border-radius: 12px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
      font-size: 13.5px;
      color: #222;
      text-align: left;
      margin-bottom: 10px; /* Slightly reduced bottom margin */
      overflow-x: hidden;
      /* Structure is always visible, no display: none */
    }

    #weatherData p {
      margin: 3px 0;
      line-height: 1.3;
      white-space: nowrap;
    }

    hr {
      border: none;
      border-top: 1px solid #e0e0e0;
      margin: 6px 0;
      clear: both;
      width: 100%;
    }

    /* --- Header Layout --- */
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 5px 0;
      white-space: nowrap;
      gap: 10px;
    }

    .title-date-container {
      display: flex;
      flex-direction: column;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .address-title {
      font-size: 18px;
      font-weight: bold;
      margin: 0 0 2px 0;
      color: #00008B;
      white-space: nowrap;
    }

    .date-time {
      margin: 0;
      white-space: nowrap;
    }

    .date-time p {
      margin: 1px 0;
      line-height: 1.3;
      white-space: nowrap;
    }

    .logo-container {
      display: flex;
      gap: 5px;
      margin: 0;
      padding: 0;
      align-items: center;
      flex-shrink: 0;
    }

    .logo-container img {
      height: 60px;
      width: auto;
      margin: 0;
      display: block;
      border-radius: 8px;
      object-fit: contain;
    }

    /* --- Main Data Layout --- */
    .wind-logger-container {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      margin: 5px 0;
      white-space: nowrap;
    }

    .wind-column {
      width: calc(60% - 5px);
      white-space: nowrap;
    }

    .logger-column {
      width: calc(40% - 5px);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      white-space: nowrap;
    }

    .big-temp-box {
      width: 100px;
      height: 40px;
      padding: 4px 6px;
      border-radius: 10px;
      background: linear-gradient(to bottom, rgba(255,255,255,0.1), rgba(0,0,0,0.15));
      box-shadow:
        inset 0 0 4px rgba(0, 0, 0, 0.25),
        0 2px 6px rgba(0, 0, 0, 0.2);
      font-size: 16px;
      /* Using Inter as primary font */
      font-family: "Inter", "system-ui", "Segoe UI", "Helvetica Neue", Arial, sans-serif;
      font-weight: bold;
      text-align: center;
      color: #FFF;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      word-wrap: break-word;
      line-height: 1;
      letter-spacing: 0.2px;
      border: 1px solid rgba(255,255,255,0.4);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      transition: background-color 0.3s ease;
    }

    .big-temp-box span.label {
      font-size: 11px;
      font-weight: 600;
      color: white;
      margin-top: 2px;
      line-height: 1.1;
      letter-spacing: 0.2px;
    }

    .big-temp-box + .big-temp-box {
      margin-top: 8px;
    }

    .rain-container {
      margin-top: 7px;
      margin-bottom: 3px;
      padding: 4px 6px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      background: #f9f9f9;
      white-space: nowrap;
    }
     .rain-container p {
         margin: 2px 0;
     }

    .evap-battery {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      margin: 5px 0;
      white-space: nowrap;
    }

    .evap-col {
      width: calc(52% - 5px);
      white-space: nowrap;
    }

    .battery-col {
      width: calc(48% - 5px);
      white-space: nowrap;
    }

    .soil-moisture {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      margin: 5px 0;
      white-space: nowrap;
    }

    .soiltemp-col, .moisture-col {
      width: calc(50% - 5px);
      white-space: nowrap;
    }

    /* Highlight specific data points */
    .highlight-bold { font-weight: bold; }
    .highlight-red { color: #B22222; font-weight: bold; }
    .highlight-orange { color: #FF8C00; font-weight: bold; }
    .highlight-blue { color: #1E90FF; font-weight: bold; }
    .highlight-green { color: #006400; font-weight: bold; }
    .highlight-darkblue { color: #00008B; font-weight: bold; }
    .highlight-lowsolar { color: #27408B; }
    .highlight-warmsolar { color: #DAA520; font-weight: bold; }
    .highlight-hotsolar { color: #BF360C; font-weight: bold; }
    .highlight-vryhotsolar { color: #B71C1C; font-weight: bold; }


    /* Media Queries for Mobile Devices */
    @media only screen and (max-width: 360px) {
        body { font-size: 13px; }
        .header-box h2 { font-size: 16px; }
        button { font-size: 13px; padding: 5px 10px; }
        .status-badge { font-size: 13px; padding: 5px 10px; }
        .address-title { font-size: 16px; }
        .logo-container img { height: 50px; }
        #weatherData p { margin: 2px 0; }
        .big-temp-box { width: 90px; height: 36px; font-size: 14px; }
        .big-temp-box span.label { font-size: 10px; }
    }

    @media only screen and (max-width: 600px) {
      .main-container {
        max-width: 100%;
        margin: 5px auto;
        padding: 0 5px;
      }
      .header-box { padding: 5px; }
    }
  </style>
</head>
<body>
  <div class="main-container">
    <!-- Sticky Header -->
    <div class="freeze-pane">
      <div class="header-box">
        <h2>Moore's LIVE Weather Data</h2>
      </div>
      <div class="control-container">
        <div class="control-half">
          <button id="fetchBtn" onclick="manualFetch()">CURRENT READINGS</button>
        </div>
        <div class="control-half">
          <p id="status" aria-live="polite">
            <span id="statusBadge" class="status-badge">Status: Waiting...</span>
          </p>
        </div>
      </div>
    </div>

    <!-- Spinner Removed -->

    <!-- Weather Data Section (Always visible structure) -->
    <div id="weatherData">
      <!-- Header Section -->
      <div class="header-content">
        <div class="title-date-container">
          <div class="address-title">WEST WARWICK, QLD</div>
          <div class="date-time">
            <p><b>üìÜ Date:</b> <span id="dateVal">--</span></p>
            <p><b>‚è∞ Time:</b> <span id="timeVal">--</span></p>
          </div>
        </div>
        <div class="logo-container">
          <img src="/Weather_Station_App.png" alt="Weather Station Icon">
          <img src="/Station_Label.png" alt="Environdata Weather Maestro">
        </div>
      </div>
      <hr>

      <!-- Main Data Columns -->
      <div class="wind-logger-container">
        <div class="wind-column">
          <p><b>üí® Wind Speed:</b> <span id="windSpeedVal">--</span> km/h</p>
          <p><b>üß≠ Wind Direction:</b> <span id="windDirDegVal">--</span>¬∞ (<span id="windDirTextVal">--</span>)</p>
          <p><b>üí¶ Humidity:</b> <span id="humidityVal">--</span>% (<span id="humidityDescVal">--</span>)</p>
          <p>
            <b>üå°Ô∏è Temperature:</b>
            <span id="tempVal" class="highlight-bold">--</span>
            (<span id="tempDescVal">--</span>)
          </p>
          <p><b>‚òÄÔ∏è Solar Radiation:</b> <span id="solarRadVal">--</span></p>
          <p><b>üîò Black Globe Temp:</b> <span id="blackGlobeTempVal">--</span>¬∞C</p>
          <p><b>üå± Garden Bed Temp:</b> <span id="gardenBedTempVal">--</span>¬∞C</p>
          <p><b>üåÄ Pressure:</b> <span id="pressureVal">--</span></p>
          <div class="rain-container">
            <p><b>üåßÔ∏è Rain Since 9AM:</b> <span id="rainSince9Val">--</span></p>
            <p><b>üåßÔ∏è Rain In Last Min:</b> <span id="rainInLastMinVal">--</span></p>
          </div>
        </div>
        <div class="logger-column">
          <div class="big-temp-box" id="airTempBox">
            <span id="bigTempVal">--¬∞C</span>
            <span class="label">Air Temp</span>
          </div>
          <div class="big-temp-box" id="radiantDiffBox">
            <span id="radiantDiffVal">--¬∞C</span>
            <span class="label" aria-label="Difference between Black Globe and Air temperature">Radiant Heat Diff</span>
          </div>
          <div class="big-temp-box" id="dewDiffBox">
            <span id="dewDiffVal">--¬∞C</span>
            <span class="label" aria-label="Temperature difference above Dew Point">Temp Above Dew Pt.</span>
          </div>
        </div>
      </div>
      <hr>
      <!-- Evaporation and Battery Section -->
      <div class="evap-battery">
        <div class="evap-col">
          <p><b>‚§¥Ô∏è Evap/Hr:</b> <span id="evapRateVal">--</span> mm/h</p>
          <p><b>‚¨ÜÔ∏è Daily Evap:</b> <span id="dailyEvapVal">--</span> mm</p>
          <p><b>üíß Dew Point:</b> <span id="dewPointVal">--</span>¬∞C</p>
          <p><b>üå¨Ô∏è Max WS Gust:</b> <span id="peakWindGustVal">--</span></p>
        </div>
        <div class="battery-col">
          <p><b>üîã Battery:</b> <span id="batteryVal">--</span></p>
          <p><b>‚ö° Load:</b> <span id="loadVal">--</span> mA</p>
          <p><b>‚òÄÔ∏è Solar Panel:</b> <span id="solarPanelVal">--</span></p>
          <p><b>üîå Charge:</b> <span id="chargeVal">--</span></p>
        </div>
      </div>
      <hr>
      <!-- Additional Data -->
      <p><b>üçÉ Vector Wind Speed:</b> <span id="vectorWindSpeedVal">--</span> km/h</p>
      <p>
        <b>üß≠ Vector Wind Direction:</b>
        <span id="vectorWindDirDegVal">--</span>¬∞ (<span id="vectorWindDirTextVal">--</span>)
      </p>
      <hr>
      <div class="soil-moisture">
        <div class="soiltemp-col">
          <p><b>üå°Ô∏è S. Temp 10cm:</b> <span id="soilTemp10Val">--</span>¬∞C</p>
          <p><b>üå°Ô∏è S. Temp 20cm:</b> <span id="soilTemp20Val">--</span>¬∞C</p>
          <p><b>üå°Ô∏è S. Temp 30cm:</b> <span id="soilTemp30Val">--</span>¬∞C</p>
          <p><b>üå°Ô∏è S. Temp 40cm:</b> <span id="soilTemp40Val">--</span>¬∞C</p>
        </div>
        <div class="moisture-col">
          <p><b>üíß Moist. 10cm:</b> <span id="moisture10Val">--</span>%</p>
          <p><b>üíß Moist. 20cm:</b> <span id="moisture20Val">--</span>%</p>
          <p><b>üíß Moist. 30cm:</b> <span id="moisture30Val">--</span>%</p>
          <p><b>üíß Moist. 40cm:</b> <span id="moisture40Val">--</span>%</p>
        </div>
      </div>
      <hr>
      <!-- Footer/Timestamp -->
      <p style="text-align: center; font-size: 11px; color: #666; margin-top: 10px;">
        Last updated: <span id="lastUpdatedTimestamp">--</span>
      </p>
    </div>

  </div>

  <script>
    /********************
    * HELPER FUNCTIONS *
    ********************/
    function getWindDirection(degrees) {
      const normalizedDegrees = ((degrees % 360) + 360) % 360;
      const directions = ["N", "NNE", "NE", "ENE", "E", "ESE", "SE", "SSE",
        "S", "SSW", "SW", "WSW", "W", "WNW", "NW", "NNW"];
      return directions[Math.round(normalizedDegrees / 22.5) % 16];
    }

    function setStatusBadge(statusText, statusClass) {
      const icons = {
        connected: "‚úÖ", fetching: "üîÑ", error: "‚ö†Ô∏è", waiting: "‚è≥"
      };
      const icon = icons[statusClass] || "";
      const badge = document.getElementById("statusBadge");
      badge.textContent = `${icon} Status: ${statusText}`;
      badge.className = `status-badge ${statusClass}`;
    }

    function formatDateString(dateStr) {
      const parts = dateStr.split("/"); // YYYY/MM/DD
      if (parts.length === 3) {
        const [year, month, day] = parts;
        if (!isNaN(year) && !isNaN(month) && !isNaN(day)) {
            const formattedDate = `${day.padStart(2, '0')}/${month.padStart(2, '0')}/${year}`;
            const dateObj = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
            if (!isNaN(dateObj.getTime())) {
                const dayNames = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
                return `${formattedDate} (${dayNames[dateObj.getDay()]})`;
            }
        }
      }
      console.warn("Could not parse date string:", dateStr);
      return dateStr;
    }

    function getTemperatureColorAndDesc(temp) {
      let color, desc;
      const thresholds = [
          { limit: -20, color: "#000000", desc: "" }, { limit: -10, color: "#191970", desc: "Severely cold" },
          { limit: 0,   color: "#00008B", desc: "Extremely cold" }, { limit: 6,   color: "#104E8B", desc: "Very cold" },
          { limit: 11,  color: "#4682B4", desc: "Cold" }, { limit: 16,  color: "#32CD32", desc: "Cool" },
          { limit: 21,  color: "#228B22", desc: "Mild" }, { limit: 28,  color: "#DAA520", desc: "Warm" },
          { limit: 32,  color: "#FF8C00", desc: "Warmer" }, { limit: 36,  color: "#FF4500", desc: "Hot" },
          { limit: 41,  color: "#B22222", desc: "Very hot" }, { limit: 61,  color: "#8B0000", desc: "Extremely hot" },
          { limit: Infinity, color: "#000000", desc: "" }
      ];
      for (let i = 0; i < thresholds.length; i++) {
          if (temp < thresholds[i].limit) {
              ({ color, desc } = thresholds[i]);
              break;
          }
      }
      return { color: color || "#000000", desc: desc || "" };
    }

    function getHumidityDesc(humidity) {
      if (humidity <= 20) { return "Very Dry"; }
      else if (humidity <= 40) { return "Dry"; }
      else if (humidity <= 60) { return "Comfortable"; }
      else if (humidity <= 80) { return "Humid"; }
      else { return "Very Humid"; }
    }

    function colorMoisture(val) {
        const numVal = parseFloat(val);
        if (isNaN(numVal)) return '--';
        let display = numVal.toFixed(1);
        if (numVal < 20) { display = `<span class="highlight-orange">${display}</span>`; }
        else if (numVal > 60) { display = `<span class="highlight-blue">${display}</span>`; }
        return display;
    }

    function updateText(id, value) {
        const element = document.getElementById(id);
        if (element && element.textContent !== value) {
            element.textContent = value; return true;
        }
        if (!element) console.warn(`Element with ID ${id} not found.`);
        return false;
    }

    function updateHTML(id, value) {
        const element = document.getElementById(id);
        if (element && element.innerHTML !== value) {
            element.innerHTML = value; return true;
        }
         if (!element) console.warn(`Element with ID ${id} not found.`);
        return false;
    }

    /*****************************
    * GLOBAL STATE & CONSTANTS *
    *****************************/
    let initialLoadComplete = false;
    let refreshTimeout;
    let retryAttempts = 0;
    const MAX_RETRY_ATTEMPTS = 3;
    const WEATHER_ENDPOINT = "/weather";
    const RETRY_DELAY_SHORT = 500;
    const RETRY_DELAY_LONG = 1000;
    const MAX_BACKOFF_DELAY = 30000;
    const SCHEDULE_TARGET_SECOND = 20;
    const MIN_EXPECTED_FIELDS = 31; // Keep consistent with parsing logic

    /*****************************
    * MAIN UPDATE FUNCTION *
    *****************************/
    function updateWeatherData(data) {
      console.log("Raw data received length:", data.length);
      const cleanedData = data.replace(/^r\d+\r?\n?/, "").trim();
      const lines = cleanedData.split(",");
      // console.log("Parsed lines array:", lines); // Less verbose logging

      if (lines.length < MIN_EXPECTED_FIELDS) {
        console.error(`Incomplete data. Expected ${MIN_EXPECTED_FIELDS}, got ${lines.length}:`, lines.slice(0, 5).join(',')); // Log start of bad data
        setStatusBadge("Data Error", "error");
        // No longer clearing the display here if initial load was complete
        if (!initialLoadComplete) {
             // Optionally show a minimal error message only on first fail
             // document.getElementById("weatherData").innerHTML = `<p style="color: red; text-align: center; padding: 20px;"><b>Error:</b> Incomplete data from station.</p>`;
        }
        return false;
      }

      try {
        // Extract data (indices assumed correct based on previous code)
        const dateStr = lines[0], timeStr = lines[1];
        const windSpeed = parseFloat(lines[2]), windDirDeg = parseFloat(lines[3]);
        const humidityRaw = parseFloat(lines[4]), temperatureRaw = parseFloat(lines[5]);
        let rainInLastMinRaw = parseFloat(lines[6]);
        const solarRadRaw = parseFloat(lines[7]), pressureRaw = parseFloat(lines[8]);
        const gardenBedTemp = parseFloat(lines[9]);
        const batteryVoltageVal = parseFloat(lines[10]), loadCurrent = parseFloat(lines[11]);
        const rawSolarVoltage = parseFloat(lines[12]), chargeCurrent = parseFloat(lines[13]);
        const peakWindGustVal = parseFloat(lines[14]);
        const vectorWindSpeedVal = parseFloat(lines[15]), vectorWindDirVal = parseFloat(lines[16]);
        const rainSince9 = parseFloat(lines[17]), evapRate = parseFloat(lines[18]);
        const dailyEvap = parseFloat(lines[20]), dewPoint = parseFloat(lines[21]);
        const soilTemp10 = parseFloat(lines[22]), soilTemp20 = parseFloat(lines[23]);
        const soilTemp30 = parseFloat(lines[24]), soilTemp40 = parseFloat(lines[25]);
        const moisture10Val = parseFloat(lines[26]), moisture20Val = parseFloat(lines[27]);
        const moisture30Val = parseFloat(lines[28]), moisture40Val = parseFloat(lines[29]);
        const blackGlobeTemp = parseFloat(lines[30]);

        // Basic Data Validation
        if (isNaN(windSpeed) || isNaN(humidityRaw) || isNaN(temperatureRaw) || isNaN(pressureRaw) || isNaN(blackGlobeTemp)) {
          console.error("Invalid numeric data:", lines.slice(0, 10).join(',')); // Log start of bad data
          setStatusBadge("Data Error", "error");
          return false;
        }

        // --- Update DOM Elements ---
        updateText("dateVal", formatDateString(dateStr));
        updateText("timeVal", timeStr + " AEST");
        updateText("windSpeedVal", windSpeed.toFixed(1));
        updateText("windDirDegVal", windDirDeg.toFixed(1));
        updateText("windDirTextVal", getWindDirection(windDirDeg));
        updateText("humidityVal", humidityRaw.toFixed(1));
        updateText("humidityDescVal", getHumidityDesc(humidityRaw));

        const tempData = getTemperatureColorAndDesc(temperatureRaw);
        const tempFormatted = temperatureRaw.toFixed(1) + "¬∞C";
        const tempSpan = document.getElementById("tempVal");
        if (tempSpan) { tempSpan.textContent = tempFormatted; tempSpan.style.color = tempData.color; }
        updateText("tempDescVal", tempData.desc);

        const bigTempElement = document.getElementById("bigTempVal");
        const bigTempContainer = document.getElementById("airTempBox");
        if (bigTempElement && bigTempContainer) {
            if (bigTempElement.textContent !== tempFormatted) {
                 bigTempElement.textContent = tempFormatted;
                 bigTempContainer.style.backgroundColor = tempData.color;
                 bigTempContainer.classList.add('updated');
                 setTimeout(() => { bigTempContainer.classList.remove('updated'); }, 300);
            }
            bigTempElement.style.color = "#FFF";
            bigTempContainer.querySelector('.label').style.color = "#FFF";
        }

        let rainSince9Display = rainSince9.toFixed(1) + " mm";
        if (rainSince9 >= 0.2) { rainSince9Display = `<span class="highlight-blue">${rainSince9Display}</span>`; }
        updateHTML("rainSince9Val", rainSince9Display);

        if (isNaN(rainInLastMinRaw)) { rainInLastMinRaw = 0.0; }
        let rainInLastMinDisplay = rainInLastMinRaw.toFixed(1) + " mm";
        if (rainInLastMinRaw >= 0.2) { rainInLastMinDisplay = `<span class="highlight-blue">${rainInLastMinDisplay}</span>`; }
        updateHTML("rainInLastMinVal", rainInLastMinDisplay);

        const solarRad = Math.max(0, solarRadRaw);
        let solarRadDisplay = solarRad.toFixed(1) + " W/m¬≤";
        let solarClass = '';
        if (solarRad === 0) { solarClass = "highlight-lowsolar"; solarRadDisplay += " üåô"; }
        else if (solarRad <= 100) { solarClass = "highlight-darkblue"; } else if (solarRad <= 299) { solarClass = "highlight-blue"; }
        else if (solarRad <= 600) { solarClass = "highlight-warmsolar"; } else if (solarRad <= 800) { solarClass = "highlight-orange"; }
        else if (solarRad <= 1100) { solarClass = "highlight-hotsolar"; } else { solarClass = "highlight-vryhotsolar"; }
        updateHTML("solarRadVal", `<span class="${solarClass}">${solarRadDisplay}</span>`);

        const globeTempData = getTemperatureColorAndDesc(blackGlobeTemp);
        const globeElem = document.getElementById("blackGlobeTempVal");
        if (globeElem) { globeElem.textContent = blackGlobeTemp.toFixed(1); globeElem.style.color = globeTempData.color; }

        const radiantDiff = blackGlobeTemp - temperatureRaw;
        const radiantDiffElem = document.getElementById("radiantDiffVal");
        const radiantDiffBox = document.getElementById("radiantDiffBox");
        if (radiantDiffElem && radiantDiffBox) {
            const diffFormatted = (radiantDiff >= 0 ? "+" : "") + radiantDiff.toFixed(1) + "¬∞C";
            radiantDiffElem.textContent = diffFormatted;
            radiantDiffBox.style.backgroundColor = radiantDiff >= 1.0 ? "#d94a38" : radiantDiff <= -1.0 ? "#4682B4" : "#808080";
            radiantDiffElem.style.color = "#FFF";
            radiantDiffBox.querySelector('.label').style.color = "#FFF";
        }

        const dewDiff = temperatureRaw - dewPoint;
        const dewDiffElem = document.getElementById("dewDiffVal");
        const dewDiffBox = document.getElementById("dewDiffBox");
        if (dewDiffElem && dewDiffBox) {
            const dewFormatted = (dewDiff >= 0 ? "+" : "") + dewDiff.toFixed(1) + "¬∞C";
            dewDiffElem.textContent = dewFormatted;
            dewDiffBox.style.backgroundColor = dewDiff < 1.5 ? "#4682B4" : dewDiff > 3.0 ? "#D2B48C" : "#808080";
            dewDiffElem.style.color = "#FFF";
            dewDiffBox.querySelector('.label').style.color = "#FFF";
        }

        updateText("gardenBedTempVal", gardenBedTemp.toFixed(1));

        const PRESSURE_OFFSET = 1.9;
        let adjustedPressure = pressureRaw - PRESSURE_OFFSET;
        let pressureDisplay = adjustedPressure.toFixed(1) + " hPa";
        if (adjustedPressure >= 1020) { pressureDisplay = `<span class="highlight-green">${pressureDisplay} <span aria-label="High pressure, good fishing">üêü</span></span>`; }
        else if (adjustedPressure <= 1000) { pressureDisplay = `<span class="highlight-orange">${pressureDisplay} <span aria-label="Low pressure"> L</span></span>`; }
        updateHTML("pressureVal", pressureDisplay);

        const batteryVoltage = batteryVoltageVal.toFixed(1);
        let batteryClass = batteryVoltageVal < 12.2 ? "highlight-red" : batteryVoltageVal < 12.5 ? "highlight-orange" : batteryVoltageVal >= 13.8 ? "highlight-green" : "";
        updateHTML("batteryVal", `<span class="${batteryClass}">${batteryVoltage} V</span>`);

        updateText("loadVal", loadCurrent.toFixed(1));
        updateText("solarPanelVal", rawSolarVoltage > batteryVoltageVal ? rawSolarVoltage.toFixed(1) + " V ‚òÄÔ∏è" : "0.0 V üåô");

        let chargeDisplay = chargeCurrent.toFixed(1) + " mA";
        if (batteryVoltageVal < 13.80) {
            const netCurrent = chargeCurrent - loadCurrent;
            if (netCurrent > 10) { chargeDisplay = `<span class="highlight-green">${chargeDisplay}</span>`; }
            else if (netCurrent < -10) { chargeDisplay = `<span class="highlight-red">${chargeDisplay}</span>`; }
        } else if (chargeCurrent > 0) { chargeDisplay = `<span class="highlight-green">${chargeDisplay}</span>`; }
        updateHTML("chargeVal", chargeDisplay);

        let peakWindGustDisplay = peakWindGustVal.toFixed(1) + " km/h";
        if (peakWindGustVal > 35) { peakWindGustDisplay = `<span class="highlight-red">${peakWindGustDisplay}</span>`; }
        else if (peakWindGustVal > 20) { peakWindGustDisplay = `<span class="highlight-orange">${peakWindGustDisplay}</span>`; }
        updateHTML("peakWindGustVal", peakWindGustDisplay);

        updateText("vectorWindSpeedVal", vectorWindSpeedVal.toFixed(1));
        updateText("vectorWindDirDegVal", vectorWindDirVal.toFixed(1));
        updateText("vectorWindDirTextVal", getWindDirection(vectorWindDirVal));
        updateText("evapRateVal", evapRate.toFixed(3));
        updateText("dailyEvapVal", dailyEvap.toFixed(3));
        updateText("dewPointVal", dewPoint.toFixed(1));
        updateText("soilTemp10Val", soilTemp10.toFixed(1));
        updateText("soilTemp20Val", soilTemp20.toFixed(1));
        updateText("soilTemp30Val", soilTemp30.toFixed(1));
        updateText("soilTemp40Val", soilTemp40.toFixed(1));
        updateHTML("moisture10Val", colorMoisture(moisture10Val));
        updateHTML("moisture20Val", colorMoisture(moisture20Val));
        updateHTML("moisture30Val", colorMoisture(moisture30Val));
        updateHTML("moisture40Val", colorMoisture(moisture40Val));

        updateText("lastUpdatedTimestamp", new Date().toLocaleTimeString());

        return true; // Success

      } catch (error) {
        console.error("Error processing data:", error);
        setStatusBadge("Processing Error", "error");
        return false; // Failure
      }
    }

    /*****************************
     * FETCH & AUTO-REFRESH LOGIC *
     *****************************/
    function fetchWeather() {
        // REMOVED spinnerContainer reference
        const fetchBtn = document.getElementById("fetchBtn");

        setStatusBadge("Fetching...", "fetching");
        // REMOVED spinnerContainer display toggle
        fetchBtn.disabled = true;

        if (refreshTimeout) { clearTimeout(refreshTimeout); }

        fetch(WEATHER_ENDPOINT)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Server responded ${response.status}: ${response.statusText}`);
                }
                return response.text();
            })
            .then(data => {
                const updateSuccess = updateWeatherData(data);
                if (updateSuccess) {
                    setStatusBadge("Connected", "connected");
                    retryAttempts = 0;
                    initialLoadComplete = true; // Mark initial load as complete on first success
                    scheduleNextFetch();
                } else {
                    // updateWeatherData already set status badge to Error
                    handleFetchError(new Error("Data processing failed after fetch"));
                }
            })
            .catch(error => {
                console.error("Fetch error:", error.message);
                handleFetchError(error); // Pass the actual error object
            })
            .finally(() => {
                // Re-enable button only if not immediately retrying or if max retries hit
                 if (retryAttempts === 0 || retryAttempts >= MAX_RETRY_ATTEMPTS) {
                     fetchBtn.disabled = false;
                 }
                 // REMOVED spinnerContainer display toggle
            });
    }

    function handleFetchError(error) {
        retryAttempts++;
        console.log(`Fetch attempt ${retryAttempts} failed.`);
        const fetchBtn = document.getElementById("fetchBtn"); // Get button reference here

        if (retryAttempts >= MAX_RETRY_ATTEMPTS) {
            setStatusBadge(`Error (${error.message.substring(0, 20)})`, "error"); // Show part of error msg
            console.log(`Max retries (${MAX_RETRY_ATTEMPTS}) reached. Scheduling longer retry.`);
            const backoffDelay = Math.min(MAX_BACKOFF_DELAY, RETRY_DELAY_LONG * Math.pow(2, retryAttempts - MAX_RETRY_ATTEMPTS));
            refreshTimeout = setTimeout(fetchWeather, backoffDelay);
            fetchBtn.disabled = false; // Enable button after failed backoff schedule
        } else {
            setStatusBadge("Retrying...", "fetching");
             const retryDelay = (retryAttempts === 1) ? RETRY_DELAY_SHORT : RETRY_DELAY_LONG;
            refreshTimeout = setTimeout(fetchWeather, retryDelay);
            console.log(`Retrying fetch in ${retryDelay}ms...`);
            fetchBtn.disabled = true; // Keep button disabled during quick retries
        }
         // REMOVED spinnerContainer display toggle
    }

    function scheduleNextFetch() {
        if (refreshTimeout) { clearTimeout(refreshTimeout); }
        const now = new Date();
        const currentSecond = now.getSeconds();
        let delay = (currentSecond < SCHEDULE_TARGET_SECOND)
            ? (SCHEDULE_TARGET_SECOND - currentSecond) * 1000 - now.getMilliseconds()
            : ((60 - currentSecond) + SCHEDULE_TARGET_SECOND) * 1000 - now.getMilliseconds();
        delay = Math.max(1000, delay);

        console.log(`Scheduling next fetch in ${Math.round(delay / 1000)} seconds.`);
        refreshTimeout = setTimeout(fetchWeather, delay);
    }

    function manualFetch() {
        console.log("Manual fetch requested.");
        if (refreshTimeout) { clearTimeout(refreshTimeout); }
        retryAttempts = 0;
        fetchWeather();
    }

    // Initial Setup on Load
    window.addEventListener("load", () => {
        setStatusBadge("Waiting...", "waiting");
        fetchWeather(); // Start the fetch process
    });

  </script>
</body>
</html>