<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Live weather data from Moore's Weather Station in West Warwick, QLD.">
  <title>Moore's LIVE Weather Data</title>

  <link rel="apple-touch-icon" href="/Weather_Station_App.png">
  <link rel="icon" href="/favicon.ico"> <!-- Optional: Add a favicon -->

  <!-- Google Fonts: Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    /* --- Base Styles & Variables --- */
    :root {
      --font-family-base: "Inter", "system-ui", "Segoe UI", "Helvetica Neue", Arial, sans-serif;
      --color-background: #f8f9fa;
      --color-card-bg: #ffffff;
      --color-text-primary: #212529;
      --color-text-secondary: #6c757d;
      --color-primary: #1e3a8a; /* Header blue */
      --color-accent: #FFA500; /* Orange */
      --color-accent-darker: #e59400;
      --color-accent-text: #4A4A4A;
      --color-border: #e9ecef;
      --color-success: #198754; /* Green */
      --color-success-darker: #146c43;
      --color-warning: #ffc107;
      --color-danger: #dc3545;
      --color-info: #0dcaf0; /* For fetching/retrying */
      --color-info-darker: #0a58ca;
      --color-purple: #6f42c1; /* For Rad Heat Diff negative */
      --color-teal: #20c997;  /* For Temp > Dew P */
      --border-radius-sm: 0.3rem;
      --border-radius-md: 0.6rem;
      --border-radius-lg: 0.75rem;
      --shadow-card: 0 4px 12px rgba(0, 0, 0, 0.08);
      --shadow-button: 0 2px 4px rgba(0, 0, 0, 0.15);

      /* Font size reduction */
      --font-size-base: 0.8125rem; /* 13px */
      --font-size-sm: 0.75rem;    /* 12px */
      --font-size-lg: 1rem;        /* 16px */
      --font-size-xl: 1.125rem;   /* 18px */
    }

    html {
      font-size: 16px;
      box-sizing: border-box;
    }

    *, *:before, *:after {
      box-sizing: inherit;
    }

    body {
      margin: 0;
      background-color: var(--color-background);
      font-family: var(--font-family-base);
      font-size: var(--font-size-base); /* Use variable */
      font-weight: 400;
      line-height: 1.4; /* Slightly tighter */
      letter-spacing: 0.1px;
      color: var(--color-text-primary);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
      padding-top: env(safe-area-inset-top, 0);
    }

    .main-container {
      max-width: 400px;
      margin: 0.75rem auto;
      padding: 0 0.3125rem;
    }

    p {
      margin: 0.2rem 0; /* Tighten paragraph spacing */
      line-height: 1.35;
      /* USER FEEDBACK: Prioritize alignment - prevent wrapping */
      white-space: nowrap;
      overflow: hidden; /* Prevent overflow if nowrap is too strict */
      text-overflow: ellipsis; /* Indicate truncation */
    }

    b, strong {
      font-weight: 600;
      color: var(--color-text-secondary);
      margin-right: 0.25em;
    }

    /* --- Animations --- */
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.03); }
      100% { transform: scale(1); }
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* --- Layout Components --- */
    .freeze-pane {
      position: sticky;
      top: env(safe-area-inset-top, 0);
      z-index: 100;
      background: var(--color-background);
      padding: 0;
      margin-bottom: 0;
    }

    .header-box {
      background-color: var(--color-primary);
      border-radius: var(--border-radius-md) var(--border-radius-md) 0 0;
      padding: 0.5rem 0.75rem;
      text-align: center;
    }

    .header-box h2 {
      margin: 0;
      font-size: var(--font-size-lg); /* 16px */
      font-weight: 700;
      color: white;
      white-space: nowrap;
    }

    #weatherData {
      background: var(--color-card-bg);
      padding: 0;
      border-radius: 0 0 var(--border-radius-lg) var(--border-radius-lg);
      box-shadow: var(--shadow-card);
      font-size: var(--font-size-base);
      color: var(--color-text-primary);
      text-align: left;
      margin-bottom: 1rem;
    }

    /* --- Control Bar & Buttons --- */
    .control-bar {
      padding: 0.625rem 0.75rem;
      border-bottom: 1px solid var(--color-border);
    }

    .control-container {
      display: flex;
      justify-content: space-between;
      align-items: center; /* Vertically center buttons */
      gap: 0.75rem;
    }

    .control-half {
      display: flex;
      align-items: center;
    }
    .control-half:first-child { justify-content: flex-start; }
    .control-half:last-child { justify-content: flex-end; }

    /* Shared button/status styles */
    .button-style {
      padding: 0.5rem 0.875rem;
      font-size: var(--font-size-base); /* 13px */
      font-weight: 600;
      font-family: var(--font-family-base);
      border: none;
      border-radius: var(--border-radius-sm);
      cursor: pointer;
      transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
      display: inline-block;
      white-space: nowrap;
      line-height: 1.2;
      letter-spacing: 0.3px;
      text-align: center;
      box-shadow: var(--shadow-button);
    }

    button#fetchBtn {
      background-color: var(--color-accent);
      color: var(--color-accent-text);
    }

    button#fetchBtn:hover {
      background-color: var(--color-accent-darker);
      transform: translateY(-1px);
    }

    button#fetchBtn:disabled {
      background-color: #adb5bd;
      color: #fff;
      cursor: not-allowed;
      opacity: 0.8;
      box-shadow: none;
      transform: none;
    }

    /* Status Badge styled as a button */
    #status { /* Container for the badge */
       display: flex;
       align-items: center;
       margin: 0;
       padding: 0;
    }
    #statusBadge {
      /* Inherit shared styles */
      background-color: #6c757d; /* Default: Waiting state (gray) */
      color: white;
      cursor: default; /* Not clickable like the button */
    }
    #statusBadge.connected {
      background-color: var(--color-success);
      color: white;
    }
    #statusBadge.fetching {
      background-color: var(--color-info);
      color: var(--color-text-primary); /* Darker text on light blue */
    }
    #statusBadge.error {
      background-color: var(--color-danger);
      color: white;
    }
     /* Remove hover/active effects from status */
    #statusBadge:hover {
        transform: none;
        box-shadow: var(--shadow-button); /* Keep shadow consistent */
    }


    /* --- Data Sections --- */
    .data-section {
      padding: 0.625rem 0.875rem; /* Slightly reduced padding */
      border-bottom: 1px solid var(--color-border);
    }
    .data-section:last-child { border-bottom: none; }

    /* Header Section within Card */
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .title-date-container { display: flex; flex-direction: column; }

    .address-title {
      font-size: 1rem; /* 16px */
      font-weight: 700;
      margin: 0 0 0.2rem 0;
      color: var(--color-primary);
      white-space: nowrap; /* Keep title on one line */
    }

    .date-time {
      margin: 0;
      font-size: var(--font-size-sm); /* 12px */
      color: var(--color-text-secondary);
      line-height: 1.3;
    }
    .date-time p {
      margin: 0.05rem 0; /* Very tight */
      white-space: nowrap;
    }
    .date-time b {
       font-weight: 400;
       color: var(--color-text-secondary);
    }
    .date-time span {
        color: var(--color-text-primary);
        font-weight: 600;
    }

    .logo-container {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .logo-container img {
      height: 40px; /* USER FEEDBACK: Reduced logo size */
      width: auto;
      display: block;
      border-radius: var(--border-radius-sm);
    }

    /* Main Data Layout (Wind/Logger) */
    .wind-logger-container {
      display: flex;
      justify-content: space-between;
      gap: 0.75rem; /* 12px */
    }

    .wind-column { width: 60%; flex-shrink: 0; }
    .logger-column {
      width: 40%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      gap: 0.5rem; /* 8px */
    }

    /* Big Temp Box - Revised Style */
    .big-temp-box {
      width: 100%;
      min-height: 60px; /* Slightly reduced min height */
      padding: 0.4rem 0.5rem; /* Reduced padding */
      border: none; /* Removed border */
      border-radius: var(--border-radius-md);
      background-color: #6c757d;
      color: white; /* USER FEEDBACK: Always white text */
      font-family: var(--font-family-base);
      text-align: center;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      transition: background-color 0.3s ease, transform 0.3s ease-in-out;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1); /* Softer shadow */
      /* USER FEEDBACK: Ensure contrast */
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.4);
    }

    .big-temp-box.updated { animation: pulse 0.3s ease-in-out; }

    .big-temp-box span.value {
      font-size: 1.125rem; /* 18px - Reduced */
      font-weight: 700;
      line-height: 1.1;
      display: block;
    }

    .big-temp-box span.label {
      font-size: var(--font-size-sm); /* 12px */
      font-weight: 600;
      line-height: 1.2;
      margin-top: 0.1rem;
      opacity: 0.9;
      display: block;
    }

    /* Dynamic Background Colors for Big Temp Box ( Adjusted based on image) */
    /* Air Temp */
    .big-temp-box#airTempBox.temp-cold { background-color: #0aadef; } /* Light Blue */
    .big-temp-box#airTempBox.temp-cool { background-color: #0dcaf0; } /* Cyan */
    .big-temp-box#airTempBox.temp-mild { background-color: #2eb350; } /* Target Image Green */
    .big-temp-box#airTempBox.temp-warm { background-color: #ffc107; } /* Yellow */
    .big-temp-box#airTempBox.temp-hot { background-color: #dc3545; } /* Red */
    /* Radiant Diff */
    .big-temp-box#radiantDiffBox.diff-positive { background-color: #fd7e14; } /* Orange */
    .big-temp-box#radiantDiffBox.diff-negative { background-color: var(--color-purple); } /* Target Image Purple */
    /* Dew Diff */
    .big-temp-box#dewDiffBox.dew-dry { background-color: #d63384; } /* Pinkish */
    .big-temp-box#dewDiffBox.dew-humid { background-color: var(--color-teal); } /* Target Image Teal */
    .big-temp-box#dewDiffBox.dew-neutral { background-color: #6c757d; } /* Gray */


    /* Rain Container */
    .rain-container {
      margin-top: 0.5rem; /* Reduced space */
      padding: 0.4rem 0.5rem; /* Reduced padding */
      border: 1px solid var(--color-border);
      border-radius: var(--border-radius-sm);
      background: #f8f9fa;
    }
    .rain-container p { margin: 0.1rem 0; }

    /* Two Column Layouts */
    .two-col-container {
      display: flex;
      justify-content: space-between;
      gap: 0.75rem; /* 12px */
    }
    .two-col-container > div { width: calc(50% - 0.375rem); }
    /* Apply nowrap to specific columns */
    .evap-col p, .battery-col p, .soiltemp-col p, .moisture-col p, .data-section > p /* Vector Wind */ {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }


    /* --- Utility Classes for Dynamic Styling (Keep as is) --- */
    .text-bold { font-weight: 700 !important; }
    .text-semibold { font-weight: 600 !important; }
    /* Temp colors for inline text values */
    .temp-very-cold { color: #104E8B !important; }
    .temp-cold { color: #4682B4 !important; }
    .temp-cool { color: #32CD32 !important; }
    .temp-mild { color: #228B22 !important; }
    .temp-warm { color: #D4A017 !important; }
    .temp-hot { color: #FF4500 !important; }
    .temp-very-hot { color: #B22222 !important; }
    /* Other dynamic styles */
    .rain-significant { color: #1E90FF !important; font-weight: 600 !important; }
    .solar-low { color: #27408B !important; }
    .solar-med { color: #DAA520 !important; font-weight: 600 !important; }
    .solar-high { color: #BF360C !important; font-weight: 600 !important; }
    .solar-very-high { color: #B71C1C !important; font-weight: 600 !important; }
    .solar-zero { color: #000033 !important; }
    .pressure-high { color: green !important; font-weight: 600 !important; }
    .battery-ok { color: green !important; }
    .battery-full { color: green !important; font-weight: 600 !important; }
    .battery-low { color: red !important; }
    .charge-positive { color: green !important; }
    .charge-negative { color: red !important; }
    .wind-gust-high { color: red !important; font-weight: 600 !important; }
    .wind-gust-med { color: #FF8C00 !important; font-weight: 600 !important; }
    .moisture-dry { color: #FF8C00 !important; font-weight: 600 !important; }


    /* --- Spinner --- */
    .spinner-container {
      display: none;
      margin: 1.25rem auto;
      width: 30px; /* Smaller spinner */
      height: 30px;
      position: relative;
    }
    .spinner {
      width: 100%; height: 100%;
      border: 3px solid rgba(0, 0, 0, 0.1);
      border-top-color: var(--color-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

  </style>
</head>
<body>
  <div class="main-container">

    <!-- Sticky Header -->
    <div class="freeze-pane">
      <div class="header-box">
        <h2>Moore's LIVE Weather Data</h2>
      </div>
    </div>

    <!-- Weather Data Card -->
    <div id="weatherData">

      <!-- Control Button Bar -->
      <div class="control-bar">
        <div class="control-container">
          <div class="control-half">
            <button id="fetchBtn" class="button-style" onclick="manualFetch()">Current Readings</button>
          </div>
          <div class="control-half">
             <!-- Status text is now inside the styled span -->
             <p id="status">
                 <span id="statusBadge" class="button-style">Waiting...</span>
             </p>
          </div>
        </div>
      </div>

      <!-- Header Section -->
      <div class="data-section header-content">
        <div class="title-date-container">
          <div class="address-title">WEST WARWICK, QLD</div>
          <div class="date-time">
            <!-- Emojis directly in HTML -->
            <p>📅 <span id="dateVal">-- / -- / ---- (---)</span></p>
            <p>⏰ <span id="timeVal">-- : -- : -- AEST</span></p>
          </div>
        </div>
        <div class="logo-container">
          <img src="/Weather_Station_App.png" alt="Weather Station Icon">
          <img src="/Station_Label.png" alt="Environdata Weather Maestro">
        </div>
      </div>

      <!-- Main Data Columns Section -->
      <div class="data-section wind-logger-container">
        <div class="wind-column">
          <!-- Emojis in HTML, labels via <b> -->
          <p><b>💨 Wind Speed:</b> <span id="windSpeedVal">--</span> km/h</p>
          <p><b>🧭 Wind Direction:</b> <span id="windDirDegVal">--</span>° (<span id="windDirTextVal">--</span>)</p>
          <p><b>💦 Humidity:</b> <span id="humidityVal">--</span>% (<span id="humidityDescVal">--</span>)</p>
          <p><b>🌡️ Temperature:</b> <span id="tempVal" class="temp-value">--°C</span> (<span id="tempDescVal">--</span>)</p>
          <p><b>☀️ Solar Radiation:</b> <span id="solarRadVal">-- W/m²</span> <span id="solarEmoji"></span></p> <!-- Separate span for emoji if needed -->
          <p><b>⚫ Black Globe Temp:</b> <span id="blackGlobeTempVal" class="temp-value">--</span>°C</p> <!-- Changed emoji -->
          <p><b>🌱 Garden Bed Temp:</b> <span id="gardenBedTempVal">--</span>°C</p>
          <p><b>🌀 Pressure:</b> <span id="pressureVal">-- hPa</span> <span id="pressureEmoji"></span></p> <!-- Separate span for emoji -->
          <div class="rain-container">
            <p><b>🌧️ Rain Since 9AM:</b> <span id="rainSince9Val">--</span> mm</p>
            <p><b>💧 Rain In Last Min:</b> <span id="rainInLastMinVal">--</span> mm</p> <!-- Changed emoji -->
          </div>
        </div>
        <div class="logger-column">
          <div class="big-temp-box" id="airTempBox">
            <span class="value" id="bigTempVal">--°C</span>
            <span class="label">Air Temp</span>
          </div>
          <div class="big-temp-box" id="radiantDiffBox">
            <span class="value" id="radiantDiffVal">--°C</span>
            <span class="label" aria-label="Difference between radiant and air temperature">Rad. Heat Diff</span>
          </div>
          <div class="big-temp-box" id="dewDiffBox">
            <span class="value" id="dewDiffVal">--°C</span>
            <span class="label" aria-label="Temp above dew point">Temp > Dew P.</span>
          </div>
        </div>
      </div>

      <!-- Evaporation and Battery Section -->
      <div class="data-section two-col-container evap-battery">
        <div class="evap-col">
          <p><b>⤴️ Evap/Hr:</b> <span id="evapRateVal">--</span> mm/h</p>
          <p><b>⬆️ Daily Evap:</b> <span id="dailyEvapVal">--</span> mm</p>
          <p><b>💧 Dew Point:</b> <span id="dewPointVal">--</span>°C</p>
          <p><b>🌬️ Max WS Gust:</b> <span id="peakWindGustVal">--</span> km/h</p> <!-- Unit moved here -->
        </div>
        <div class="battery-col">
          <p><b>🔋 Battery:</b> <span id="batteryVal">--</span> V</p> <!-- Unit moved here -->
          <p><b>⚡ Load:</b> <span id="loadVal">--</span> mA</p> <!-- Unit moved here -->
          <p><b>☀️ Solar Panel:</b> <span id="solarPanelVal">--</span> V <span id="solarPanelEmoji"></span></p> <!-- Unit/emoji -->
          <p><b>🔌 Charge:</b> <span id="chargeVal">--</span> mA</p> <!-- Unit moved here -->
        </div>
      </div>

      <!-- Additional Data Section -->
      <div class="data-section">
         <p><b>🌿 Vector Wind Speed:</b> <span id="vectorWindSpeedVal">--</span> km/h</p> <!-- Changed emoji -->
         <p><b>🧭 Vector Wind Direction:</b> <span id="vectorWindDirDegVal">--</span>° (<span id="vectorWindDirTextVal">--</span>)</p>
      </div>

      <!-- Soil Moisture Section -->
      <div class="data-section two-col-container soil-moisture">
        <div class="soiltemp-col">
          <p><b>🌡️ S. Temp 10cm:</b> <span id="soilTemp10Val">--</span>°C</p>
          <p><b>🌡️ S. Temp 20cm:</b> <span id="soilTemp20Val">--</span>°C</p>
          <p><b>🌡️ S. Temp 30cm:</b> <span id="soilTemp30Val">--</span>°C</p>
          <p><b>🌡️ S. Temp 40cm:</b> <span id="soilTemp40Val">--</span>°C</p>
        </div>
        <div class="moisture-col">
          <p><b>💧 Moist. 10cm:</b> <span id="moisture10Val">--</span>%</p>
          <p><b>💧 Moist. 20cm:</b> <span id="moisture20Val">--</span>%</p>
          <p><b>💧 Moist. 30cm:</b> <span id="moisture30Val">--</span>%</p>
          <p><b>💧 Moist. 40cm:</b> <span id="moisture40Val">--</span>%</p>
        </div>
      </div>

    </div> <!-- End #weatherData Card -->

    <!-- Spinner -->
    <div id="spinnerContainer" class="spinner-container">
      <div class="spinner"></div>
    </div>

  </div> <!-- End .main-container -->

  <script>
    /********************
    * HELPER FUNCTIONS *
    ********************/
    // --- Keep helper functions like getWindDirection, formatDateString ---
    function getWindDirection(degrees) { /* ... as before ... */ }
    function formatDateString(dateStr) { /* ... as before ... */ }

    // --- STATUS BADGE TEXT ---
    function setStatusBadge(statusText, statusClass) {
        const badge = document.getElementById("statusBadge");
        if (badge) {
            // USER FEEDBACK: Simple status text
            let displayStatus = statusText;
            if (statusClass === 'fetching' && statusText.startsWith('Retrying')) {
                displayStatus = 'Retrying...'; // Keep retry concise
            } else if (statusClass === 'error' && statusText.startsWith('Error')) {
                 displayStatus = 'Error'; // Keep error concise
            }

            badge.textContent = displayStatus; // Set only the status text
            badge.className = `button-style ${statusClass}`; // Apply base style + dynamic class
        } else {
            console.warn("statusBadge element not found");
        }
    }


    // --- REVISED DYNAMIC CLASS FUNCTIONS ---
    // These now only return class names or empty strings
    function getTemperatureInfo(temp) {
      let desc = ""; let className = "";
      if (temp < -10) { desc = "Severely cold"; className = "temp-very-cold"; }
      else if (temp < 0) { desc = "Extremely cold"; className = "temp-very-cold"; }
      else if (temp < 6) { desc = "Very cold"; className = "temp-cold"; }
      else if (temp < 11) { desc = "Cold"; className = "temp-cold"; }
      else if (temp < 16) { desc = "Cool"; className = "temp-cool"; }
      else if (temp < 21) { desc = "Mild"; className = "temp-mild"; }
      else if (temp < 28) { desc = "Warm"; className = "temp-warm"; }
      else if (temp < 32) { desc = "Warmer"; className = "temp-hot"; }
      else if (temp < 36) { desc = "Hot"; className = "temp-hot"; }
      else if (temp < 41) { desc = "Very hot"; className = "temp-very-hot"; }
      else if (temp <= 60) { desc = "Extremely hot"; className = "temp-very-hot"; }
      else { desc = ""; className = ""; } // Default/fallback
      return { desc, className };
    }

    function getBigTempBoxAirClass(temp) {
       if (temp < 6) return 'temp-cold';
       if (temp < 11) return 'temp-cool';
       if (temp < 21) return 'temp-mild'; // Adjusted Mild range slightly
       if (temp < 32) return 'temp-warm'; // Adjusted Warm range slightly
       return 'temp-hot';
    }

    function getRadiantDiffClass(diff) {
       // Match target image: Purple for negative, Orange for positive
       return diff >= 0 ? 'diff-positive' : 'diff-negative';
     }

     function getDewDiffClass(diff) {
        // Match target image: Teal for humid (low diff), Gray for neutral/dry?
        if (diff < 1.5) return 'dew-humid'; // Humid
        // if (diff >= 3.0) return 'dew-dry'; // Pinkish - Optional if desired
        return 'dew-neutral'; // Default/Dryish state
     }

    function getHumidityDesc(humidity) { /* ... as before ... */ }

    function getMoistureClass(val) {
      return (val < 20) ? "moisture-dry text-semibold" : "";
    }

    function getSolarRadiationClass(solarRad) {
        if (solarRad <= 0) return 'solar-zero';
        if (solarRad <= 100) return 'solar-low';
        if (solarRad <= 600) return 'solar-med';
        if (solarRad <= 1100) return 'solar-high';
        return 'solar-very-high';
    }
    function getPressureClass(pressure) {
        return pressure >= 1020 ? 'pressure-high text-semibold' : ''; // Added semibold
    }
    function getBatteryClass(voltage) {
        if (voltage < 12.5) return 'battery-low text-semibold'; // Semibold on low
        if (voltage >= 13.8) return 'battery-full text-semibold';
        return 'battery-ok';
    }
    function getChargeClass(charge, load, voltage) {
         if (voltage < 13.80) {
             return charge > load ? 'charge-positive text-semibold' : 'charge-negative text-semibold'; // Semibold added
         }
         return '';
    }
    function getWindGustClass(gust) {
        if (gust > 25) return 'wind-gust-high text-semibold';
        if (gust > 10) return 'wind-gust-med text-semibold';
        return '';
    }
    function getRainClass(rainAmount) {
        return rainAmount >= 0.2 ? 'rain-significant text-semibold' : '';
    }


    /*****************************
    * GLOBAL STATE & RETRIES *
    *****************************/
    // --- Keep as is ---
    let initialLoadComplete = false; /* ... */
    let refreshTimeout; /* ... */
    let retryAttempts = 0; /* ... */
    const MAX_RETRY_ATTEMPTS = 3; /* ... */
    const WEATHER_ENDPOINT = "/weather"; /* ... */


    /*****************************
    * MAIN UPDATE FUNCTION *
    *****************************/
    function updateWeatherData(data) {
      console.log("Raw CSV data received");
      const lines = data.replace(/r3\r?\n?/, "").trim().split(",");

      if (lines.length < 30) { /* ... error handling as before ... */ return; }

      try {
        // --- Extract Data (Keep as is) ---
        const dateStr = lines[0]; /* ... */ const timeStr = lines[1]; /* ... */
        const windSpeed = parseFloat(lines[2]); /* ... */ const windDirDeg = parseFloat(lines[3]); /* ... */
        const humidityRaw = parseFloat(lines[4]); /* ... */ const temperatureRaw = parseFloat(lines[5]); /* ... */
        let rainInLastMinRaw = parseFloat(lines[6]); /* ... */ const solarRadRaw = parseFloat(lines[7]); /* ... */
        const pressureRaw = parseFloat(lines[8]); /* ... */ const gardenBedTemp = parseFloat(lines[9]); /* ... */
        const batteryVoltageVal = parseFloat(lines[10]); /* ... */ const loadCurrent = parseFloat(lines[11]); /* ... */
        const rawSolarVoltage = parseFloat(lines[12]); /* ... */ const chargeCurrent = parseFloat(lines[13]); /* ... */
        const peakWindGustVal = parseFloat(lines[14]); /* ... */ const vectorWindSpeedVal = parseFloat(lines[15]); /* ... */
        const vectorWindDirVal = parseFloat(lines[16]); /* ... */ const rainSince9 = parseFloat(lines[17]); /* ... */
        const evapRate = parseFloat(lines[18]); /* ... */ const dailyEvap = parseFloat(lines[20]); /* ... */
        const dewPoint = parseFloat(lines[21]); /* ... */ const soilTemp10 = parseFloat(lines[22]); /* ... */
        const soilTemp20 = parseFloat(lines[23]); /* ... */ const soilTemp30 = parseFloat(lines[24]); /* ... */
        const soilTemp40 = parseFloat(lines[25]); /* ... */ const moisture10Val = parseFloat(lines[26]); /* ... */
        const moisture20Val = parseFloat(lines[27]); /* ... */ const moisture30Val = parseFloat(lines[28]); /* ... */
        const moisture40Val = parseFloat(lines[29]); /* ... */ const blackGlobeTemp = parseFloat(lines[30]); /* ... */

        // --- Validate Core Data (Keep as is) ---
        if (isNaN(windSpeed) || /* ... other checks ... */ isNaN(pressureRaw)) { /* ... error handling ... */ return; }

        // --- Update DOM Elements using textContent and classList ---

        // Helper to update text and classes (Revised slightly for base class handling)
        function updateElement(id, value, baseClass = '', dynamicClass = '') {
          const element = document.getElementById(id);
          if (element) {
            element.textContent = value;
            // Combine base and dynamic classes
            const classesToAdd = [];
            if (baseClass) classesToAdd.push(...baseClass.split(' ').filter(Boolean));
            if (dynamicClass) classesToAdd.push(...dynamicClass.split(' ').filter(Boolean));
            element.className = classesToAdd.join(' '); // Set combined classes
          } else {
            console.warn(`Element with id "${id}" not found.`);
          }
        }
         // Helper to update only classes
         function updateElementClass(id, baseClass = '', dynamicClass = '') {
             const element = document.getElementById(id);
             if (element) {
                const classesToAdd = [];
                if (baseClass) classesToAdd.push(...baseClass.split(' ').filter(Boolean));
                if (dynamicClass) classesToAdd.push(...dynamicClass.split(' ').filter(Boolean));
                element.className = classesToAdd.join(' ');
             } else {
                 console.warn(`Element class update failed: id "${id}" not found.`);
             }
         }

        // DATE & TIME
        updateElement("dateVal", formatDateString(dateStr));
        updateElement("timeVal", timeStr); // Remove AEST here, maybe add in HTML if static

        // WIND
        updateElement("windSpeedVal", windSpeed.toFixed(1));
        updateElement("windDirDegVal", windDirDeg.toFixed(1));
        updateElement("windDirTextVal", getWindDirection(windDirDeg));

        // HUMIDITY
        updateElement("humidityVal", humidityRaw.toFixed(1));
        updateElement("humidityDescVal", getHumidityDesc(humidityRaw));

        // TEMPERATURE
        const tempInfo = getTemperatureInfo(temperatureRaw);
        updateElement("tempVal", temperatureRaw.toFixed(1) + "°C", 'temp-value', tempInfo.className);
        updateElement("tempDescVal", tempInfo.desc);

        // BIG TEMP BOX - AIR
        const airTempBoxClass = getBigTempBoxAirClass(temperatureRaw);
        updateElement("bigTempVal", temperatureRaw.toFixed(1) + "°C", 'value');
        updateElementClass("airTempBox", 'big-temp-box updated', airTempBoxClass); // Use class helper

        // SOLAR RADIATION
        const solarRad = Math.max(0, solarRadRaw);
        updateElement("solarRadVal", solarRad.toFixed(1) + " W/m²", '', getSolarRadiationClass(solarRad));
        updateElement("solarEmoji", solarRad < 10 ? "🌙" : "☀️"); // Update emoji

        // BLACK GLOBE TEMP & RADIANT DIFF
        const globeTempInfo = getTemperatureInfo(blackGlobeTemp);
        updateElement("blackGlobeTempVal", blackGlobeTemp.toFixed(1), 'temp-value', globeTempInfo.className);

        const radiantDiff = blackGlobeTemp - temperatureRaw;
        const radiantDiffFormatted = (radiantDiff >= 0 ? "+" : "") + radiantDiff.toFixed(1) + "°C";
        const radiantDiffClass = getRadiantDiffClass(radiantDiff);
        updateElement("radiantDiffVal", radiantDiffFormatted, 'value');
        updateElementClass("radiantDiffBox", 'big-temp-box updated', radiantDiffClass);

         // TEMP ABOVE DEW POINT
         const dewDiff = temperatureRaw - dewPoint;
         const dewFormatted = (dewDiff >= 0 ? "+" : "") + dewDiff.toFixed(1) + "°C";
         const dewDiffClass = getDewDiffClass(dewDiff);
         updateElement("dewDiffVal", dewFormatted, 'value');
         updateElementClass("dewDiffBox", 'big-temp-box updated', dewDiffClass);

        // GARDEN BED TEMP
        updateElement("gardenBedTempVal", gardenBedTemp.toFixed(1));

        // PRESSURE
        let adjustedPressure = pressureRaw - 1.9;
        updateElement("pressureVal", adjustedPressure.toFixed(1) + " hPa", '', getPressureClass(adjustedPressure));
        updateElement("pressureEmoji", adjustedPressure >= 1020 ? "🐟" : ""); // Update emoji

        // RAIN
         rainInLastMinRaw = isNaN(rainInLastMinRaw) ? 0.0 : rainInLastMinRaw;
         updateElement("rainSince9Val", rainSince9.toFixed(1), '', getRainClass(rainSince9));
         updateElement("rainInLastMinVal", rainInLastMinRaw.toFixed(1), '', getRainClass(rainInLastMinRaw));

        // BATTERY & CHARGE
        updateElement("batteryVal", batteryVoltageVal.toFixed(1), '', getBatteryClass(batteryVoltageVal));
        updateElement("loadVal", loadCurrent.toFixed(1));

        updateElement("solarPanelVal", rawSolarVoltage.toFixed(1));
        updateElement("solarPanelEmoji", rawSolarVoltage < batteryVoltageVal ? "🌙" : "☀️");

        updateElement("chargeVal", chargeCurrent.toFixed(1), '', getChargeClass(chargeCurrent, loadCurrent, batteryVoltageVal));

        // PEAK WIND GUST
        updateElement("peakWindGustVal", peakWindGustVal.toFixed(1), '', getWindGustClass(peakWindGustVal));

        // VECTOR WIND
        updateElement("vectorWindSpeedVal", vectorWindSpeedVal.toFixed(1));
        updateElement("vectorWindDirDegVal", vectorWindDirVal.toFixed(1));
        updateElement("vectorWindDirTextVal", getWindDirection(vectorWindDirVal));

        // EVAP & DEW POINT
        updateElement("evapRateVal", evapRate.toFixed(3));
        updateElement("dailyEvapVal", dailyEvap.toFixed(3));
        updateElement("dewPointVal", dewPoint.toFixed(1));

        // SOIL TEMPS
        updateElement("soilTemp10Val", soilTemp10.toFixed(1)); /* ... */
        updateElement("soilTemp20Val", soilTemp20.toFixed(1)); /* ... */
        updateElement("soilTemp30Val", soilTemp30.toFixed(1)); /* ... */
        updateElement("soilTemp40Val", soilTemp40.toFixed(1)); /* ... */

        // SOIL MOISTURE
        updateElement("moisture10Val", moisture10Val.toFixed(1), '', getMoistureClass(moisture10Val)); /* ... */
        updateElement("moisture20Val", moisture20Val.toFixed(1), '', getMoistureClass(moisture20Val)); /* ... */
        updateElement("moisture30Val", moisture30Val.toFixed(1), '', getMoistureClass(moisture30Val)); /* ... */
        updateElement("moisture40Val", moisture40Val.toFixed(1), '', getMoistureClass(moisture40Val)); /* ... */

        // Remove pulse animation class after it runs
        setTimeout(() => {
            document.querySelectorAll('.big-temp-box.updated').forEach(el => el.classList.remove('updated'));
        }, 400);


      } catch (error) { /* ... error handling ... */ }
    }


    /*****************************
    * FETCH & AUTO-REFRESH LOGIC *
    *****************************/
    // --- Keep fetchWeather, scheduleNextFetch, manualFetch, and window.onload as in the previous version ---
    // --- They correctly handle the status updates via setStatusBadge ---
     function fetchWeather() { /* ... as before ... */ }
     function scheduleNextFetch() { /* ... as before ... */ }
     function manualFetch() { /* ... as before ... */ }
     window.addEventListener("load", () => { /* ... as before ... */ });

  </script>
</body>
</html>