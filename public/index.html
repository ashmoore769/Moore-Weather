<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="apple-touch-icon" href="/Weather_Station_App.png">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Rubik:wght@600&display=swap" rel="stylesheet">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Moore's LIVE Weather Data</title>
  <style>
    /* Base Styles */
    :root {
        --bg-color: #f4f4f4;
        --card-bg: #ffffff;
        --primary-text: #222; /* Slightly darker text */
        --header-bg: #00008B;
        --header-text: white;
        --button-bg: #FFA500;
        --button-text: black;
        --button-hover-bg: #e59400;
        --status-connected-bg: #006400;
        --status-connected-text: white;
        --status-connected-border: #006400;
        --status-fetching-text: #DAA520;
        --status-fetching-border: #DAA520;
        --status-error-text: #B22222;
        --status-error-border: #B22222;
        --border-color: #e0e0e0; /* Lighter border */
        --shadow-color: rgba(0, 0, 0, 0.08);
        --inset-shadow-color: rgba(0, 0, 0, 0.25);
        --outer-shadow-color: rgba(0, 0, 0, 0.2);
        --label-text: #444; /* Darker label color for contrast */
    }

    body {
      margin: 0;
      background-color: var(--bg-color);
      font-family: "Inter", "system-ui", "Segoe UI", "Helvetica Neue", Arial, sans-serif;
      font-size: 13.5px; /* Slightly larger base */
      font-weight: 400;
      line-height: 1.4; /* Base line height */
      letter-spacing: 0.1px; /* Reduced spacing */
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
      padding-top: env(safe-area-inset-top, 0);
      color: var(--primary-text);
    }

    .main-container {
      max-width: 400px;
      margin: 8px auto; /* Tighter top/bottom margin */
      padding: 0 5px;
    }

    /* --- Animations (Keep As Is) --- */
    @keyframes pulse { /* ... */ }
    .big-temp-box.updated { /* ... */ }
    @keyframes spin { /* ... */ }

    /* --- Sticky Header & Controls --- */
    .freeze-pane {
      position: sticky;
      top: env(safe-area-inset-top, 0);
      z-index: 100;
      background: var(--bg-color);
      padding-bottom: 4px; /* Add space below controls */
    }
    .header-box { /* ... Keep As Is ... */ }
    .header-box h2 { /* ... Keep As Is ... */ }
    .control-container { /* ... Keep As Is ... */ margin-top: 4px; }
    .control-half { /* ... Keep As Is ... */ }
    button { /* ... Keep As Is ... */ }
    button:hover:not(:disabled) { /* ... Keep As Is ... */ }
    button:disabled { /* ... Keep As Is ... */ }
    #status { /* ... Keep As Is ... */ }
    .status-badge { /* ... Keep As Is ... */ }
    .status-badge.waiting { /* ... Keep As Is ... */ }
    .status-badge.connected { /* ... Keep As Is ... */ }
    .status-badge.fetching { /* ... Keep As Is ... */ }
    .status-badge.error { /* ... Keep As Is ... */ }

    /* --- Spinner --- */
    .spinner-container { /* ... Keep As Is ... */ }
    .spinner { /* ... Keep As Is ... */ }

    /* --- Weather Data Container --- */
    #weatherData {
      background: var(--card-bg);
      padding: 10px 12px 12px 12px; /* Adjusted padding */
      border-radius: 12px;
      box-shadow: 0 2px 5px var(--shadow-color); /* Slightly larger shadow */
      text-align: left;
      margin-top: 0; /* Remove top margin, handled by freeze-pane padding */
      margin-bottom: 15px;
    }

    hr {
      border: none;
      border-top: 1px solid var(--border-color);
      margin: 8px 0; /* Increased margin around HR */
      clear: both;
      width: 100%;
    }

    /* --- Card Header --- */
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center; /* Vertically center items */
      margin-bottom: 8px; /* Space below header content */
    }
    .title-date-container { /* Keep as is */ }
    .address-title { /* Keep as is */ }
    .date-time { margin-top: 2px; /* Small space below address */ }
    .logo-container { /* Keep as is */ }
    .logo-container img { /* Keep as is */ }

    /* --- Grid Layout for Data Rows --- */
    /* Apply this to relevant <p> tags */
    .grid-row {
        display: grid;
        grid-template-columns: 22px auto 1fr; /* Emoji | Label | Value */
        align-items: baseline; /* Align text baselines */
        gap: 0 6px; /* Row gap 0, Column gap 6px (Emoji-Label, Label-Value) */
        margin: 3px 0; /* Vertical spacing between rows */
        line-height: 1.45; /* Slightly more line height for grid */
    }
    .grid-row .emoji {
        text-align: center; /* Center emoji in its column */
        font-size: 1.1em; /* Slightly larger emoji */
    }
    .grid-row .label {
        font-weight: 600;
        color: var(--label-text);
        white-space: nowrap; /* Prevent label wrapping */
    }
    .grid-row .value {
        text-align: left; /* Align value text to the left */
        white-space: nowrap; /* Prevent value wrapping initially */
        /* Allow specific long values to wrap if needed */
        overflow: hidden;
        text-overflow: ellipsis; /* Add ellipsis if needed */
    }
    /* Adjustments for specific sections if needed */
     .date-time .grid-row {
         grid-template-columns: 22px 35px 1fr; /* Fixed width for Date/Time label */
         gap: 0 4px; /* Tighter gap for Date/Time */
         margin: 1px 0; /* Tighter vertical space */
         line-height: 1.4;
     }
     .date-time .grid-row .label {
        /* No specific style needed now */
     }

    /* --- Main Data Column Structure --- */
    .wind-logger-container { /* Keep Flexbox for main columns */
      display: flex;
      justify-content: space-between;
      gap: 10px;
      margin: 5px 0;
    }
    .wind-column { width: 60%; }
    .logger-column { width: 40%; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .big-temp-box { /* Keep As Is */ }
    .big-temp-box span.label { /* Keep As Is */ }
    .big-temp-box + .big-temp-box { /* Keep As Is */ }

    /* Rain Container */
    .rain-container {
        margin: 8px 0 5px 0; /* Adjusted margins */
        padding: 6px 10px; /* Adjusted padding */
        border: 1px solid var(--border-color);
        border-radius: 8px;
        background: #f9f9f9;
    }
    /* Apply grid to rain rows too */
    .rain-container .grid-row {
         grid-template-columns: 22px auto 1fr; /* Consistent grid */
         margin: 2px 0; /* Tight vertical margin */
    }

    /* Two-Column Sections (Evap/Battery, Soil) */
    .evap-battery, .soil-moisture {
      display: grid; /* Use GRID for the two columns now */
      grid-template-columns: 52% 1fr; /* Define column widths */
      gap: 0 10px; /* Gap between columns */
      margin: 5px 0;
    }
    .evap-col, .battery-col, .soiltemp-col, .moisture-col {
       /* These divs are now grid *items*, width is handled by parent grid */
       /* No width style needed here */
    }
     /* Apply grid row layout within these columns */
    .evap-col .grid-row, .battery-col .grid-row,
    .soiltemp-col .grid-row, .moisture-col .grid-row {
         grid-template-columns: 22px auto 1fr; /* Consistent grid */
    }

    /* Full Width Vector Section */
    .vector-wind-section .grid-row {
         grid-template-columns: 22px auto 1fr; /* Consistent grid */
    }


    /* --- Media Queries --- */
    @media only screen and (max-width: 600px) {
      .main-container { max-width: 100%; margin: 5px auto; }
      .header-box { padding: 5px; } /* Restore some padding */
      /* Adjust grid gaps or font sizes if needed */
      .grid-row { gap: 0 4px; } /* Tighter column gap */
       .date-time .grid-row { grid-template-columns: 20px 35px 1fr; gap: 0 3px;} /* Tighter date/time */
       #weatherData { padding: 8px 10px 10px 10px; }
    }
     @media only screen and (max-width: 360px) {
         .address-title { font-size: 16px; }
         .header-box h2 { font-size: 16px; }
         body { font-size: 13px; } /* Reduce base font slightly */
         .logo-container img { height: 50px; }
         .grid-row { grid-template-columns: 20px auto 1fr; gap: 0 3px; } /* Adjust emoji col, gap */
         .date-time .grid-row { grid-template-columns: 18px 35px 1fr; gap: 0 2px;}
         .evap-battery, .soil-moisture { grid-template-columns: 50% 1fr; gap: 0 5px; } /* Adjust column split */
         .big-temp-box { width: 90px; height: 36px; font-size: 15px; } /* Shrink boxes slightly */
         .big-temp-box span.label { font-size: 10px; }
     }
  </style>
</head>
<body>
  <div class="main-container">
    <!-- Sticky Header -->
    <div class="freeze-pane">
      <div class="header-box">
        <h2>Moore's LIVE Weather Data</h2>
      </div>
      <div class="control-container">
        <div class="control-half">
          <button id="fetchBtn" onclick="manualFetch()">CURRENT READINGS</button>
        </div>
        <div class="control-half">
           <p id="status" aria-live="polite">
             <span id="statusBadge" class="status-badge waiting">‚è≥ Status: Waiting...</span>
           </p>
        </div>
      </div>
    </div>

    <!-- Weather Data Section -->
    <div id="weatherData">
      <!-- Header Section -->
      <div class="header-content">
        <div class="title-date-container">
          <div class="address-title">WEST WARWICK, QLD</div>
          <div class="date-time">
             <!-- Using grid-row class -->
            <p class="grid-row">
                <span class="emoji">üìÜ</span>
                <span class="label"><b>Date:</b></span>
                <span class="value" id="dateVal">--</span>
            </p>
            <p class="grid-row">
                <span class="emoji">‚è∞</span>
                <span class="label"><b>Time:</b></span>
                <span class="value" id="timeVal">--</span>
            </p>
          </div>
        </div>
        <div class="logo-container">
           <img src="/Weather_Station_App.png" alt="Weather Station Icon">
           <img src="/Station_Label.png" alt="Environdata Weather Maestro">
        </div>
      </div>
      <hr>

      <!-- Main Data Columns -->
      <div class="wind-logger-container">
        <div class="wind-column">
           <!-- Using grid-row class -->
           <p class="grid-row">
               <span class="emoji">üí®</span>
               <span class="label"><b>Wind Speed:</b></span>
               <span class="value" id="windSpeedVal">-- km/h</span>
           </p>
           <p class="grid-row">
               <span class="emoji">üß≠</span>
               <span class="label"><b>Wind Dir.:</b></span>
               <span class="value" id="windDirCombined">--¬∞ (--)</span>
           </p>
           <p class="grid-row">
               <span class="emoji">üí¶</span>
               <span class="label"><b>Humidity:</b></span>
               <span class="value" id="humidityCombined">--% (--)</span>
            </p>
           <p class="grid-row">
               <span class="emoji">üå°Ô∏è</span>
               <span class="label"><b>Temperature:</b></span>
               <span class="value" id="tempCombined">--¬∞C (--)</span>
           </p>
           <p class="grid-row">
               <span class="emoji">‚òÄÔ∏è</span>
               <span class="label"><b>Solar Rad.:</b></span>
               <span class="value" id="solarRadVal">-- W/m¬≤ üåô</span>
           </p>
           <p class="grid-row">
               <span class="emoji">‚ö´</span>
               <span class="label"><b>Black Globe:</b></span>
               <span class="value" id="blackGlobeTempVal">--¬∞C</span>
           </p>
           <p class="grid-row">
               <span class="emoji">üå±</span>
               <span class="label"><b>Garden Bed:</b></span>
               <span class="value" id="gardenBedTempVal">--¬∞C</span>
            </p>
           <p class="grid-row">
               <span class="emoji">üåÄ</span>
               <span class="label"><b>Pressure:</b></span>
               <span class="value" id="pressureVal">-- hPa</span>
            </p>
           <div class="rain-container">
             <p class="grid-row">
                 <span class="emoji">üåßÔ∏è</span>
                 <span class="label"><b>Rain Since 9AM:</b></span>
                 <span class="value" id="rainSince9Val">-- mm</span>
             </p>
             <p class="grid-row">
                 <span class="emoji">üíß</span>
                 <span class="label"><b>Rain / Last Min:</b></span>
                 <span class="value" id="rainInLastMinVal">-- mm</span>
            </p>
           </div>
        </div>
        <div class="logger-column">
            <!-- Big temp boxes - no changes -->
          <div class="big-temp-box" id="airTempBox">
            <span id="bigTempVal">--¬∞C</span>
            <span class="label">Air Temp</span>
          </div>
          <div class="big-temp-box" id="radiantDiffBox">
            <span id="radiantDiffVal">--¬∞C</span>
            <span class="label" aria-label="Difference between black globe and air temperature">Rad. Heat Diff</span>
          </div>
        </div>
      </div>
      <hr>
      <!-- Evaporation and Battery Section -->
      <div class="evap-battery">
        <div class="evap-col">
           <p class="grid-row">
               <span class="emoji">‚§¥Ô∏è</span>
               <span class="label"><b>Evap/Hr:</b></span>
               <span class="value" id="evapRateVal">-- mm/h</span>
            </p>
           <p class="grid-row">
               <span class="emoji">‚¨ÜÔ∏è</span>
               <span class="label"><b>Daily Evap:</b></span>
               <span class="value" id="dailyEvapVal">-- mm</span>
           </p>
           <p class="grid-row">
               <span class="emoji">üíß</span>
               <span class="label"><b>Dew Point:</b></span>
               <span class="value" id="dewPointVal">--¬∞C</span>
            </p>
           <p class="grid-row">
               <span class="emoji">üå¨Ô∏è</span>
               <span class="label"><b>Max WS Gust:</b></span>
               <span class="value" id="peakWindGustVal">-- km/h</span>
            </p>
        </div>
        <div class="battery-col">
           <p class="grid-row">
               <span class="emoji">üîã</span>
               <span class="label"><b>Battery:</b></span>
               <span class="value" id="batteryVal">-- V</span>
            </p>
           <p class="grid-row">
               <span class="emoji">‚ö°</span>
               <span class="label"><b>Load:</b></span>
               <span class="value" id="loadVal">-- mA</span>
            </p>
           <p class="grid-row">
               <span class="emoji">‚òÄÔ∏è</span>
               <span class="label"><b>Solar Panel:</b></span>
               <span class="value" id="solarPanelVal">-- V üåô</span>
            </p>
           <p class="grid-row">
               <span class="emoji">üîå</span>
               <span class="label"><b>Charge:</b></span>
               <span class="value" id="chargeVal">-- mA</span>
            </p>
        </div>
      </div>
      <hr>
      <!-- Vector Wind Section -->
      <div class="vector-wind-section">
        <p class="grid-row">
            <span class="emoji">üçÉ</span>
            <span class="label"><b>Vector Wind Spd:</b></span>
            <span class="value" id="vectorWindSpeedVal">-- km/h</span>
        </p>
        <p class="grid-row">
            <span class="emoji">üß≠</span>
            <span class="label"><b>Vector Wind Dir:</b></span>
            <span class="value" id="vectorWindDirCombined">--¬∞ (--)</span>
        </p>
      </div>
      <hr>
      <!-- Soil Section -->
      <div class="soil-moisture">
        <div class="soiltemp-col">
           <p class="grid-row">
               <span class="emoji">üå°Ô∏è</span>
               <span class="label"><b>S.Temp 10cm:</b></span>
               <span class="value" id="soilTemp10Val">--¬∞C</span>
            </p>
           <p class="grid-row">
               <span class="emoji">üå°Ô∏è</span>
               <span class="label"><b>S.Temp 20cm:</b></span>
               <span class="value" id="soilTemp20Val">--¬∞C</span>
            </p>
           <p class="grid-row">
               <span class="emoji">üå°Ô∏è</span>
               <span class="label"><b>S.Temp 30cm:</b></span>
               <span class="value" id="soilTemp30Val">--¬∞C</span>
            </p>
           <p class="grid-row">
               <span class="emoji">üå°Ô∏è</span>
               <span class="label"><b>S.Temp 40cm:</b></span>
               <span class="value" id="soilTemp40Val">--¬∞C</span>
           </p>
        </div>
        <div class="moisture-col">
           <p class="grid-row">
               <span class="emoji">üíß</span>
               <span class="label"><b>Moist. 10cm:</b></span>
               <span class="value" id="moisture10Val">--%</span>
            </p>
           <p class="grid-row">
               <span class="emoji">üíß</span>
               <span class="label"><b>Moist. 20cm:</b></span>
               <span class="value" id="moisture20Val">--%</span>
            </p>
           <p class="grid-row">
               <span class="emoji">üíß</span>
               <span class="label"><b>Moist. 30cm:</b></span>
               <span class="value" id="moisture30Val">--%</span>
            </p>
           <p class="grid-row">
               <span class="emoji">üíß</span>
               <span class="label"><b>Moist. 40cm:</b></span>
               <span class="value" id="moisture40Val">--%</span>
           </p>
        </div>
      </div>
      <hr> <!-- Extra HR at the bottom -->
    </div>

    <!-- Spinner -->
    <div id="spinnerContainer" class="spinner-container">
      <div class="spinner"></div>
    </div>
  </div>

  <script>
    // --- Helper Functions (Keep mostly as is, ensure NaNs handled) ---
    function getWindDirection(degrees) {
        const directions = ["N", "NNE", "NE", "ENE", "E", "ESE", "SE", "SSE", "S", "SSW", "SW", "WSW", "W", "WNW", "NW", "NNW"];
        if (isNaN(degrees)) return '--';
        return directions[Math.round(degrees / 22.5) % 16];
    }

    function setStatusBadge(statusText, statusClass) { /* Keep as is */
        const icons = { connected: "‚úÖ", fetching: "üîÑ", error: "‚ö†Ô∏è", waiting: "‚è≥" };
        const icon = icons[statusClass] || "";
        const badge = document.getElementById("statusBadge");
        badge.textContent = `${icon} Status: ${statusText}`;
        badge.className = 'status-badge';
        badge.classList.add(statusClass);
    }

    function formatDateString(dateStr) { /* Keep as is */
        const parts = dateStr.split("/"); // YYYY/MM/DD
        if (parts.length === 3) {
            const [year, month, day] = parts.map(Number);
            if (!isNaN(year) && !isNaN(month) && !isNaN(day) && month >= 1 && month <= 12 && day >= 1 && day <= 31) {
                try {
                    const dateObj = new Date(year, month - 1, day);
                    if (dateObj && dateObj.getFullYear() === year && dateObj.getMonth() === month - 1 && dateObj.getDate() === day) {
                        const formattedDay = String(day).padStart(2, '0');
                        const formattedMonth = String(month).padStart(2, '0');
                        const formattedDate = `${formattedDay}/${formattedMonth}/${year}`;
                        const dayNames = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
                        return `${formattedDate} (${dayNames[dateObj.getDay()]})`;
                    }
                } catch (e) { console.warn("Date parse error:", e); }
            }
        }
        return dateStr || '--';
     }

    function getTemperatureColorAndDesc(temp) { /* Keep as is */
       let color, desc;
       if (isNaN(temp)) return { color: 'inherit', desc: '--' };
       if (temp < -20) { color = "#000000"; desc = ""; }
        else if (temp < -10) { color = "#191970"; desc = "Severely cold"; }
        else if (temp < 0) { color = "#0000CD"; desc = "Extremely cold"; }
        else if (temp < 6) { color = "#4682B4"; desc = "Very cold"; }
        else if (temp < 11) { color = "#87CEEB"; desc = "Cold"; }
        else if (temp < 16) { color = "#90EE90"; desc = "Cool"; }
        else if (temp < 21) { color = "#32CD32"; desc = "Mild"; }
        else if (temp < 28) { color = "#FFD700"; desc = "Warm"; }
        else if (temp < 32) { color = "#FFA500"; desc = "Warmer"; }
        else if (temp < 36) { color = "#FF6347"; desc = "Hot"; }
        else if (temp < 41) { color = "#DC143C"; desc = "Very hot"; }
        else if (temp <= 60) { color = "#B22222"; desc = "Extremely hot"; }
        else { color = "#8B0000"; desc = ""; }
       return { color, desc };
     }

    function getHumidityDesc(humidity) { /* Keep as is */
        if (isNaN(humidity)) return '--';
        if (humidity <= 20) { return "Very Dry"; }
        else if (humidity <= 40) { return "Dry"; }
        else if (humidity <= 60) { return "Comfortable"; }
        else if (humidity <= 80) { return "Humid"; }
        else { return "Very Humid"; }
     }

    function colorMoisture(val) { /* Keep as is */
        if (isNaN(val)) return '--%';
        let display = val.toFixed(1);
        let formatted = display + '%';
        if (val < 20) { formatted = `<span style="color:#CD853F; font-weight:bold;">${display}%</span>`; } // Peru
        else if (val > 85) { formatted = `<span style="color:#1E90FF; font-weight:bold;">${display}%</span>`; } // DodgerBlue
        return formatted;
     }

    // --- Safe Data Getters (Keep as is) ---
    function safeGetLineValue(lines, index, defaultValue = NaN) { /* ... */ }
    function safeGetLineString(lines, index, defaultValue = '--') { /* ... */ }

    // --- Global State & Retries (Keep as is) ---
    let initialLoadComplete = false; /* ... */
    let refreshTimeout; /* ... */
    let retryAttempts = 0; /* ... */
    const MAX_RETRY_ATTEMPTS = 3; /* ... */
    const LONG_RETRY_DELAY = 30000; /* ... */
    const WEATHER_ENDPOINT = "/weather"; /* ... */


    // --- UPDATE FUNCTION (Revised for new structure) ---
    function updateWeatherData(data) {
        const cleanedData = data.replace(/^r3\s*/, '').replace(/\r/g, '').trim();
        const lines = cleanedData.split(",");
        console.log(`Parsed ${lines.length} fields.`);
        const EXPECTED_FIELDS = 31;
        if (lines.length < EXPECTED_FIELDS) { /* ... error handling ... */ return; }

        try {
            // Extract data using safe helpers
            const dateStr = safeGetLineString(lines, 0);
            const timeStr = safeGetLineString(lines, 1);
            const windSpeed = safeGetLineValue(lines, 2);
            const windDirDeg = safeGetLineValue(lines, 3);
            const humidityRaw = safeGetLineValue(lines, 4);
            const temperatureRaw = safeGetLineValue(lines, 5);
            const rainInLastMinRaw = safeGetLineValue(lines, 6, 0.0);
            const solarRadRaw = safeGetLineValue(lines, 7);
            const pressureRaw = safeGetLineValue(lines, 8);
            const gardenBedTemp = safeGetLineValue(lines, 9);
            const batteryVoltageVal = safeGetLineValue(lines, 10);
            const loadCurrent = safeGetLineValue(lines, 11);
            const rawSolarVoltage = safeGetLineValue(lines, 12);
            const chargeCurrent = safeGetLineValue(lines, 13);
            const peakWindGustVal = safeGetLineValue(lines, 14);
            const vectorWindSpeedVal = safeGetLineValue(lines, 15);
            const vectorWindDirVal = safeGetLineValue(lines, 16);
            const rainSince9 = safeGetLineValue(lines, 17);
            const evapRate = safeGetLineValue(lines, 18);
            const dailyEvap = safeGetLineValue(lines, 20);
            const dewPoint = safeGetLineValue(lines, 21);
            const soilTemp10 = safeGetLineValue(lines, 22);
            const soilTemp20 = safeGetLineValue(lines, 23);
            const soilTemp30 = safeGetLineValue(lines, 24);
            const soilTemp40 = safeGetLineValue(lines, 25);
            const moisture10Val = safeGetLineValue(lines, 26);
            const moisture20Val = safeGetLineValue(lines, 27);
            const moisture30Val = safeGetLineValue(lines, 28);
            const moisture40Val = safeGetLineValue(lines, 29);
            const blackGlobeTemp = safeGetLineValue(lines, 30);

            // Helper to update element content (safer)
             const updateValue = (id, content, isHTML = false) => {
                const element = document.getElementById(id);
                if (element) {
                    const finalContent = (content === null || content === undefined || (typeof content === 'number' && isNaN(content))) ? '--' : content;
                    if (isHTML) {
                        element.innerHTML = finalContent;
                    } else {
                        element.textContent = finalContent;
                    }
                } else { console.warn(`Element ${id} not found`); }
             };

            // --- Update DOM Elements ---

            // DATE & TIME
            updateValue("dateVal", formatDateString(dateStr));
            updateValue("timeVal", timeStr !== '--' ? timeStr + " AEST" : '--');

            // WIND
            updateValue("windSpeedVal", `${isNaN(windSpeed) ? '--' : windSpeed.toFixed(1)} km/h`);
            updateValue("windDirCombined", `${isNaN(windDirDeg) ? '--' : windDirDeg.toFixed(1)}¬∞ (${getWindDirection(windDirDeg)})`);

            // HUMIDITY
            updateValue("humidityCombined", `${isNaN(humidityRaw) ? '--' : humidityRaw.toFixed(1)}% (${getHumidityDesc(humidityRaw)})`);

            // TEMPERATURE
            const tempData = getTemperatureColorAndDesc(temperatureRaw);
            const tempFormatted = isNaN(temperatureRaw) ? '--¬∞C' : temperatureRaw.toFixed(1) + '¬∞C';
            updateValue("tempCombined", `<span style="color:${tempData.color}; font-weight:bold;">${tempFormatted}</span> (${tempData.desc})`, true);

             // BIG TEMP BOXES
            const bigTempElement = document.getElementById("bigTempVal");
            const bigTempContainer = document.getElementById("airTempBox");
            if (!isNaN(temperatureRaw)) {
                bigTempElement.textContent = temperatureRaw.toFixed(1) + "¬∞C";
                bigTempContainer.style.backgroundColor = tempData.color;
                bigTempElement.style.color = "#FFF";
                bigTempContainer.classList.add('updated');
                setTimeout(() => bigTempContainer.classList.remove('updated'), 300);
            } else {
                bigTempElement.textContent = '--¬∞C';
                bigTempContainer.style.backgroundColor = 'grey';
            }

            const radiantDiffElem = document.getElementById("radiantDiffVal");
            const radiantDiffBox = document.getElementById("radiantDiffBox");
            if (!isNaN(blackGlobeTemp) && !isNaN(temperatureRaw)) {
                 const radiantDiff = blackGlobeTemp - temperatureRaw;
                 const diffFormatted = (radiantDiff >= 0 ? "+" : "") + radiantDiff.toFixed(1) + "¬∞C";
                 radiantDiffElem.textContent = diffFormatted;
                 radiantDiffBox.style.backgroundColor = radiantDiff >= 0 ? "#d94a38" : "#4682B4";
                 radiantDiffElem.style.color = "white";
            } else {
                radiantDiffElem.textContent = '--¬∞C';
                radiantDiffBox.style.backgroundColor = 'grey';
            }

            // SOLAR RADIATION
            const solarRad = !isNaN(solarRadRaw) ? Math.max(0, solarRadRaw) : NaN;
            let solarRadDisplay = '-- W/m¬≤';
            let solarEmoji = '';
            if (!isNaN(solarRad)) {
                let solarRadColor = solarRad < 5 ? "#4B0082" : solarRad <= 100 ? "#6495ED" : solarRad <= 299 ? "#87CEEB" : solarRad <= 600 ? "#FFD700" : solarRad <= 800 ? "#FFA500" : solarRad <= 1100 ? "#FF6347" : "#DC143C";
                solarRadDisplay = solarRad.toFixed(1) + " W/m¬≤";
                solarEmoji = solarRad < 5 ? 'üåô' : '‚òÄÔ∏è';
                solarRadDisplay = `<span style="color:${solarRadColor}; font-weight:${solarRad >= 5 ? 'bold': 'normal'};">${solarRadDisplay}</span> ${solarEmoji}`;
            } else {
                 solarRadDisplay += ` ${solarEmoji || '?'}`; // Handle NaN case
            }
            updateValue("solarRadVal", solarRadDisplay, true);


            // BLACK GLOBE TEMP
            updateValue("blackGlobeTempVal", isNaN(blackGlobeTemp) ? '--¬∞C' : `<span style="color:${getTemperatureColorAndDesc(blackGlobeTemp).color};">${blackGlobeTemp.toFixed(1)}¬∞C</span>`, true);

            // GARDEN BED TEMP
             updateValue("gardenBedTempVal", isNaN(gardenBedTemp) ? '--¬∞C' : `<span style="color:${getTemperatureColorAndDesc(gardenBedTemp).color};">${gardenBedTemp.toFixed(1)}¬∞C</span>`, true);


            // PRESSURE
            let pressureDisplay = '-- hPa';
            if (!isNaN(pressureRaw)) {
                let adjustedPressure = pressureRaw - 1.9;
                pressureDisplay = adjustedPressure.toFixed(1) + " hPa";
                if (adjustedPressure >= 1021.5) { pressureDisplay = `<span style="color:green; font-weight:bold;">${pressureDisplay} üëç</span>`; }
                else if (adjustedPressure < 1005) { pressureDisplay = `<span style="color:#4682B4; font-weight:bold;">${pressureDisplay}</span>`; }
            }
            updateValue("pressureVal", pressureDisplay, true);

            // RAIN
            let rainSince9Display = isNaN(rainSince9) ? '-- mm' : rainSince9.toFixed(1) + " mm";
            if (!isNaN(rainSince9) && rainSince9 >= 0.2) { rainSince9Display = `<span style="color:#1E90FF; font-weight:bold;">${rainSince9Display}</span>`; }
            updateValue("rainSince9Val", rainSince9Display, true);

            let rainInLastMinDisplay = rainInLastMinRaw.toFixed(1) + " mm";
            if (rainInLastMinRaw >= 0.2) { rainInLastMinDisplay = `<span style="color:#1E90FF; font-weight:bold;">${rainInLastMinDisplay}</span>`; }
            updateValue("rainInLastMinVal", rainInLastMinDisplay, true);

            // EVAP/DEW POINT/GUST
            updateValue("evapRateVal", isNaN(evapRate) ? '-- mm/h' : evapRate.toFixed(3) + ' mm/h');
            updateValue("dailyEvapVal", isNaN(dailyEvap) ? '-- mm' : dailyEvap.toFixed(3) + ' mm');
            updateValue("dewPointVal", isNaN(dewPoint) ? '--¬∞C' : `<span style="color:${getTemperatureColorAndDesc(dewPoint).color};">${dewPoint.toFixed(1)}¬∞C</span>`, true);
            let peakWindGustDisplay = isNaN(peakWindGustVal) ? '-- km/h' : peakWindGustVal.toFixed(1) + " km/h";
            if (!isNaN(peakWindGustVal) && peakWindGustVal > 30) { peakWindGustDisplay = `<span style="color:red; font-weight:bold;">${peakWindGustDisplay}</span>`; }
            else if (!isNaN(peakWindGustVal) && peakWindGustVal > 15) { peakWindGustDisplay = `<span style="color:#FF8C00; font-weight:bold;">${peakWindGustDisplay}</span>`; }
            updateValue("peakWindGustVal", peakWindGustDisplay, true);

            // BATTERY/LOAD/SOLAR/CHARGE
            let batteryVoltageDisplay = '-- V';
            if (!isNaN(batteryVoltageVal)) { /* Battery styling logic - keep as is */
                 const batteryVoltage = batteryVoltageVal.toFixed(1);
                 let batteryStyle = "color:";
                 if (batteryVoltageVal < 12.4) { batteryStyle += "red; font-weight:bold;"; }
                 else if (batteryVoltageVal >= 13.9) { batteryStyle += "green; font-weight:bold;"; }
                 else { batteryStyle += "green;"; }
                 batteryVoltageDisplay = `<span style="${batteryStyle}">${batteryVoltage} V</span>`;
             }
            updateValue("batteryVal", batteryVoltageDisplay, true);

            updateValue("loadVal", isNaN(loadCurrent) ? '-- mA' : loadCurrent.toFixed(1) + ' mA');

            let solarPanelDisplay = '-- V';
            let solarPanelEmoji = '?';
            if (!isNaN(rawSolarVoltage) && !isNaN(batteryVoltageVal)) { /* Solar Panel logic - keep as is */
                 const effectiveSolarVoltage = (rawSolarVoltage < batteryVoltageVal || rawSolarVoltage < 1.0 ) ? 0.0 : rawSolarVoltage;
                 solarPanelDisplay = effectiveSolarVoltage.toFixed(1) + " V";
                 solarPanelEmoji = effectiveSolarVoltage <= 0.1 ? 'üåô' : '‚òÄÔ∏è';
             }
            updateValue("solarPanelVal", `${solarPanelDisplay} ${solarPanelEmoji}`);


            let chargeDisplay = '-- mA';
            if (!isNaN(chargeCurrent) && !isNaN(loadCurrent) && !isNaN(batteryVoltageVal)) { /* Charge styling logic - keep as is */
                 chargeDisplay = chargeCurrent.toFixed(1) + " mA";
                 let chargeStyle = "";
                 if (batteryVoltageVal < 13.9) { chargeStyle = chargeCurrent > loadCurrent ? "color:green; font-weight:bold;" : "color:red;"; }
                 else if (chargeCurrent > 0.1) { chargeStyle = "color:green;"; }
                 chargeDisplay = `<span style="${chargeStyle}">${chargeDisplay}</span>`;
             }
            updateValue("chargeVal", chargeDisplay, true);


            // VECTOR WIND
            updateValue("vectorWindSpeedVal", isNaN(vectorWindSpeedVal) ? '-- km/h' : vectorWindSpeedVal.toFixed(1) + ' km/h');
            updateValue("vectorWindDirCombined", `${isNaN(vectorWindDirVal) ? '--' : vectorWindDirVal.toFixed(1)}¬∞ (${getWindDirection(vectorWindDirVal)})`);

            // SOIL TEMPS
             updateValue("soilTemp10Val", isNaN(soilTemp10) ? '--¬∞C' : `<span style="color:${getTemperatureColorAndDesc(soilTemp10).color};">${soilTemp10.toFixed(1)}¬∞C</span>`, true);
             updateValue("soilTemp20Val", isNaN(soilTemp20) ? '--¬∞C' : `<span style="color:${getTemperatureColorAndDesc(soilTemp20).color};">${soilTemp20.toFixed(1)}¬∞C</span>`, true);
             updateValue("soilTemp30Val", isNaN(soilTemp30) ? '--¬∞C' : `<span style="color:${getTemperatureColorAndDesc(soilTemp30).color};">${soilTemp30.toFixed(1)}¬∞C</span>`, true);
             updateValue("soilTemp40Val", isNaN(soilTemp40) ? '--¬∞C' : `<span style="color:${getTemperatureColorAndDesc(soilTemp40).color};">${soilTemp40.toFixed(1)}¬∞C</span>`, true);


            // SOIL MOISTURE
            updateValue("moisture10Val", colorMoisture(moisture10Val), true);
            updateValue("moisture20Val", colorMoisture(moisture20Val), true);
            updateValue("moisture30Val", colorMoisture(moisture30Val), true);
            updateValue("moisture40Val", colorMoisture(moisture40Val), true);

        } catch (error) {
            console.error("Error processing weather data:", error);
            setStatusBadge("Processing Error", "error");
        }
    }

    // --- Fetch & Auto-Refresh Logic (Keep As Is) ---
    function fetchWeather() { /* ... Keep working version ... */ }
    function scheduleNextFetch() { /* ... Keep working version ... */ }
    function manualFetch() { /* ... Keep working version ... */ }
    window.addEventListener("load", () => { /* ... Keep working version ... */ });

  </script>
</body>
</html>