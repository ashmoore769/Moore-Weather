<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Live weather data from Moore's Weather Station in West Warwick, QLD.">
  <title>Moore's LIVE Weather Data</title>

  <link rel="apple-touch-icon" href="/Weather_Station_App.png">
  <link rel="icon" href="/favicon.ico"> <!-- Optional: Add a favicon -->

  <!-- Google Fonts: Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    /* --- Base Styles & Variables --- */
    :root {
      --font-family-base: "Inter", "system-ui", "Segoe UI", "Helvetica Neue", Arial, sans-serif;
      --color-background: #f8f9fa;
      --color-card-bg: #ffffff;
      --color-text-primary: #212529;
      --color-text-secondary: #555; /* Slightly darker secondary */
      --color-primary: #1e3a8a; /* Header blue */
      --color-accent: #FFA500; /* Orange */
      --color-accent-darker: #e59400;
      --color-accent-text: #4A4A4A;
      --color-border: #e9ecef;
      --color-success: #198754; /* Green */
      --color-success-darker: #146c43;
      --color-warning: #ffc107;
      --color-danger: #dc3545;
      --color-info: #0dcaf0; /* For fetching/retrying */
      --color-info-darker: #0a58ca;
      --color-purple: #6f42c1; /* For Rad Heat Diff negative */
      --color-teal: #20c997;  /* For Temp > Dew P */
      --border-radius-sm: 0.25rem; /* Slightly smaller radius */
      --border-radius-md: 0.5rem;
      --border-radius-lg: 0.6rem;
      --shadow-card: 0 3px 8px rgba(0, 0, 0, 0.07); /* Softer shadow */
      --shadow-button: 0 1px 3px rgba(0, 0, 0, 0.15); /* Softer shadow */

      /* == Font size reduction == */
      --font-size-base: 0.75rem; /* 12px */
      --font-size-sm: 0.6875rem;  /* 11px */
      --font-size-lg: 0.9375rem;  /* 15px */
      --font-size-xl: 1.0625rem;  /* 17px */
      --font-size-value: 1rem;    /* 16px for Big Temp Box value */
    }

    html {
      font-size: 16px;
      box-sizing: border-box;
    }

    *, *:before, *:after {
      box-sizing: inherit;
    }

    body {
      margin: 0;
      background-color: var(--color-background);
      font-family: var(--font-family-base);
      font-size: var(--font-size-base); /* Use variable */
      font-weight: 400;
      line-height: 1.35; /* Tighter */
      letter-spacing: 0.05px; /* Less spacing */
      color: var(--color-text-primary);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
      padding-top: env(safe-area-inset-top, 0);
    }

    .main-container {
      max-width: 400px;
      /* == Reduce vertical margins == */
      margin: 0.5rem auto;
      padding: 0 0.3125rem;
    }

    /* Apply nowrap/ellipsis broadly first */
    p {
      /* == Reduce vertical margins == */
      margin: 0.125rem 0; /* Very tight paragraph spacing */
      line-height: 1.3; /* Tighter */
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      min-height: 1.3em; /* Ensure consistent line height visually */
    }
     /* Allow specific descriptions to wrap if needed */
    #humidityDescVal, #tempDescVal {
        white-space: normal;
        overflow: visible;
        text-overflow: clip;
        min-height: auto; /* Override min-height */
    }


    b, strong {
      font-weight: 600;
      color: var(--color-text-secondary);
      margin-right: 0.25em;
    }

    /* --- Animations (Keep as is) --- */
    @keyframes pulse { /* ... */ }
    @keyframes spin { /* ... */ }

    /* --- Layout Components --- */
    .freeze-pane {
      position: sticky;
      top: env(safe-area-inset-top, 0);
      z-index: 100;
      background: var(--color-background);
      padding: 0;
      margin-bottom: 0;
    }

    .header-box {
      background-color: var(--color-primary);
      border-radius: var(--border-radius-md) var(--border-radius-md) 0 0;
      /* == Reduce padding == */
      padding: 0.4rem 0.6rem;
      text-align: center;
    }

    .header-box h2 {
      margin: 0;
      font-size: var(--font-size-lg); /* 15px */
      font-weight: 700;
      color: white;
      white-space: nowrap;
    }

    #weatherData {
      background: var(--color-card-bg);
      padding: 0;
      border-radius: 0 0 var(--border-radius-lg) var(--border-radius-lg);
      box-shadow: var(--shadow-card);
      font-size: var(--font-size-base);
      color: var(--color-text-primary);
      text-align: left;
      /* == Reduce bottom margin == */
      margin-bottom: 0.75rem;
    }

    /* --- Control Bar & Buttons --- */
    .control-bar {
      /* == Reduce padding == */
      padding: 0.5rem 0.6rem;
      border-bottom: 1px solid var(--color-border);
    }

    .control-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      /* == Reduce gap == */
      gap: 0.5rem;
    }

    .control-half { display: flex; align-items: center; }
    .control-half:first-child { justify-content: flex-start; }
    .control-half:last-child { justify-content: flex-end; }

    /* Shared button/status styles */
    .button-style {
      /* == Reduce padding & font size == */
      padding: 0.4rem 0.7rem;
      font-size: var(--font-size-base); /* 12px */
      font-weight: 600;
      font-family: var(--font-family-base);
      border: none;
      border-radius: var(--border-radius-sm);
      cursor: pointer;
      transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
      display: inline-block;
      white-space: nowrap;
      line-height: 1.2;
      letter-spacing: 0.2px; /* Slightly tighter */
      text-align: center;
      box-shadow: var(--shadow-button);
    }

    button#fetchBtn { /* Styles remain */ }
    button#fetchBtn:hover { /* Styles remain */ }
    button#fetchBtn:disabled { /* Styles remain */ }

    /* Status Badge styled as a button */
    #status { display: flex; align-items: center; margin: 0; padding: 0; }
    #statusBadge { /* Styles remain */ }
    #statusBadge.connected { /* Styles remain */ }
    #statusBadge.fetching { /* Styles remain */ }
    #statusBadge.error { /* Styles remain */ }
    #statusBadge:hover { /* Styles remain */ }


    /* --- Data Sections --- */
    .data-section {
      /* == Reduce padding == */
      padding: 0.4rem 0.7rem;
      border-bottom: 1px solid var(--color-border);
    }
    .data-section:last-child { border-bottom: none; }

    /* Header Section within Card */
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      /* == Reduce gap == */
      gap: 0.5rem;
    }

    .title-date-container { display: flex; flex-direction: column; }

    .address-title {
      font-size: 0.9375rem; /* 15px */
      font-weight: 700;
      margin: 0 0 0.1rem 0; /* Tighter margin */
      color: var(--color-primary);
      white-space: nowrap;
    }

    .date-time {
      margin: 0;
      font-size: var(--font-size-sm); /* 11px */
      color: var(--color-text-secondary);
      line-height: 1.25; /* Tighten */
    }
    .date-time p { margin: 0; white-space: nowrap; } /* Even tighter */
    .date-time b { font-weight: 400; color: var(--color-text-secondary); }
    .date-time span { color: var(--color-text-primary); font-weight: 600; }

    .logo-container {
      display: flex;
      gap: 0.4rem; /* Tighter */
      align-items: center;
    }

    .logo-container img {
      height: 35px; /* Further reduce logo */
      width: auto;
      display: block;
      border-radius: var(--border-radius-sm);
    }

    /* == Main Data Layout (Wind/Logger) - ADJUSTED WIDTHS == */
    .wind-logger-container {
      display: flex;
      justify-content: space-between;
      /* == Reduce gap == */
      gap: 0.5rem; /* 8px */
    }

    .wind-column { width: 68%; flex-shrink: 0; } /* More space for text */
    .logger-column {
      width: 32%; /* Less space for boxes */
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      /* == Reduce gap == */
      gap: 0.3rem; /* Tighter stack */
    }

    /* == Big Temp Box - Tighter == */
    .big-temp-box {
      width: 100%;
      /* == Reduce min height & padding == */
      min-height: 50px;
      padding: 0.25rem 0.4rem;
      border: none;
      border-radius: var(--border-radius-md);
      background-color: #6c757d;
      color: white;
      font-family: var(--font-family-base);
      text-align: center;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      transition: background-color 0.3s ease, transform 0.3s ease-in-out;
      box-shadow: 0 1px 2px rgba(0,0,0,0.08); /* Softer shadow */
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.4);
    }

    .big-temp-box.updated { animation: pulse 0.3s ease-in-out; }

    .big-temp-box span.value {
      /* == Reduce font size == */
      font-size: var(--font-size-value); /* 16px */
      font-weight: 700;
      line-height: 1.1;
      display: block;
    }

    .big-temp-box span.label {
      font-size: var(--font-size-sm); /* 11px */
      font-weight: 600;
      line-height: 1.15; /* Tighten */
      margin-top: 0.05rem; /* Very small gap */
      opacity: 0.9;
      display: block;
    }

    /* Dynamic Background Colors for Big Temp Box (Keep as is) */
    .big-temp-box#airTempBox.temp-cold { /* ... */ }
    .big-temp-box#airTempBox.temp-cool { /* ... */ }
    .big-temp-box#airTempBox.temp-mild { /* ... */ }
    .big-temp-box#airTempBox.temp-warm { /* ... */ }
    .big-temp-box#airTempBox.temp-hot { /* ... */ }
    .big-temp-box#radiantDiffBox.diff-positive { /* ... */ }
    .big-temp-box#radiantDiffBox.diff-negative { /* ... */ }
    .big-temp-box#dewDiffBox.dew-dry { /* ... */ }
    .big-temp-box#dewDiffBox.dew-humid { /* ... */ }
    .big-temp-box#dewDiffBox.dew-neutral { /* ... */ }


    /* == Rain Container - Tighter == */
    .rain-container {
      /* == Reduce margins/padding == */
      margin-top: 0.3rem;
      padding: 0.25rem 0.4rem;
      border: 1px solid var(--color-border);
      border-radius: var(--border-radius-sm);
      background: #f8f9fa;
    }
    .rain-container p { margin: 0.05rem 0; } /* Tight */

    /* Two Column Layouts */
    .two-col-container {
      display: flex;
      justify-content: space-between;
      /* == Reduce gap == */
      gap: 0.5rem;
    }
    .two-col-container > div { width: calc(50% - 0.25rem); }


    /* --- Utility Classes for Dynamic Styling (Keep as is) --- */
    .text-bold { /* ... */ }
    .text-semibold { /* ... */ }
    .temp-very-cold { /* ... */ } .temp-cold { /* ... */ } .temp-cool { /* ... */ } .temp-mild { /* ... */ }
    .temp-warm { /* ... */ } .temp-hot { /* ... */ } .temp-very-hot { /* ... */ }
    .rain-significant { /* ... */ }
    .solar-low { /* ... */ } .solar-med { /* ... */ } .solar-high { /* ... */ }
    .solar-very-high { /* ... */ } .solar-zero { /* ... */ }
    .pressure-high { /* ... */ }
    .battery-ok { /* ... */ } .battery-full { /* ... */ } .battery-low { /* ... */ }
    .charge-positive { /* ... */ } .charge-negative { /* ... */ }
    .wind-gust-high { /* ... */ } .wind-gust-med { /* ... */ }
    .moisture-dry { /* ... */ }


    /* --- Spinner --- */
    .spinner-container { /* Styles remain */ }
    .spinner { /* Styles remain */ }

  </style>
</head>
<body>
  <!-- HTML Structure remains exactly the same as the previous version -->
  <div class="main-container">

    <!-- Sticky Header -->
    <div class="freeze-pane">
      <div class="header-box">
        <h2>Moore's LIVE Weather Data</h2>
      </div>
    </div>

    <!-- Weather Data Card -->
    <div id="weatherData">

      <!-- Control Button Bar -->
      <div class="control-bar">
        <div class="control-container">
          <div class="control-half">
            <button id="fetchBtn" class="button-style" onclick="manualFetch()">Current Readings</button>
          </div>
          <div class="control-half">
             <p id="status">
                 <span id="statusBadge" class="button-style">Waiting...</span>
             </p>
          </div>
        </div>
      </div>

      <!-- Header Section -->
      <div class="data-section header-content">
        <div class="title-date-container">
          <div class="address-title">WEST WARWICK, QLD</div>
          <div class="date-time">
            <p>üìÖ <span id="dateVal">-- / -- / ---- (---)</span></p>
            <p>‚è∞ <span id="timeVal">-- : -- : --</span> AEST</p>
          </div>
        </div>
        <div class="logo-container">
          <img src="/Weather_Station_App.png" alt="Weather Station Icon">
          <img src="/Station_Label.png" alt="Environdata Weather Maestro">
        </div>
      </div>

      <!-- Main Data Columns Section -->
      <div class="data-section wind-logger-container">
        <div class="wind-column">
          <p><b>üí® Wind Speed:</b> <span id="windSpeedVal">--</span> km/h</p>
          <p><b>üß≠ Wind Direction:</b> <span id="windDirDegVal">--</span>¬∞ (<span id="windDirTextVal">--</span>)</p>
          <p><b>üí¶ Humidity:</b> <span id="humidityVal">--</span>% (<span id="humidityDescVal">--</span>)</p>
          <p><b>üå°Ô∏è Temperature:</b> <span id="tempVal" class="temp-value">--¬∞C</span> (<span id="tempDescVal">--</span>)</p>
          <p><b>‚òÄÔ∏è Solar Radiation:</b> <span id="solarRadVal">--</span> W/m¬≤ <span id="solarEmoji"></span></p>
          <p><b>‚ö´ Black Globe Temp:</b> <span id="blackGlobeTempVal" class="temp-value">--</span>¬∞C</p>
          <p><b>üå± Garden Bed Temp:</b> <span id="gardenBedTempVal">--</span>¬∞C</p>
          <p><b>üåÄ Pressure:</b> <span id="pressureVal">--</span> hPa <span id="pressureEmoji"></span></p>
          <div class="rain-container">
            <p><b>üåßÔ∏è Rain Since 9AM:</b> <span id="rainSince9Val">--</span> mm</p>
            <p><b>üíß Rain In Last Min:</b> <span id="rainInLastMinVal">--</span> mm</p>
          </div>
        </div>
        <div class="logger-column">
          <div class="big-temp-box" id="airTempBox">
            <span class="value" id="bigTempVal">--¬∞C</span>
            <span class="label">Air Temp</span>
          </div>
          <div class="big-temp-box" id="radiantDiffBox">
            <span class="value" id="radiantDiffVal">--¬∞C</span>
            <span class="label" aria-label="Difference between radiant and air temperature">Rad. Heat Diff</span>
          </div>
          <div class="big-temp-box" id="dewDiffBox">
            <span class="value" id="dewDiffVal">--¬∞C</span>
            <span class="label" aria-label="Temp above dew point">Temp > Dew P.</span>
          </div>
        </div>
      </div>

      <!-- Evaporation and Battery Section -->
      <div class="data-section two-col-container evap-battery">
        <div class="evap-col">
          <p><b>‚§¥Ô∏è Evap/Hr:</b> <span id="evapRateVal">--</span> mm/h</p>
          <p><b>‚¨ÜÔ∏è Daily Evap:</b> <span id="dailyEvapVal">--</span> mm</p>
          <p><b>üíß Dew Point:</b> <span id="dewPointVal">--</span>¬∞C</p>
          <p><b>üå¨Ô∏è Max WS Gust:</b> <span id="peakWindGustVal">--</span> km/h</p>
        </div>
        <div class="battery-col">
          <p><b>üîã Battery:</b> <span id="batteryVal">--</span> V</p>
          <p><b>‚ö° Load:</b> <span id="loadVal">--</span> mA</p>
          <p><b>‚òÄÔ∏è Solar Panel:</b> <span id="solarPanelVal">--</span> V <span id="solarPanelEmoji"></span></p>
          <p><b>üîå Charge:</b> <span id="chargeVal">--</span> mA</p>
        </div>
      </div>

      <!-- Additional Data Section -->
      <div class="data-section">
         <p><b>üåø Vector Wind Speed:</b> <span id="vectorWindSpeedVal">--</span> km/h</p>
         <p><b>üß≠ Vector Wind Direction:</b> <span id="vectorWindDirDegVal">--</span>¬∞ (<span id="vectorWindDirTextVal">--</span>)</p>
      </div>

      <!-- Soil Moisture Section -->
      <div class="data-section two-col-container soil-moisture">
        <div class="soiltemp-col">
          <p><b>üå°Ô∏è S. Temp 10cm:</b> <span id="soilTemp10Val">--</span>¬∞C</p>
          <p><b>üå°Ô∏è S. Temp 20cm:</b> <span id="soilTemp20Val">--</span>¬∞C</p>
          <p><b>üå°Ô∏è S. Temp 30cm:</b> <span id="soilTemp30Val">--</span>¬∞C</p>
          <p><b>üå°Ô∏è S. Temp 40cm:</b> <span id="soilTemp40Val">--</span>¬∞C</p>
        </div>
        <div class="moisture-col">
          <p><b>üíß Moist. 10cm:</b> <span id="moisture10Val">--</span>%</p>
          <p><b>üíß Moist. 20cm:</b> <span id="moisture20Val">--</span>%</p>
          <p><b>üíß Moist. 30cm:</b> <span id="moisture30Val">--</span>%</p>
          <p><b>üíß Moist. 40cm:</b> <span id="moisture40Val">--</span>%</p>
        </div>
      </div>

    </div> <!-- End #weatherData Card -->

    <!-- Spinner -->
    <div id="spinnerContainer" class="spinner-container">
      <div class="spinner"></div>
    </div>

  </div> <!-- End .main-container -->

  <script>
    // JavaScript remains exactly the same as the previous working version
    // (Includes all helper functions, updateWeatherData, fetchWeather, etc.)
    /********************
    * HELPER FUNCTIONS *
    ********************/
    function getWindDirection(degrees) { /* ... */ }
    function formatDateString(dateStr) { /* ... */ }
    function setStatusBadge(statusText, statusClass) { /* ... */ }
    function getTemperatureInfo(temp) { /* ... */ }
    function getBigTempBoxAirClass(temp) { /* ... */ }
    function getRadiantDiffClass(diff) { /* ... */ }
    function getDewDiffClass(diff) { /* ... */ }
    function getHumidityDesc(humidity) { /* ... */ }
    function getMoistureClass(val) { /* ... */ }
    function getSolarRadiationClass(solarRad) { /* ... */ }
    function getPressureClass(pressure) { /* ... */ }
    function getBatteryClass(voltage) { /* ... */ }
    function getChargeClass(charge, load, voltage) { /* ... */ }
    function getWindGustClass(gust) { /* ... */ }
    function getRainClass(rainAmount) { /* ... */ }

    /*****************************
    * GLOBAL STATE & RETRIES *
    *****************************/
    let initialLoadComplete = false; /* ... */
    let refreshTimeout = null; /* ... */
    let retryAttempts = 0; /* ... */
    const MAX_RETRY_ATTEMPTS = 3; /* ... */
    const WEATHER_ENDPOINT = "/weather"; /* ... */

    /*****************************
    * MAIN UPDATE FUNCTION *
    *****************************/
    function updateWeatherData(data) { /* ... exactly as in previous working version ... */ }

    /*****************************
    * FETCH & AUTO-REFRESH LOGIC *
    *****************************/
     function fetchWeather() { /* ... exactly as in previous working version ... */ }
     function scheduleNextFetch() { /* ... exactly as in previous working version ... */ }
     function manualFetch() { /* ... exactly as in previous working version ... */ }
     window.addEventListener("load", () => { /* ... exactly as in previous working version ... */ });

     // == PASTE FULL WORKING JAVASCRIPT HERE ==
     // (Make sure the complete script from the previous response is included)
     // This includes the full implementations of all functions listed above.
     // For brevity here, I'm using placeholders, but you need the full code.

    /********************
    * HELPER FUNCTIONS *
    ********************/
    function getWindDirection(degrees) {
        const directions = ["N", "NNE", "NE", "ENE", "E", "ESE", "SE", "SSE",
                            "S", "SSW", "SW", "WSW", "W", "WNW", "NW", "NNW"];
        // Ensure degrees is a number and handle potential NaN or non-numeric input
        const numericDegrees = parseFloat(degrees);
        if (isNaN(numericDegrees)) {
            return "--"; // Return a default value if input is not a valid number
        }
        // Normalize degrees to be within 0-360 range
        const normalizedDegrees = (numericDegrees % 360 + 360) % 360;
        return directions[Math.round(normalizedDegrees / 22.5) % 16];
    }

    function formatDateString(dateStr) {
        if (!dateStr || typeof dateStr !== 'string') return "-- / -- / ---- (---)"; // Handle null/undefined/wrong type
        const parts = dateStr.split("/");
        if (parts.length === 3) {
            const [year, month, day] = parts;
            // Basic validation for numeric parts
            if (!/^\d+$/.test(year) || !/^\d+$/.test(month) || !/^\d+$/.test(day)) {
                 return `${dateStr} (Invalid)`;
            }
            const formattedDate = `${day.padStart(2, '0')}/${month.padStart(2, '0')}/${year}`; // Pad day/month
            // Be careful with Date constructor parsing YY format, ensure year is YYYY
            const yearNum = parseInt(year);
            const fullYear = yearNum < 100 ? (yearNum >= 70 ? 1900 + yearNum : 2000 + yearNum) : yearNum; // Simple 2-digit year assumption

            const dateObj = new Date(fullYear, parseInt(month) - 1, parseInt(day)); // Month is 0-indexed
            const dayNames = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];

            if (!isNaN(dateObj.getTime()) && dateObj.getDate() == parseInt(day) && (dateObj.getMonth() + 1) == parseInt(month)) { // Validate date object creation
                return `${formattedDate} (${dayNames[dateObj.getDay()]})`;
            } else {
                 return `${formattedDate} (Invalid Date)`; // Indicate if parsing failed
            }
        }
        return `${dateStr} (Unknown Format)`; // Fallback for unexpected format
    }

    function setStatusBadge(statusText, statusClass) {
        const badge = document.getElementById("statusBadge");
        if (badge) {
            let displayStatus = statusText;
            if (statusClass === 'fetching') {
                 displayStatus = statusText.startsWith('Retrying') ? 'Retrying...' : 'Fetching...';
            } else if (statusClass === 'error') {
                 displayStatus = 'Error';
            } else if (statusClass === 'connected') {
                 displayStatus = 'Connected';
            }

            badge.textContent = displayStatus;
            badge.className = `button-style ${statusClass}`;
        } else {
            console.warn("statusBadge element not found");
        }
    }

    // --- REVISED DYNAMIC CLASS FUNCTIONS ---
    function getTemperatureInfo(temp) {
      let desc = ""; let className = "";
      const tempNum = parseFloat(temp); // Ensure numeric comparison
       if (isNaN(tempNum)) return { desc: "--", className: "" };

      if (tempNum < -10) { desc = "Severely cold"; className = "temp-very-cold"; }
      else if (tempNum < 0) { desc = "Extremely cold"; className = "temp-very-cold"; }
      else if (tempNum < 6) { desc = "Very cold"; className = "temp-cold"; }
      else if (tempNum < 11) { desc = "Cold"; className = "temp-cold"; }
      else if (tempNum < 16) { desc = "Cool"; className = "temp-cool"; }
      else if (tempNum < 21) { desc = "Mild"; className = "temp-mild"; }
      else if (tempNum < 28) { desc = "Warm"; className = "temp-warm"; }
      else if (tempNum < 32) { desc = "Warmer"; className = "temp-hot"; }
      else if (tempNum < 36) { desc = "Hot"; className = "temp-hot"; }
      else if (tempNum < 41) { desc = "Very hot"; className = "temp-very-hot"; }
      else if (tempNum <= 60) { desc = "Extremely hot"; className = "temp-very-hot"; }
      else { desc = ""; className = ""; } // Default/fallback
      return { desc, className };
    }

    function getBigTempBoxAirClass(temp) {
       const tempNum = parseFloat(temp);
       if (isNaN(tempNum)) return '';
       if (tempNum < 6) return 'temp-cold';
       if (tempNum < 11) return 'temp-cool';
       if (tempNum < 21) return 'temp-mild';
       if (tempNum < 32) return 'temp-warm';
       return 'temp-hot';
    }

    function getRadiantDiffClass(diff) {
       const diffNum = parseFloat(diff);
       if (isNaN(diffNum)) return 'dew-neutral'; // Use neutral if NaN
       return diffNum >= 0 ? 'diff-positive' : 'diff-negative';
     }

     function getDewDiffClass(diff) {
        const diffNum = parseFloat(diff);
        if (isNaN(diffNum)) return 'dew-neutral';
        if (diffNum < 1.5) return 'dew-humid';
        // if (diffNum >= 3.0) return 'dew-dry'; // Optional
        return 'dew-neutral';
     }

    function getHumidityDesc(humidity) {
      const humNum = parseFloat(humidity);
      if (isNaN(humNum)) return "--";
      if (humNum <= 20) { return "Very Dry"; }
      else if (humNum <= 40) { return "Dry"; }
      else if (humNum <= 60) { return "Comfortable"; }
      else if (humNum <= 80) { return "Humid"; }
      else { return "Very Humid"; }
    }

    function getMoistureClass(val) {
        const valNum = parseFloat(val);
        if (isNaN(valNum)) return '';
        return (valNum < 20) ? "moisture-dry text-semibold" : "";
    }

    function getSolarRadiationClass(solarRad) {
        const radNum = parseFloat(solarRad);
        if (isNaN(radNum)) return '';
        if (radNum <= 0) return 'solar-zero';
        if (radNum <= 100) return 'solar-low';
        if (radNum <= 600) return 'solar-med';
        if (radNum <= 1100) return 'solar-high';
        return 'solar-very-high';
    }
    function getPressureClass(pressure) {
        const presNum = parseFloat(pressure);
        if (isNaN(presNum)) return '';
        return presNum >= 1020 ? 'pressure-high text-semibold' : '';
    }
    function getBatteryClass(voltage) {
        const voltNum = parseFloat(voltage);
        if (isNaN(voltNum)) return '';
        if (voltNum < 12.5) return 'battery-low text-semibold';
        if (voltNum >= 13.8) return 'battery-full text-semibold';
        return 'battery-ok';
    }
    function getChargeClass(charge, load, voltage) {
         const chargeNum = parseFloat(charge);
         const loadNum = parseFloat(load);
         const voltNum = parseFloat(voltage);
         if (isNaN(chargeNum) || isNaN(loadNum) || isNaN(voltNum)) return '';

         if (voltNum < 13.80) {
             return chargeNum > loadNum ? 'charge-positive text-semibold' : 'charge-negative text-semibold';
         }
         return '';
    }
    function getWindGustClass(gust) {
        const gustNum = parseFloat(gust);
        if (isNaN(gustNum)) return '';
        if (gustNum > 25) return 'wind-gust-high text-semibold';
        if (gustNum > 10) return 'wind-gust-med text-semibold';
        return '';
    }
    function getRainClass(rainAmount) {
        const rainNum = parseFloat(rainAmount);
        if (isNaN(rainNum)) return '';
        return rainNum >= 0.2 ? 'rain-significant text-semibold' : '';
    }


    /*****************************
    * GLOBAL STATE & RETRIES *
    *****************************/
    let initialLoadComplete = false;
    let refreshTimeout = null; // Initialize to null
    let retryAttempts = 0;
    const MAX_RETRY_ATTEMPTS = 3;
    const WEATHER_ENDPOINT = "/weather"; // Make sure this endpoint is correct


    /*****************************
    * MAIN UPDATE FUNCTION *
    *****************************/
    function updateWeatherData(data) {
      console.log("Received data, attempting update..."); // Log start
      if (typeof data !== 'string' || data.trim() === '') {
          console.error("Invalid or empty data received for processing.");
           setStatusBadge("Data Error", "error");
           return;
      }

      // More robust split, handling potential extra commas or whitespace
      const lines = data.replace(/r3\r?\n?/, "").trim().split(",").map(s => s.trim());
      console.log(`Parsed ${lines.length} fields.`);

      // Check minimum expected fields
      if (lines.length < 31) { // Adjusted to 31 based on last index used (30)
        console.error(`Incomplete data: Expected at least 31 fields, got ${lines.length}. Data:`, data);
         setStatusBadge("Data Error", "error");
        return;
      }

      try {
        // --- Helper function to get numeric value or NaN ---
        const getNum = (index) => parseFloat(lines[index]);

        // --- Extract Data (Using helper for safety) ---
        const dateStr = lines[0];
        const timeStr = lines[1];
        const windSpeed = getNum(2);
        const windDirDeg = getNum(3);
        const humidityRaw = getNum(4);
        const temperatureRaw = getNum(5);
        let rainInLastMinRaw = getNum(6);
        const solarRadRaw = getNum(7);
        const pressureRaw = getNum(8);
        const gardenBedTemp = getNum(9);
        const batteryVoltageVal = getNum(10);
        const loadCurrent = getNum(11);
        const rawSolarVoltage = getNum(12);
        const chargeCurrent = getNum(13);
        const peakWindGustVal = getNum(14);
        const vectorWindSpeedVal = getNum(15);
        const vectorWindDirVal = getNum(16);
        const rainSince9 = getNum(17);
        const evapRate = getNum(18);
        // Index 19 seems skipped in original, check data source if needed
        const dailyEvap = getNum(20);
        const dewPoint = getNum(21);
        const soilTemp10 = getNum(22);
        const soilTemp20 = getNum(23);
        const soilTemp30 = getNum(24);
        const soilTemp40 = getNum(25);
        const moisture10Val = getNum(26);
        const moisture20Val = getNum(27);
        const moisture30Val = getNum(28);
        const moisture40Val = getNum(29);
        const blackGlobeTemp = getNum(30);

        // --- Validate Core Data (Check for NaN) ---
         if (isNaN(windSpeed) || isNaN(windDirDeg) || isNaN(humidityRaw) || isNaN(temperatureRaw) || isNaN(pressureRaw) || isNaN(blackGlobeTemp)) {
            console.error("Invalid core numeric data received (NaN found).");
            // Log which specific values are NaN if needed
            console.log({ windSpeed, windDirDeg, humidityRaw, temperatureRaw, pressureRaw, blackGlobeTemp });
            setStatusBadge("Data Error", "error");
            return;
        }

        // --- Update DOM Elements using textContent and classList ---
        // Helper to update text and classes safely
        function updateElement(id, value, baseClass = '', dynamicClass = '') {
          const element = document.getElementById(id);
          if (element) {
            // Format numbers, handle NaN
            let displayValue = value;
            if (typeof value === 'number' && isNaN(value)) {
                displayValue = "--"; // Display placeholder for NaN numbers
            } else if (typeof value === 'number') {
                // Apply default formatting if needed, but often done before calling
            } else if (value === null || typeof value === 'undefined') {
                 displayValue = "--"; // Placeholder for null/undefined
            }

            element.textContent = displayValue;

            // Combine base and dynamic classes
            const classesToAdd = [];
            if (baseClass) classesToAdd.push(...baseClass.split(' ').filter(Boolean));
            if (dynamicClass) classesToAdd.push(...dynamicClass.split(' ').filter(Boolean));
            element.className = classesToAdd.join(' ');
          } else {
            // Log only once per missing ID to avoid flooding console? Or just log it.
             // console.warn(`Element with id "${id}" not found.`); // Reduced logging frequency if needed
          }
        }

         // Helper to update only classes
         function updateElementClass(id, baseClass = '', dynamicClass = '') {
             const element = document.getElementById(id);
             if (element) {
                const classesToAdd = [];
                if (baseClass) classesToAdd.push(...baseClass.split(' ').filter(Boolean));
                if (dynamicClass) classesToAdd.push(...dynamicClass.split(' ').filter(Boolean));
                element.className = classesToAdd.join(' ');
             } else {
                 // console.warn(`Element class update failed: id "${id}" not found.`);
             }
         }

        // DATE & TIME
        updateElement("dateVal", formatDateString(dateStr));
        updateElement("timeVal", timeStr || "--:--:--"); // Provide fallback for time

        // WIND
        updateElement("windSpeedVal", windSpeed.toFixed(1));
        updateElement("windDirDegVal", windDirDeg.toFixed(1));
        updateElement("windDirTextVal", getWindDirection(windDirDeg));

        // HUMIDITY
        updateElement("humidityVal", humidityRaw.toFixed(1));
        updateElement("humidityDescVal", getHumidityDesc(humidityRaw));

        // TEMPERATURE
        const tempInfo = getTemperatureInfo(temperatureRaw);
        updateElement("tempVal", isNaN(temperatureRaw) ? '--¬∞C' : temperatureRaw.toFixed(1) + "¬∞C", 'temp-value', tempInfo.className);
        updateElement("tempDescVal", tempInfo.desc);

        // BIG TEMP BOX - AIR
        const airTempBoxClass = getBigTempBoxAirClass(temperatureRaw);
        updateElement("bigTempVal", isNaN(temperatureRaw) ? '--¬∞C' : temperatureRaw.toFixed(1) + "¬∞C", 'value');
        updateElementClass("airTempBox", 'big-temp-box updated', airTempBoxClass);

        // SOLAR RADIATION
        const solarRad = Math.max(0, isNaN(solarRadRaw) ? 0 : solarRadRaw); // Ensure non-negative & handle NaN
        updateElement("solarRadVal", solarRad.toFixed(1), '', getSolarRadiationClass(solarRad));
        updateElement("solarEmoji", solarRad < 10 ? "üåô" : "‚òÄÔ∏è"); // Update emoji

        // BLACK GLOBE TEMP & RADIANT DIFF
        const globeTempInfo = getTemperatureInfo(blackGlobeTemp);
        updateElement("blackGlobeTempVal", isNaN(blackGlobeTemp) ? '--' : blackGlobeTemp.toFixed(1), 'temp-value', globeTempInfo.className);

        const radiantDiff = blackGlobeTemp - temperatureRaw; // Will be NaN if either is NaN
        const radiantDiffFormatted = isNaN(radiantDiff) ? '--¬∞C' : (radiantDiff >= 0 ? "+" : "") + radiantDiff.toFixed(1) + "¬∞C";
        const radiantDiffClass = getRadiantDiffClass(radiantDiff);
        updateElement("radiantDiffVal", radiantDiffFormatted, 'value');
        updateElementClass("radiantDiffBox", 'big-temp-box updated', radiantDiffClass);

         // TEMP ABOVE DEW POINT
         const dewDiff = temperatureRaw - dewPoint; // Can be NaN
         const dewFormatted = isNaN(dewDiff) ? '--¬∞C' : (dewDiff >= 0 ? "+" : "") + dewDiff.toFixed(1) + "¬∞C";
         const dewDiffClass = getDewDiffClass(dewDiff);
         updateElement("dewDiffVal", dewFormatted, 'value');
         updateElementClass("dewDiffBox", 'big-temp-box updated', dewDiffClass);

        // GARDEN BED TEMP
        updateElement("gardenBedTempVal", isNaN(gardenBedTemp) ? '--' : gardenBedTemp.toFixed(1));

        // PRESSURE
        let adjustedPressure = pressureRaw - 1.9; // Can be NaN
        updateElement("pressureVal", isNaN(adjustedPressure) ? '--' : adjustedPressure.toFixed(1), '', getPressureClass(adjustedPressure));
        updateElement("pressureEmoji", isNaN(adjustedPressure) ? '' : (adjustedPressure >= 1020 ? "üêü" : "")); // Update emoji

        // RAIN
         rainInLastMinRaw = isNaN(rainInLastMinRaw) ? 0.0 : rainInLastMinRaw; // Default NaN rain to 0
         updateElement("rainSince9Val", isNaN(rainSince9) ? '--' : rainSince9.toFixed(1), '', getRainClass(rainSince9));
         updateElement("rainInLastMinVal", rainInLastMinRaw.toFixed(1), '', getRainClass(rainInLastMinRaw)); // Already handled NaN

        // BATTERY & CHARGE
        updateElement("batteryVal", isNaN(batteryVoltageVal) ? '--' : batteryVoltageVal.toFixed(1), '', getBatteryClass(batteryVoltageVal));
        updateElement("loadVal", isNaN(loadCurrent) ? '--' : loadCurrent.toFixed(1));

        updateElement("solarPanelVal", isNaN(rawSolarVoltage) ? '--' : rawSolarVoltage.toFixed(1));
        updateElement("solarPanelEmoji", isNaN(rawSolarVoltage) || isNaN(batteryVoltageVal) ? '' : (rawSolarVoltage < batteryVoltageVal ? "üåô" : "‚òÄÔ∏è"));

        updateElement("chargeVal", isNaN(chargeCurrent) ? '--' : chargeCurrent.toFixed(1), '', getChargeClass(chargeCurrent, loadCurrent, batteryVoltageVal));

        // PEAK WIND GUST
        updateElement("peakWindGustVal", isNaN(peakWindGustVal) ? '--' : peakWindGustVal.toFixed(1), '', getWindGustClass(peakWindGustVal));

        // VECTOR WIND
        updateElement("vectorWindSpeedVal", isNaN(vectorWindSpeedVal) ? '--' : vectorWindSpeedVal.toFixed(1));
        updateElement("vectorWindDirDegVal", isNaN(vectorWindDirVal) ? '--' : vectorWindDirVal.toFixed(1));
        updateElement("vectorWindDirTextVal", getWindDirection(vectorWindDirVal));

        // EVAP & DEW POINT
        updateElement("evapRateVal", isNaN(evapRate) ? '--' : evapRate.toFixed(3));
        updateElement("dailyEvapVal", isNaN(dailyEvap) ? '--' : dailyEvap.toFixed(3));
        updateElement("dewPointVal", isNaN(dewPoint) ? '--' : dewPoint.toFixed(1));

        // SOIL TEMPS
        updateElement("soilTemp10Val", isNaN(soilTemp10) ? '--' : soilTemp10.toFixed(1));
        updateElement("soilTemp20Val", isNaN(soilTemp20) ? '--' : soilTemp20.toFixed(1));
        updateElement("soilTemp30Val", isNaN(soilTemp30) ? '--' : soilTemp30.toFixed(1));
        updateElement("soilTemp40Val", isNaN(soilTemp40) ? '--' : soilTemp40.toFixed(1));

        // SOIL MOISTURE
        updateElement("moisture10Val", isNaN(moisture10Val) ? '--' : moisture10Val.toFixed(1), '', getMoistureClass(moisture10Val));
        updateElement("moisture20Val", isNaN(moisture20Val) ? '--' : moisture20Val.toFixed(1), '', getMoistureClass(moisture20Val));
        updateElement("moisture30Val", isNaN(moisture30Val) ? '--' : moisture30Val.toFixed(1), '', getMoistureClass(moisture30Val));
        updateElement("moisture40Val", isNaN(moisture40Val) ? '--' : moisture40Val.toFixed(1), '', getMoistureClass(moisture40Val));

        // Remove pulse animation class after it runs
        setTimeout(() => {
            document.querySelectorAll('.big-temp-box.updated').forEach(el => el.classList.remove('updated'));
        }, 400);

        // console.log("DOM update completed successfully."); // Can enable for debugging

      } catch (error) {
        console.error("Error during updateWeatherData execution:", error);
         setStatusBadge("Processing Error", "error");
      }
    }


    /*****************************
    * FETCH & AUTO-REFRESH LOGIC *
    *****************************/
    function fetchWeather() {
        // console.log("fetchWeather called. Attempt:", retryAttempts + 1); // Can enable for debugging
        const spinnerContainer = document.getElementById("spinnerContainer");
        const fetchBtn = document.getElementById("fetchBtn");

        setStatusBadge(retryAttempts > 0 ? `Retrying ${retryAttempts}/${MAX_RETRY_ATTEMPTS}` : "Fetching", "fetching");
        if(spinnerContainer) spinnerContainer.style.display = "block";
        if(fetchBtn) fetchBtn.disabled = true;

        // Clear previous timeout if any (e.g., from manual fetch)
        if (refreshTimeout) {
            clearTimeout(refreshTimeout);
            refreshTimeout = null;
        }

        fetch(WEATHER_ENDPOINT)
            .then(response => {
                // console.log(`Fetch response status: ${response.status}`); // Can enable for debugging
                if (!response.ok) {
                    // Throw an error with status text to be caught below
                    throw new Error(`Server error: ${response.status} ${response.statusText || 'Unknown Status'}`);
                }
                return response.text(); // Get response body as text
            })
            .then(data => {
                // console.log("Fetch successful, data received."); // Can enable for debugging
                updateWeatherData(data); // Process the data
                setStatusBadge("Connected", "connected");
                retryAttempts = 0; // Reset retries on success
                if (!initialLoadComplete) {
                    initialLoadComplete = true;
                    // console.log("Initial load complete."); // Can enable for debugging
                }
                scheduleNextFetch(); // Schedule the next automatic refresh
            })
            .catch(error => {
                console.error("Fetch error:", error.message); // Log the specific error
                retryAttempts++;

                if (retryAttempts >= MAX_RETRY_ATTEMPTS) {
                    setStatusBadge(`Error`, "error"); // Simplified error message
                    console.log(`Max retries (${MAX_RETRY_ATTEMPTS}) reached. Scheduling longer retry...`);
                    // Schedule a longer retry (e.g., 30 seconds) after max attempts
                    const retryDelay = 30000;
                    refreshTimeout = setTimeout(fetchWeather, retryDelay); // Still try again later
                } else {
                    // Use 'fetching' state visually during retry attempts
                    setStatusBadge(`Retrying...`, "fetching"); // Simplified retry message
                    const retryDelay = retryAttempts === 1 ? 1500 : 3000; // Simple backoff
                    refreshTimeout = setTimeout(fetchWeather, retryDelay); // Schedule retry
                    // console.log(`Scheduling retry in ${retryDelay}ms...`); // Can enable for debugging
                }
            })
            .finally(() => {
                // Hide spinner ONLY if we are NOT about to retry immediately
                 if (retryAttempts === 0 || retryAttempts >= MAX_RETRY_ATTEMPTS) {
                      if(spinnerContainer) spinnerContainer.style.display = "none";
                      if(fetchBtn) fetchBtn.disabled = false; // Re-enable button after final attempt or success
                 }
                 // console.log("Fetch sequence finished (finally block)."); // Can enable for debugging
            });
    }

    function scheduleNextFetch() {
        // Clear any existing timeout before scheduling a new one
        if (refreshTimeout) {
            clearTimeout(refreshTimeout);
        }

        const now = new Date();
        const seconds = now.getSeconds();
        const millis = now.getMilliseconds();
        const targetSecond = 20; // Target second past the minute

        // Calculate delay to the next targetSecond
        let delay;
        if (seconds < targetSecond) {
            delay = (targetSecond - seconds) * 1000 - millis;
        } else {
            // Need to go to targetSecond of the *next* minute
            delay = (60 - seconds + targetSecond) * 1000 - millis;
        }

        // Ensure a minimum reasonable delay (e.g., 1 second) to prevent rapid loops if calculation is slightly off
        delay = Math.max(1000, delay);

        // console.log(`Scheduling next fetch in ${Math.round(delay/1000)} seconds (at second ${targetSecond}).`); // Can enable for debugging
        refreshTimeout = setTimeout(fetchWeather, delay);
    }

    function manualFetch() {
        console.log("Manual fetch triggered.");
        if (refreshTimeout) {
            clearTimeout(refreshTimeout); // Stop any scheduled fetch
            refreshTimeout = null;
        }
        retryAttempts = 0; // Reset retries on manual fetch
        fetchWeather(); // Fetch immediately
    }

    // Initial Load on window load
    window.addEventListener("load", () => {
        console.log("Window loaded, initiating first fetch.");
        // Set initial status badge state explicitly
        setStatusBadge("Waiting...", ""); // Default gray state
        fetchWeather(); // Start the process
    });


  </script>
</body>
</html>