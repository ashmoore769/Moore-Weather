<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Live weather data from Moore's Weather Station in West Warwick, QLD.">
  <title>Moore's LIVE Weather Data</title>

  <link rel="apple-touch-icon" href="/Weather_Station_App.png">
  <link rel="icon" href="/favicon.ico"> <!-- Optional: Add a favicon -->

  <!-- Google Fonts: Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    /* --- Base Styles & Variables --- */
    :root {
      --font-family-base: "Inter", "system-ui", "Segoe UI", "Helvetica Neue", Arial, sans-serif;
      --color-background: #f8f9fa; /* Lighter gray background */
      --color-card-bg: #ffffff;
      --color-text-primary: #212529; /* Darker text */
      --color-text-secondary: #6c757d; /* Grayer text */
      --color-primary: #1e3a8a; /* Refined dark blue */
      --color-accent: #FFA500; /* Orange accent */
      --color-accent-darker: #e59400;
      --color-accent-text: #4A4A4A; /* Darker text for orange button */
      --color-border: #e9ecef; /* Light border color */
      --color-success: #198754; /* Bootstrap green */
      --color-warning: #ffc107;
      --color-danger: #dc3545;
      --color-info: #0dcaf0;
      --border-radius-sm: 0.3rem;  /* ~5px */
      --border-radius-md: 0.6rem;  /* ~10px */
      --border-radius-lg: 0.75rem; /* ~12px */
      --shadow-card: 0 4px 12px rgba(0, 0, 0, 0.08);
      --shadow-button: 0 2px 4px rgba(0, 0, 0, 0.15);
    }

    html {
      font-size: 16px; /* Base for rem units */
      box-sizing: border-box;
    }

    *, *:before, *:after {
      box-sizing: inherit;
    }

    body {
      margin: 0;
      background-color: var(--color-background);
      font-family: var(--font-family-base);
      font-size: 0.875rem; /* 14px */
      font-weight: 400;
      line-height: 1.5; /* Slightly more spacing */
      letter-spacing: 0.1px;
      color: var(--color-text-primary);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
      padding-top: env(safe-area-inset-top, 0);
    }

    .main-container {
      max-width: 400px;
      margin: 0.75rem auto; /* 12px auto */
      padding: 0 0.3125rem; /* 5px */
    }

    p {
      margin: 0.25rem 0; /* Consistent small vertical margin for data points */
      line-height: 1.4; /* Tighten slightly for data lines */
    }

    b, strong {
      font-weight: 600; /* Use semi-bold for labels */
      color: var(--color-text-secondary); /* Subtle label color */
      margin-right: 0.25em;
    }

    /* --- Animations --- */
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.03); }
      100% { transform: scale(1); }
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* --- Layout Components --- */
    .freeze-pane {
      position: sticky;
      top: env(safe-area-inset-top, 0);
      z-index: 100;
      background: var(--color-background); /* Match body background */
      padding: 0;
      margin-bottom: 0; /* Remove margin below header */
    }

    .header-box {
      background-color: var(--color-primary);
      border-radius: var(--border-radius-md) var(--border-radius-md) 0 0;
      padding: 0.5rem 0.75rem; /* 8px 12px */
      text-align: center;
    }

    .header-box h2 {
      margin: 0;
      font-size: 1.125rem; /* 18px */
      font-weight: 700; /* Bold */
      color: white;
      white-space: nowrap;
    }

    #weatherData {
      background: var(--color-card-bg);
      padding: 0; /* Remove padding, control bar is first */
      border-radius: 0 0 var(--border-radius-lg) var(--border-radius-lg);
      box-shadow: var(--shadow-card);
      font-size: 0.875rem; /* 14px */
      color: var(--color-text-primary);
      text-align: left;
      margin-bottom: 1rem; /* 16px */
    }

    /* --- Control Bar --- */
    .control-bar {
      /* Removed background, integrated into card */
      padding: 0.625rem 0.75rem; /* 10px 12px */
      border-bottom: 1px solid var(--color-border); /* Separator */
    }

    .control-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.75rem; /* 12px */
    }

    .control-half {
      /* Let flex handle sizing */
      display: flex;
      align-items: center;
      white-space: nowrap;
    }
    .control-half:first-child {
        justify-content: flex-start; /* Align button left */
    }
    .control-half:last-child {
        justify-content: flex-end; /* Align status right */
    }

    button#fetchBtn {
      padding: 0.5rem 0.875rem; /* 8px 14px */
      font-size: 0.875rem; /* 14px */
      font-weight: 600;
      font-family: var(--font-family-base);
      background-color: var(--color-accent);
      color: var(--color-accent-text);
      border: none;
      border-radius: var(--border-radius-sm);
      cursor: pointer;
      transition: background-color 0.2s ease, transform 0.1s ease;
      display: inline-block;
      white-space: nowrap;
      line-height: 1.2;
      letter-spacing: 0.3px;
      box-shadow: var(--shadow-button);
    }

    button#fetchBtn:hover {
      background-color: var(--color-accent-darker);
      transform: translateY(-1px); /* Subtle lift */
    }

    button#fetchBtn:disabled {
      background-color: #adb5bd; /* Gray out */
      color: #fff;
      cursor: not-allowed;
      opacity: 0.8;
      box-shadow: none;
      transform: none;
    }

    #status {
      font-weight: 600;
      font-size: 0.8125rem; /* 13px */
      white-space: nowrap;
      padding: 0;
      margin: 0;
      display: flex; /* To align badge nicely */
      align-items: center;
    }

    /* Status Badge Styles */
    .status-badge {
      display: inline-flex; /* Use flex for icon alignment */
      align-items: center;
      gap: 0.3em; /* Space between icon and text */
      padding: 0.375rem 0.75rem; /* 6px 12px */
      font-size: 0.8125rem; /* 13px */
      font-weight: 600; /* Semibold */
      border-radius: var(--border-radius-sm);
      border: 1px solid transparent;
      line-height: 1;
      transition: all 0.3s ease;
      background-color: var(--color-background); /* Default light gray */
      color: var(--color-text-secondary);
      border-color: var(--color-border);
    }

    .status-badge.connected {
      background-color: var(--color-success);
      color: white;
      border-color: var(--color-success);
    }

    .status-badge.fetching {
      background-color: #cfe2ff; /* Light blue */
      color: #0a58ca; /* Darker blue */
      border-color: #9ec5fe;
    }

    .status-badge.error {
      background-color: var(--color-danger);
      color: white;
      border-color: var(--color-danger);
    }

    /* --- Data Sections --- */
    .data-section {
      padding: 0.75rem 0.875rem; /* 12px 14px */
      border-bottom: 1px solid var(--color-border);
    }
    .data-section:last-child {
        border-bottom: none; /* No border on the last section */
    }

    /* Header Section within Card */
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .title-date-container {
      display: flex;
      flex-direction: column;
    }

    .address-title {
      font-size: 1.125rem; /* 18px */
      font-weight: 700;
      margin: 0 0 0.25rem 0;
      color: var(--color-primary);
    }

    .date-time {
      margin: 0;
      font-size: 0.8125rem; /* 13px */
      color: var(--color-text-secondary);
    }
    .date-time p {
      margin: 0.1rem 0;
      line-height: 1.3;
    }
    .date-time b { /* Make labels less prominent here */
       font-weight: 400;
       color: var(--color-text-secondary);
    }
    .date-time span {
        color: var(--color-text-primary); /* Make value primary */
        font-weight: 600; /* Semibold value */
    }


    .logo-container {
      display: flex;
      gap: 0.5rem; /* 8px */
      align-items: center; /* Align logos vertically */
    }

    .logo-container img {
      height: 50px; /* Slightly smaller logo */
      width: auto;
      display: block;
      border-radius: var(--border-radius-sm);
    }

    /* Main Data Layout (Wind/Logger) */
    .wind-logger-container {
      display: flex;
      justify-content: space-between;
      gap: 0.875rem; /* 14px */
    }

    .wind-column {
      width: 60%;
      flex-shrink: 0; /* Prevent shrinking */
    }

    .logger-column {
      width: 40%;
      display: flex;
      flex-direction: column;
      align-items: center; /* Center boxes horizontally */
      justify-content: flex-start; /* Align boxes to top */
      gap: 0.625rem; /* 10px space between boxes */
    }

    /* Big Temp Box - Revised Style */
    .big-temp-box {
      width: 100%; /* Take available width */
      min-height: 65px; /* Ensure minimum height */
      padding: 0.5rem 0.625rem; /* 8px 10px */
      border: 1px solid var(--color-border);
      border-radius: var(--border-radius-md); /* Consistent rounding */
      background-color: #6c757d; /* Default gray background */
      color: white; /* Default text color */
      font-family: var(--font-family-base);
      text-align: center;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      transition: background-color 0.3s ease, transform 0.3s ease-in-out;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05); /* Subtle shadow */
    }

    .big-temp-box.updated {
      animation: pulse 0.3s ease-in-out;
    }

    .big-temp-box span.value { /* Class for the main value */
      font-size: 1.25rem; /* 20px */
      font-weight: 700; /* Bold */
      line-height: 1.1;
      display: block; /* Ensure it takes full width */
    }

    .big-temp-box span.label {
      font-size: 0.75rem; /* 12px */
      font-weight: 600; /* Semibold */
      line-height: 1.2;
      margin-top: 0.1rem; /* Small gap */
      opacity: 0.9; /* Slightly less prominent */
      display: block; /* Ensure it takes full width */
    }

    /* Dynamic Background Colors for Big Temp Box (Example - Needs JS) */
    /* Air Temp */
    .big-temp-box#airTempBox.temp-cold { background-color: #0d6efd; }
    .big-temp-box#airTempBox.temp-cool { background-color: #0dcaf0; color: #000; }
    .big-temp-box#airTempBox.temp-mild { background-color: #198754; }
    .big-temp-box#airTempBox.temp-warm { background-color: #ffc107; color: #000; }
    .big-temp-box#airTempBox.temp-hot { background-color: #dc3545; }
    /* Radiant Diff */
    .big-temp-box#radiantDiffBox.diff-positive { background-color: #fd7e14; } /* Orange for hotter */
    .big-temp-box#radiantDiffBox.diff-negative { background-color: #6f42c1; } /* Purple for cooler */
    /* Dew Diff */
    .big-temp-box#dewDiffBox.dew-dry { background-color: #d63384; } /* Pinkish for dry */
    .big-temp-box#dewDiffBox.dew-humid { background-color: #20c997; } /* Teal for humid */


    /* Rain Container - subtle emphasis */
    .rain-container {
      margin-top: 0.625rem; /* 10px */
      padding: 0.5rem 0.625rem; /* 8px 10px */
      border: 1px solid var(--color-border);
      border-radius: var(--border-radius-sm);
      background: #f8f9fa; /* Slightly off-white */
    }
    .rain-container p {
      margin: 0.125rem 0; /* Tighter spacing inside rain */
    }

    /* Two Column Layouts (Evap/Battery, Soil/Moisture) */
    .two-col-container {
      display: flex;
      justify-content: space-between;
      gap: 1rem; /* 16px */
    }

    .two-col-container > div {
      width: calc(50% - 0.5rem); /* Adjust width based on gap */
    }

    /* --- Utility Classes for Dynamic Styling (Needs JS) --- */
    .text-bold { font-weight: 700 !important; }
    .text-semibold { font-weight: 600 !important; }

    .temp-very-cold { color: #104E8B !important; }
    .temp-cold { color: #4682B4 !important; }
    .temp-cool { color: #32CD32 !important; }
    .temp-mild { color: #228B22 !important; }
    .temp-warm { color: #D4A017 !important; }
    .temp-hot { color: #FF4500 !important; }
    .temp-very-hot { color: #B22222 !important; }

    .rain-significant { color: #1E90FF !important; font-weight: 600 !important; }

    .solar-low { color: #27408B !important; }
    .solar-med { color: #DAA520 !important; font-weight: 600 !important; }
    .solar-high { color: #BF360C !important; font-weight: 600 !important; }
    .solar-very-high { color: #B71C1C !important; font-weight: 600 !important; }
    .solar-zero { color: #000033 !important; } /* Night */

    .pressure-high { color: green !important; font-weight: 600 !important; }

    .battery-ok { color: green !important; }
    .battery-full { color: green !important; font-weight: 600 !important; }
    .battery-low { color: red !important; }

    .charge-positive { color: green !important; }
    .charge-negative { color: red !important; }

    .wind-gust-high { color: red !important; font-weight: 600 !important; }
    .wind-gust-med { color: #FF8C00 !important; font-weight: 600 !important; }

    .moisture-dry { color: #FF8C00 !important; font-weight: 600 !important; }


    /* --- Spinner --- */
    .spinner-container {
      display: none; /* Hidden by default */
      margin: 1.25rem auto; /* 20px */
      width: 40px;
      height: 40px;
      position: relative; /* Needed if placing inside other elements later */
    }

    .spinner {
      width: 100%;
      height: 100%;
      border: 4px solid rgba(0, 0, 0, 0.1); /* Lighter border */
      border-top-color: var(--color-primary); /* Use theme color */
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    /* --- Media Queries (Optional Refinements) --- */
    /* No major changes needed for 400px width based on this design */

  </style>
</head>
<body>
  <div class="main-container">

    <!-- Sticky Header -->
    <div class="freeze-pane">
      <div class="header-box">
        <h2>Moore's LIVE Weather Data</h2>
      </div>
    </div>

    <!-- Weather Data Card -->
    <div id="weatherData">

      <!-- Control Button Bar -->
      <div class="control-bar">
        <div class="control-container">
          <div class="control-half">
            <button id="fetchBtn" onclick="manualFetch()">Current Readings</button>
          </div>
          <div class="control-half">
            <p id="status" aria-live="polite">
              <!-- Status badge content set by JS -->
              <span id="statusBadge" class="status-badge">Waiting...</span>
            </p>
          </div>
        </div>
      </div>

      <!-- Header Section -->
      <div class="data-section header-content">
        <div class="title-date-container">
          <div class="address-title">WEST WARWICK, QLD</div>
          <div class="date-time">
            <p>üìÜ <span id="dateVal">-- / -- / ---- (---)</span></p>
            <p>‚è∞ <span id="timeVal">-- : -- : -- AEST</span></p>
          </div>
        </div>
        <div class="logo-container">
          <img src="/Weather_Station_App.png" alt="Weather Station Icon">
          <img src="/Station_Label.png" alt="Environdata Weather Maestro">
        </div>
      </div>

      <!-- Main Data Columns Section -->
      <div class="data-section wind-logger-container">
        <div class="wind-column">
          <p><b>üí® Wind Speed:</b> <span id="windSpeedVal">--</span> km/h</p>
          <p><b>üß≠ Wind Direction:</b> <span id="windDirDegVal">--</span>¬∞ (<span id="windDirTextVal">--</span>)</p>
          <p><b>üí¶ Humidity:</b> <span id="humidityVal">--</span>% (<span id="humidityDescVal">--</span>)</p>
          <p>
            <b>üå°Ô∏è Temperature:</b>
            <span id="tempVal" class="temp-value">--¬∞C</span> <!-- Class added for JS styling -->
            (<span id="tempDescVal">--</span>)
          </p>
          <p><b>‚òÄÔ∏è Solar Radiation:</b> <span id="solarRadVal">--</span></p> <!-- Class added by JS -->
          <p><b>üîò Black Globe Temp:</b> <span id="blackGlobeTempVal" class="temp-value">--</span>¬∞C</p> <!-- Class added for JS styling -->
          <p><b>üå± Garden Bed Temp:</b> <span id="gardenBedTempVal">--</span>¬∞C</p>
          <p><b>üåÄ Pressure:</b> <span id="pressureVal">--</span></p> <!-- Class added by JS -->
          <div class="rain-container">
            <p><b>üåßÔ∏è Rain Since 9AM:</b> <span id="rainSince9Val">--</span></p> <!-- Class added by JS -->
            <p><b>üåßÔ∏è Rain In Last Min:</b> <span id="rainInLastMinVal">--</span></p> <!-- Class added by JS -->
          </div>
        </div>
        <div class="logger-column">
          <!-- Big Temp Boxes: Value and labels updated by JS -->
          <!-- JS should also add classes like .temp-hot, .diff-positive etc. -->
          <div class="big-temp-box" id="airTempBox">
            <span class="value" id="bigTempVal">--¬∞C</span>
            <span class="label">Air Temp</span>
          </div>
          <div class="big-temp-box" id="radiantDiffBox">
            <span class="value" id="radiantDiffVal">--¬∞C</span>
            <span class="label" aria-label="Difference between radiant and air temperature">Rad. Heat Diff</span>
          </div>
          <div class="big-temp-box" id="dewDiffBox">
            <span class="value" id="dewDiffVal">--¬∞C</span>
            <span class="label" aria-label="Temp above dew point">Temp > Dew P.</span>
          </div>
        </div>
      </div>

      <!-- Evaporation and Battery Section -->
      <div class="data-section two-col-container evap-battery">
        <div class="evap-col">
          <p><b>‚§¥Ô∏è Evap/Hr:</b> <span id="evapRateVal">--</span> mm/h</p>
          <p><b>‚¨ÜÔ∏è Daily Evap:</b> <span id="dailyEvapVal">--</span> mm</p>
          <p><b>üíß Dew Point:</b> <span id="dewPointVal">--</span>¬∞C</p>
          <p><b>üå¨Ô∏è Max WS Gust:</b> <span id="peakWindGustVal">--</span></p> <!-- Class added by JS -->
        </div>
        <div class="battery-col">
          <p><b>üîã Battery:</b> <span id="batteryVal">--</span></p> <!-- Class added by JS -->
          <p><b>‚ö° Load:</b> <span id="loadVal">--</span> mA</p>
          <p><b>‚òÄÔ∏è Solar Panel:</b> <span id="solarPanelVal">--</span></p>
          <p><b>üîå Charge:</b> <span id="chargeVal">--</span></p> <!-- Class added by JS -->
        </div>
      </div>

      <!-- Additional Data Section -->
      <div class="data-section">
         <p><b>üçÉ Vector Wind Speed:</b> <span id="vectorWindSpeedVal">--</span> km/h</p>
         <p>
           <b>üß≠ Vector Wind Direction:</b>
           <span id="vectorWindDirDegVal">--</span>¬∞ (<span id="vectorWindDirTextVal">--</span>)
         </p>
      </div>

      <!-- Soil Moisture Section -->
      <div class="data-section two-col-container soil-moisture">
        <div class="soiltemp-col">
          <p><b>üå°Ô∏è S. Temp 10cm:</b> <span id="soilTemp10Val">--</span>¬∞C</p>
          <p><b>üå°Ô∏è S. Temp 20cm:</b> <span id="soilTemp20Val">--</span>¬∞C</p>
          <p><b>üå°Ô∏è S. Temp 30cm:</b> <span id="soilTemp30Val">--</span>¬∞C</p>
          <p><b>üå°Ô∏è S. Temp 40cm:</b> <span id="soilTemp40Val">--</span>¬∞C</p>
        </div>
        <div class="moisture-col">
          <p><b>üíß Moist. 10cm:</b> <span id="moisture10Val">--</span>%</p> <!-- Class added by JS -->
          <p><b>üíß Moist. 20cm:</b> <span id="moisture20Val">--</span>%</p> <!-- Class added by JS -->
          <p><b>üíß Moist. 30cm:</b> <span id="moisture30Val">--</span>%</p> <!-- Class added by JS -->
          <p><b>üíß Moist. 40cm:</b> <span id="moisture40Val">--</span>%</p> <!-- Class added by JS -->
        </div>
      </div>

    </div> <!-- End #weatherData Card -->

    <!-- Spinner -->
    <div id="spinnerContainer" class="spinner-container">
      <div class="spinner"></div>
    </div>

  </div> <!-- End .main-container -->

  <script>
    /********************
    * HELPER FUNCTIONS *
    ********************/
    function getWindDirection(degrees) {
      const directions = ["N", "NNE", "NE", "ENE", "E", "ESE", "SE", "SSE",
        "S", "SSW", "SW", "WSW", "W", "WNW", "NW", "NNW"];
      return directions[Math.round(degrees / 22.5) % 16];
    }

    // --- JAVASCRIPT MODIFICATION NEEDED ---
    // Modify setStatusBadge, getTemperatureColorAndDesc, getHumidityDesc,
    // colorMoisture etc. to return CSS CLASS NAMES instead of setting
    // inline styles or returning HTML strings with inline styles.
    // Example: getTemperatureColorAndDesc might return { desc: "Hot", class: "temp-hot" }

    function setStatusBadge(statusText, statusClass) {
        const icons = {
            connected: "‚úÖ",
            fetching: "üîÑ", // Or a specific fetching icon/animation
            error: "‚ö†Ô∏è"
        };
        const iconHTML = icons[statusClass] ? `<span class="icon">${icons[statusClass]}</span>` : ""; // Wrap icon if needed
        const badge = document.getElementById("statusBadge");

        // Use textContent for security and simplicity unless HTML is needed
        badge.textContent = `${statusText}`; // JS sets text, CSS adds icon via ::before if needed

        // Set classes for styling
        badge.className = `status-badge ${statusClass}`; // Clear previous classes
    }

    function formatDateString(dateStr) {
        // Keep this function as is, it returns text content
        const parts = dateStr.split("/");
        if (parts.length === 3) {
            const [year, month, day] = parts;
            const formattedDate = `${day}/${month}/${year}`;
            const dateObj = new Date(year, month - 1, day); // Month is 0-indexed
            const dayNames = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
            // Check if dateObj is valid
            if (!isNaN(dateObj.getTime())) {
              return `${formattedDate} (${dayNames[dateObj.getDay()]})`;
            }
        }
        return dateStr; // Fallback
    }

    // !! REWRITE THIS FUNCTION !!
    function getTemperatureInfo(temp) {
      // **NEEDS REWRITING**
      // Should return an object like: { desc: "Warm", className: "temp-warm" }
      // Based on temperature ranges.
      // Example structure:
      let desc = "";
      let className = "";
      if (temp < 0) { desc = "Extremely cold"; className = "temp-very-cold"; }
      else if (temp < 11) { desc = "Cold"; className = "temp-cold"; }
      // ... other ranges ...
      else if (temp < 28) { desc = "Warm"; className = "temp-warm"; }
      else if (temp < 36) { desc = "Hot"; className = "temp-hot"; }
      else { desc = "Extremely hot"; className = "temp-very-hot"; }
      return { desc, className };
    }

     // !! REWRITE THIS FUNCTION !!
    function getBigTempBoxAirClass(temp) {
       // **NEEDS REWRITING**
       // Return class for the background color, e.g., "temp-hot", "temp-cold"
       if (temp < 5) return 'temp-cold';
       if (temp < 15) return 'temp-cool';
       if (temp < 25) return 'temp-mild';
       if (temp < 35) return 'temp-warm';
       return 'temp-hot';
    }

    // !! REWRITE THIS FUNCTION !!
     function getRadiantDiffClass(diff) {
       // **NEEDS REWRITING**
       // Return 'diff-positive' or 'diff-negative'
       return diff >= 0 ? 'diff-positive' : 'diff-negative';
     }

     // !! REWRITE THIS FUNCTION !!
     function getDewDiffClass(diff) {
        // **NEEDS REWRITING**
        // Return 'dew-dry' or 'dew-humid' or maybe a neutral default
        if (diff >= 3.0) return 'dew-dry';
        if (diff < 1.5) return 'dew-humid';
        return 'dew-neutral'; // Add a style for dew-neutral if needed
     }

    // Keep this, it returns text
    function getHumidityDesc(humidity) {
      if (humidity <= 20) { return "Very Dry"; }
      else if (humidity <= 40) { return "Dry"; }
      else if (humidity <= 60) { return "Comfortable"; }
      else if (humidity <= 80) { return "Humid"; }
      else { return "Very Humid"; }
    }

    // !! REWRITE THIS FUNCTION !!
    function getMoistureClass(val) {
       // **NEEDS REWRITING**
       // Return "moisture-dry" or "" (or "moisture-ok" etc.)
      return (val < 20) ? "moisture-dry text-semibold" : "";
    }

    // !! REWRITE THIS FUNCTION for other dynamic classes !!
    function getSolarRadiationClass(solarRad) {
        if (solarRad <= 0) return 'solar-zero';
        if (solarRad <= 100) return 'solar-low';
        if (solarRad <= 600) return 'solar-med';
        if (solarRad <= 1100) return 'solar-high';
        return 'solar-very-high';
    }
    function getPressureClass(pressure) {
        return pressure >= 1020 ? 'pressure-high' : '';
    }
    function getBatteryClass(voltage) {
        if (voltage < 12.5) return 'battery-low';
        if (voltage >= 13.8) return 'battery-full text-semibold';
        return 'battery-ok';
    }
    function getChargeClass(charge, load, voltage) {
         if (voltage < 13.80) {
             return charge > load ? 'charge-positive' : 'charge-negative';
         }
         return ''; // No specific class if voltage is high
    }
    function getWindGustClass(gust) {
        if (gust > 25) return 'wind-gust-high';
        if (gust > 10) return 'wind-gust-med';
        return '';
    }
     function getRainClass(rainAmount) {
        return rainAmount >= 0.2 ? 'rain-significant' : '';
    }


    /*****************************
    * GLOBAL STATE & RETRIES *
    *****************************/
    let initialLoadComplete = false;
    let refreshTimeout;
    let retryAttempts = 0;
    const MAX_RETRY_ATTEMPTS = 3;
    const WEATHER_ENDPOINT = "/weather";

    /*****************************
    * MAIN UPDATE FUNCTION *
    *****************************/
    function updateWeatherData(data) {
      console.log("Raw CSV data received");
      const lines = data.replace(/r3\r?\n?/, "").trim().split(",");
      // console.log("Parsed lines array:", lines); // Less verbose logging

      if (lines.length < 30) {
        console.error("Incomplete data received:", lines.length, "fields");
        // Display error more gracefully
         setStatusBadge("Data Error", "error");
         // Maybe show a message in the card:
         // document.getElementById('weatherData').innerHTML = '<div class="data-section"><p class="text-danger text-bold">Error: Incomplete data received.</p></div>';
        return;
      }

      try {
        // --- Extract Data (Keep as is) ---
        const dateStr = lines[0];
        const timeStr = lines[1];
        const windSpeed = parseFloat(lines[2]);
        const windDirDeg = parseFloat(lines[3]);
        const humidityRaw = parseFloat(lines[4]);
        const temperatureRaw = parseFloat(lines[5]);
        let rainInLastMinRaw = parseFloat(lines[6]);
        const solarRadRaw = parseFloat(lines[7]);
        const pressureRaw = parseFloat(lines[8]);
        const gardenBedTemp = parseFloat(lines[9]);
        const batteryVoltageVal = parseFloat(lines[10]);
        const loadCurrent = parseFloat(lines[11]);
        const rawSolarVoltage = parseFloat(lines[12]);
        const chargeCurrent = parseFloat(lines[13]);
        const peakWindGustVal = parseFloat(lines[14]);
        const vectorWindSpeedVal = parseFloat(lines[15]);
        const vectorWindDirVal = parseFloat(lines[16]);
        const rainSince9 = parseFloat(lines[17]);
        const evapRate = parseFloat(lines[18]);
        const dailyEvap = parseFloat(lines[20]);
        const dewPoint = parseFloat(lines[21]);
        const soilTemp10 = parseFloat(lines[22]);
        const soilTemp20 = parseFloat(lines[23]);
        const soilTemp30 = parseFloat(lines[24]);
        const soilTemp40 = parseFloat(lines[25]);
        const moisture10Val = parseFloat(lines[26]);
        const moisture20Val = parseFloat(lines[27]);
        const moisture30Val = parseFloat(lines[28]);
        const moisture40Val = parseFloat(lines[29]);
        const blackGlobeTemp = parseFloat(lines[30]);

        // --- Validate Core Data (Keep as is) ---
         if (isNaN(windSpeed) || isNaN(windDirDeg) || isNaN(humidityRaw) || isNaN(temperatureRaw) || isNaN(pressureRaw)) {
            console.error("Invalid core data received:", lines);
            setStatusBadge("Data Error", "error");
             // document.getElementById('weatherData').innerHTML = '<div class="data-section"><p class="text-danger text-bold">Error: Invalid data values received.</p></div>';
            return;
        }


        // --- Update DOM Elements using textContent and classList ---

        // Helper to update text and classes
        function updateElement(id, value, baseClass = '', dynamicClass = '') {
          const element = document.getElementById(id);
          if (element) {
            element.textContent = value;
            // Reset classes carefully - keep base classes if they exist
            element.className = baseClass; // Start fresh or with base
            if (dynamicClass) {
               dynamicClass.split(' ').forEach(cls => {
                   if (cls) element.classList.add(cls); // Add new dynamic classes
               });
            }
          } else {
            console.warn(`Element with id "${id}" not found.`);
          }
        }

        // DATE & TIME
        updateElement("dateVal", formatDateString(dateStr));
        updateElement("timeVal", timeStr + " AEST");

        // WIND
        updateElement("windSpeedVal", windSpeed.toFixed(1));
        updateElement("windDirDegVal", windDirDeg.toFixed(1));
        updateElement("windDirTextVal", getWindDirection(windDirDeg));

        // HUMIDITY
        updateElement("humidityVal", humidityRaw.toFixed(1));
        updateElement("humidityDescVal", getHumidityDesc(humidityRaw));

        // TEMPERATURE
        const tempInfo = getTemperatureInfo(temperatureRaw); // Needs rewrite
        updateElement("tempVal", temperatureRaw.toFixed(1) + "¬∞C", 'temp-value', tempInfo.className);
        updateElement("tempDescVal", tempInfo.desc);

        // BIG TEMP BOX - AIR
        const airTempBox = document.getElementById("airTempBox");
        const airTempBoxClass = getBigTempBoxAirClass(temperatureRaw); // Needs rewrite
        updateElement("bigTempVal", temperatureRaw.toFixed(1) + "¬∞C", 'value');
        airTempBox.className = `big-temp-box updated ${airTempBoxClass}`; // Add base, updated, and dynamic classes

        // SOLAR RADIATION
        const solarRad = Math.max(0, solarRadRaw);
        const solarRadDisplay = solarRad.toFixed(1) + " W/m¬≤" + (solarRad < 10 ? " üåô" : "");
        updateElement("solarRadVal", solarRadDisplay, '', getSolarRadiationClass(solarRad)); // Needs rewrite

        // BLACK GLOBE TEMP & RADIANT DIFF
        const globeTempInfo = getTemperatureInfo(blackGlobeTemp); // Reuse temp logic
        updateElement("blackGlobeTempVal", blackGlobeTemp.toFixed(1), 'temp-value', globeTempInfo.className);

        const radiantDiff = blackGlobeTemp - temperatureRaw;
        const radiantDiffFormatted = (radiantDiff >= 0 ? "+" : "") + radiantDiff.toFixed(1) + "¬∞C";
        const radiantDiffBox = document.getElementById("radiantDiffBox");
        const radiantDiffClass = getRadiantDiffClass(radiantDiff); // Needs rewrite
        updateElement("radiantDiffVal", radiantDiffFormatted, 'value');
        radiantDiffBox.className = `big-temp-box updated ${radiantDiffClass}`;


         // TEMP ABOVE DEW POINT
         const dewDiff = temperatureRaw - dewPoint;
         const dewFormatted = (dewDiff >= 0 ? "+" : "") + dewDiff.toFixed(1) + "¬∞C";
         const dewDiffBox = document.getElementById("dewDiffBox");
         const dewDiffClass = getDewDiffClass(dewDiff); // Needs rewrite
         updateElement("dewDiffVal", dewFormatted, 'value');
         dewDiffBox.className = `big-temp-box updated ${dewDiffClass}`;


        // GARDEN BED TEMP
        updateElement("gardenBedTempVal", gardenBedTemp.toFixed(1));

        // PRESSURE
        let adjustedPressure = pressureRaw - 1.9;
        let pressureDisplay = adjustedPressure.toFixed(1) + " hPa" + (adjustedPressure >= 1020 ? " üêü" : "");
        updateElement("pressureVal", pressureDisplay, '', getPressureClass(adjustedPressure)); // Needs rewrite

        // RAIN
         rainInLastMinRaw = isNaN(rainInLastMinRaw) ? 0.0 : rainInLastMinRaw;
         updateElement("rainSince9Val", rainSince9.toFixed(1) + " mm", '', getRainClass(rainSince9)); // Needs rewrite
         updateElement("rainInLastMinVal", rainInLastMinRaw.toFixed(1) + " mm", '', getRainClass(rainInLastMinRaw)); // Needs rewrite

        // BATTERY & CHARGE
        const batteryClass = getBatteryClass(batteryVoltageVal); // Needs rewrite
        updateElement("batteryVal", batteryVoltageVal.toFixed(1) + " V", '', batteryClass);
        updateElement("loadVal", loadCurrent.toFixed(1));

        let solarPanelDisplay = rawSolarVoltage.toFixed(1) + " V" + (rawSolarVoltage < batteryVoltageVal ? " üåô" : " ‚òÄÔ∏è");
        updateElement("solarPanelVal", solarPanelDisplay);

        const chargeClass = getChargeClass(chargeCurrent, loadCurrent, batteryVoltageVal); // Needs rewrite
        updateElement("chargeVal", chargeCurrent.toFixed(1) + " mA", '', chargeClass);

        // PEAK WIND GUST
        const gustClass = getWindGustClass(peakWindGustVal); // Needs rewrite
        updateElement("peakWindGustVal", peakWindGustVal.toFixed(1) + " km/h", '', gustClass);

        // VECTOR WIND
        updateElement("vectorWindSpeedVal", vectorWindSpeedVal.toFixed(1));
        updateElement("vectorWindDirDegVal", vectorWindDirVal.toFixed(1));
        updateElement("vectorWindDirTextVal", getWindDirection(vectorWindDirVal));

        // EVAP & DEW POINT
        updateElement("evapRateVal", evapRate.toFixed(3));
        updateElement("dailyEvapVal", dailyEvap.toFixed(3));
        updateElement("dewPointVal", dewPoint.toFixed(1));

        // SOIL TEMPS
        updateElement("soilTemp10Val", soilTemp10.toFixed(1));
        updateElement("soilTemp20Val", soilTemp20.toFixed(1));
        updateElement("soilTemp30Val", soilTemp30.toFixed(1));
        updateElement("soilTemp40Val", soilTemp40.toFixed(1));

        // SOIL MOISTURE
        updateElement("moisture10Val", moisture10Val.toFixed(1) + "%", '', getMoistureClass(moisture10Val)); // Needs rewrite
        updateElement("moisture20Val", moisture20Val.toFixed(1) + "%", '', getMoistureClass(moisture20Val)); // Needs rewrite
        updateElement("moisture30Val", moisture30Val.toFixed(1) + "%", '', getMoistureClass(moisture30Val)); // Needs rewrite
        updateElement("moisture40Val", moisture40Val.toFixed(1) + "%", '', getMoistureClass(moisture40Val)); // Needs rewrite

        // Remove pulse animation class after it runs
        setTimeout(() => {
            document.querySelectorAll('.big-temp-box.updated').forEach(el => el.classList.remove('updated'));
        }, 400); // Slightly longer than animation duration


      } catch (error) {
        console.error("Error processing data:", error);
        setStatusBadge("Processing Error", "error");
        // Optionally display an error message in the UI
      }
    }


    /*****************************
    * FETCH & AUTO-REFRESH LOGIC *
    *****************************/
    function fetchWeather() {
        // Keep the status update logic, spinner, button disable
        const statusText = document.getElementById("status"); // Though we mainly use the badge now
        const spinnerContainer = document.getElementById("spinnerContainer");
        const fetchBtn = document.getElementById("fetchBtn");

        setStatusBadge("Fetching", "fetching");
        spinnerContainer.style.display = "block"; // Show spinner
        if(fetchBtn) fetchBtn.disabled = true;

        fetch(WEATHER_ENDPOINT)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status} ${response.statusText}`);
                }
                return response.text();
            })
            .then(data => {
                updateWeatherData(data);
                setStatusBadge("Connected", "connected");
                retryAttempts = 0; // Reset retries on success
                if (!initialLoadComplete) {
                    initialLoadComplete = true;
                }
                scheduleNextFetch(); // Schedule next auto-refresh
            })
            .catch(error => {
                console.error("Fetch error:", error);
                retryAttempts++;

                if (retryAttempts >= MAX_RETRY_ATTEMPTS) {
                    setStatusBadge(`Error (${retryAttempts})`, "error");
                    console.log(`Max retries (${MAX_RETRY_ATTEMPTS}) reached. Scheduling longer retry...`);
                    // Schedule a longer retry (e.g., 30 seconds)
                    const retryDelay = 30000;
                    refreshTimeout = setTimeout(fetchWeather, retryDelay);
                } else {
                    setStatusBadge(`Retrying ${retryAttempts}/${MAX_RETRY_ATTEMPTS}`, "fetching"); // Show retry state
                    const retryDelay = retryAttempts === 1 ? 1000 : 2000; // Simple backoff
                    refreshTimeout = setTimeout(fetchWeather, retryDelay);
                    console.log(`Retrying fetch... (${retryAttempts}/${MAX_RETRY_ATTEMPTS})`);
                }
            })
            .finally(() => {
                // Hide spinner and re-enable button regardless of outcome (unless another fetch is scheduled immediately)
                spinnerContainer.style.display = "none";
                 if(fetchBtn) fetchBtn.disabled = false;
            });
    }

    function scheduleNextFetch() {
        if (refreshTimeout) {
            clearTimeout(refreshTimeout);
        }
        const now = new Date();
        const seconds = now.getSeconds();
        const millis = now.getMilliseconds();
        // Calculate delay to next 20-second mark past the minute
        let delay = (seconds < 20)
            ? (20 - seconds) * 1000 - millis
            : (80 - seconds) * 1000 - millis; // 60 - seconds + 20

        // Ensure minimum delay to prevent rapid firing if calculation is off
        if (delay < 500) {
             delay += 60000;
        }

        console.log(`Scheduling next fetch in ${Math.round(delay/1000)} seconds`);
        refreshTimeout = setTimeout(fetchWeather, delay);
    }

    function manualFetch() {
        console.log("Manual fetch triggered");
        if (refreshTimeout) {
            clearTimeout(refreshTimeout); // Stop scheduled fetch
        }
        retryAttempts = 0; // Reset retries on manual fetch
        fetchWeather(); // Fetch immediately
    }

    // Initial Load on window load
    window.addEventListener("load", () => {
        console.log("Window loaded, initiating first fetch.");
        fetchWeather(); // Start the process
    });

  </script>
</body>
</html>