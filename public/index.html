<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Live weather data from Moore's Weather Station in West Warwick, QLD.">
  <title>Moore's LIVE Weather Data</title>

  <link rel="apple-touch-icon" href="/Weather_Station_App.png">
  <link rel="icon" href="/favicon.ico"> <!-- Optional: Add a favicon -->

  <!-- Google Fonts: Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    /* --- Base Styles & Variables --- */
    :root {
      --font-family-base: "Inter", "system-ui", "Segoe UI", "Helvetica Neue", Arial, sans-serif;
      --color-background: #f8f9fa;
      --color-card-bg: #ffffff;
      --color-text-primary: #212529;
      --color-text-secondary: #6c757d;
      --color-primary: #1e3a8a; /* Header blue */
      --color-accent: #FFA500; /* Orange */
      --color-accent-darker: #e59400;
      --color-accent-text: #4A4A4A;
      --color-border: #e9ecef;
      --color-success: #198754; /* Green */
      --color-success-darker: #146c43;
      --color-warning: #ffc107;
      --color-danger: #dc3545;
      --color-info: #0dcaf0; /* For fetching/retrying */
      --color-info-darker: #0a58ca;
      --color-purple: #6f42c1; /* For Rad Heat Diff negative */
      --color-teal: #20c997;  /* For Temp > Dew P */
      --border-radius-sm: 0.3rem;
      --border-radius-md: 0.6rem;
      --border-radius-lg: 0.75rem;
      --shadow-card: 0 4px 12px rgba(0, 0, 0, 0.08);
      --shadow-button: 0 2px 4px rgba(0, 0, 0, 0.15);

      /* Font size reduction */
      --font-size-base: 0.8125rem; /* 13px */
      --font-size-sm: 0.75rem;    /* 12px */
      --font-size-lg: 1rem;        /* 16px */
      --font-size-xl: 1.125rem;   /* 18px */
    }

    html {
      font-size: 16px;
      box-sizing: border-box;
    }

    *, *:before, *:after {
      box-sizing: inherit;
    }

    body {
      margin: 0;
      background-color: var(--color-background);
      font-family: var(--font-family-base);
      font-size: var(--font-size-base); /* Use variable */
      font-weight: 400;
      line-height: 1.4; /* Slightly tighter */
      letter-spacing: 0.1px;
      color: var(--color-text-primary);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
      padding-top: env(safe-area-inset-top, 0);
    }

    .main-container {
      max-width: 400px;
      margin: 0.75rem auto;
      padding: 0 0.3125rem;
    }

    /* Apply nowrap/ellipsis broadly first */
    p {
      margin: 0.2rem 0; /* Tighten paragraph spacing */
      line-height: 1.35;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
     /* Allow specific descriptions to wrap if needed */
    #humidityDescVal, #tempDescVal {
        white-space: normal;
        overflow: visible;
        text-overflow: clip;
    }


    b, strong {
      font-weight: 600;
      color: var(--color-text-secondary);
      margin-right: 0.25em;
    }

    /* --- Animations --- */
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.03); }
      100% { transform: scale(1); }
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* --- Layout Components --- */
    .freeze-pane {
      position: sticky;
      top: env(safe-area-inset-top, 0);
      z-index: 100;
      background: var(--color-background);
      padding: 0;
      margin-bottom: 0;
    }

    .header-box {
      background-color: var(--color-primary);
      border-radius: var(--border-radius-md) var(--border-radius-md) 0 0;
      padding: 0.5rem 0.75rem;
      text-align: center;
    }

    .header-box h2 {
      margin: 0;
      font-size: var(--font-size-lg); /* 16px */
      font-weight: 700;
      color: white;
      white-space: nowrap;
    }

    #weatherData {
      background: var(--color-card-bg);
      padding: 0;
      border-radius: 0 0 var(--border-radius-lg) var(--border-radius-lg);
      box-shadow: var(--shadow-card);
      font-size: var(--font-size-base);
      color: var(--color-text-primary);
      text-align: left;
      margin-bottom: 1rem;
    }

    /* --- Control Bar & Buttons --- */
    .control-bar {
      padding: 0.625rem 0.75rem;
      border-bottom: 1px solid var(--color-border);
    }

    .control-container {
      display: flex;
      justify-content: space-between;
      align-items: center; /* Vertically center buttons */
      gap: 0.75rem;
    }

    .control-half {
      display: flex;
      align-items: center;
    }
    .control-half:first-child { justify-content: flex-start; }
    .control-half:last-child { justify-content: flex-end; }

    /* Shared button/status styles */
    .button-style {
      padding: 0.5rem 0.875rem;
      font-size: var(--font-size-base); /* 13px */
      font-weight: 600;
      font-family: var(--font-family-base);
      border: none;
      border-radius: var(--border-radius-sm);
      cursor: pointer;
      transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
      display: inline-block;
      white-space: nowrap;
      line-height: 1.2;
      letter-spacing: 0.3px;
      text-align: center;
      box-shadow: var(--shadow-button);
    }

    button#fetchBtn {
      background-color: var(--color-accent);
      color: var(--color-accent-text);
    }

    button#fetchBtn:hover {
      background-color: var(--color-accent-darker);
      transform: translateY(-1px);
    }

    button#fetchBtn:disabled {
      background-color: #adb5bd;
      color: #fff;
      cursor: not-allowed;
      opacity: 0.8;
      box-shadow: none;
      transform: none;
    }

    /* Status Badge styled as a button */
    #status { /* Container for the badge */
       display: flex;
       align-items: center;
       margin: 0;
       padding: 0;
    }
    #statusBadge {
      /* Inherit shared styles */
      background-color: #6c757d; /* Default: Waiting state (gray) */
      color: white;
      cursor: default; /* Not clickable like the button */
    }
    #statusBadge.connected {
      background-color: var(--color-success);
      color: white;
    }
    #statusBadge.fetching {
      background-color: var(--color-info);
      color: var(--color-text-primary); /* Darker text on light blue */
    }
    #statusBadge.error {
      background-color: var(--color-danger);
      color: white;
    }
     /* Remove hover/active effects from status */
    #statusBadge:hover {
        transform: none;
        box-shadow: var(--shadow-button); /* Keep shadow consistent */
    }


    /* --- Data Sections --- */
    .data-section {
      padding: 0.625rem 0.875rem; /* Slightly reduced padding */
      border-bottom: 1px solid var(--color-border);
    }
    .data-section:last-child { border-bottom: none; }

    /* Header Section within Card */
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .title-date-container { display: flex; flex-direction: column; }

    .address-title {
      font-size: 1rem; /* 16px */
      font-weight: 700;
      margin: 0 0 0.2rem 0;
      color: var(--color-primary);
      white-space: nowrap; /* Keep title on one line */
    }

    .date-time {
      margin: 0;
      font-size: var(--font-size-sm); /* 12px */
      color: var(--color-text-secondary);
      line-height: 1.3;
    }
    .date-time p {
      margin: 0.05rem 0; /* Very tight */
      white-space: nowrap;
    }
    .date-time b {
       font-weight: 400;
       color: var(--color-text-secondary);
    }
    .date-time span {
        color: var(--color-text-primary);
        font-weight: 600;
    }

    .logo-container {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .logo-container img {
      height: 40px; /* USER FEEDBACK: Reduced logo size */
      width: auto;
      display: block;
      border-radius: var(--border-radius-sm);
    }

    /* Main Data Layout (Wind/Logger) */
    .wind-logger-container {
      display: flex;
      justify-content: space-between;
      gap: 0.75rem; /* 12px */
    }

    .wind-column { width: 60%; flex-shrink: 0; }
    .logger-column {
      width: 40%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      gap: 0.5rem; /* 8px */
    }

    /* Big Temp Box - Revised Style */
    .big-temp-box {
      width: 100%;
      min-height: 60px; /* Slightly reduced min height */
      padding: 0.4rem 0.5rem; /* Reduced padding */
      border: none; /* Removed border */
      border-radius: var(--border-radius-md);
      background-color: #6c757d;
      color: white; /* USER FEEDBACK: Always white text */
      font-family: var(--font-family-base);
      text-align: center;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      transition: background-color 0.3s ease, transform 0.3s ease-in-out;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1); /* Softer shadow */
      /* USER FEEDBACK: Ensure contrast */
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.4);
    }

    .big-temp-box.updated { animation: pulse 0.3s ease-in-out; }

    .big-temp-box span.value {
      font-size: 1.125rem; /* 18px - Reduced */
      font-weight: 700;
      line-height: 1.1;
      display: block;
    }

    .big-temp-box span.label {
      font-size: var(--font-size-sm); /* 12px */
      font-weight: 600;
      line-height: 1.2;
      margin-top: 0.1rem;
      opacity: 0.9;
      display: block;
    }

    /* Dynamic Background Colors for Big Temp Box ( Adjusted based on image) */
    /* Air Temp */
    .big-temp-box#airTempBox.temp-cold { background-color: #0aadef; } /* Light Blue */
    .big-temp-box#airTempBox.temp-cool { background-color: #0dcaf0; } /* Cyan */
    .big-temp-box#airTempBox.temp-mild { background-color: #2eb350; } /* Target Image Green */
    .big-temp-box#airTempBox.temp-warm { background-color: #ffc107; } /* Yellow */
    .big-temp-box#airTempBox.temp-hot { background-color: #dc3545; } /* Red */
    /* Radiant Diff */
    .big-temp-box#radiantDiffBox.diff-positive { background-color: #fd7e14; } /* Orange */
    .big-temp-box#radiantDiffBox.diff-negative { background-color: var(--color-purple); } /* Target Image Purple */
    /* Dew Diff */
    .big-temp-box#dewDiffBox.dew-dry { background-color: #d63384; } /* Pinkish */
    .big-temp-box#dewDiffBox.dew-humid { background-color: var(--color-teal); } /* Target Image Teal */
    .big-temp-box#dewDiffBox.dew-neutral { background-color: #6c757d; } /* Gray */


    /* Rain Container */
    .rain-container {
      margin-top: 0.5rem; /* Reduced space */
      padding: 0.4rem 0.5rem; /* Reduced padding */
      border: 1px solid var(--color-border);
      border-radius: var(--border-radius-sm);
      background: #f8f9fa;
    }
    .rain-container p { margin: 0.1rem 0; }

    /* Two Column Layouts */
    .two-col-container {
      display: flex;
      justify-content: space-between;
      gap: 0.75rem; /* 12px */
    }
    .two-col-container > div { width: calc(50% - 0.375rem); }
    /* Apply nowrap to specific columns */
    .evap-col p, .battery-col p, .soiltemp-col p, .moisture-col p, .data-section > p /* Vector Wind */ {
        /* white-space: nowrap; */ /* Let general p handle this now */
        /* overflow: hidden; */
        /* text-overflow: ellipsis; */
    }


    /* --- Utility Classes for Dynamic Styling (Keep as is) --- */
    .text-bold { font-weight: 700 !important; }
    .text-semibold { font-weight: 600 !important; }
    /* Temp colors for inline text values */
    .temp-very-cold { color: #104E8B !important; }
    .temp-cold { color: #4682B4 !important; }
    .temp-cool { color: #32CD32 !important; }
    .temp-mild { color: #228B22 !important; }
    .temp-warm { color: #D4A017 !important; }
    .temp-hot { color: #FF4500 !important; }
    .temp-very-hot { color: #B22222 !important; }
    /* Other dynamic styles */
    .rain-significant { color: #1E90FF !important; font-weight: 600 !important; }
    .solar-low { color: #27408B !important; }
    .solar-med { color: #DAA520 !important; font-weight: 600 !important; }
    .solar-high { color: #BF360C !important; font-weight: 600 !important; }
    .solar-very-high { color: #B71C1C !important; font-weight: 600 !important; }
    .solar-zero { color: #000033 !important; }
    .pressure-high { color: green !important; font-weight: 600 !important; }
    .battery-ok { color: green !important; }
    .battery-full { color: green !important; font-weight: 600 !important; }
    .battery-low { color: red !important; }
    .charge-positive { color: green !important; }
    .charge-negative { color: red !important; }
    .wind-gust-high { color: red !important; font-weight: 600 !important; }
    .wind-gust-med { color: #FF8C00 !important; font-weight: 600 !important; }
    .moisture-dry { color: #FF8C00 !important; font-weight: 600 !important; }


    /* --- Spinner --- */
    .spinner-container {
      display: none;
      margin: 1.25rem auto;
      width: 30px; /* Smaller spinner */
      height: 30px;
      position: relative;
    }
    .spinner {
      width: 100%; height: 100%;
      border: 3px solid rgba(0, 0, 0, 0.1);
      border-top-color: var(--color-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

  </style>
</head>
<body>
  <div class="main-container">

    <!-- Sticky Header -->
    <div class="freeze-pane">
      <div class="header-box">
        <h2>Moore's LIVE Weather Data</h2>
      </div>
    </div>

    <!-- Weather Data Card -->
    <div id="weatherData">

      <!-- Control Button Bar -->
      <div class="control-bar">
        <div class="control-container">
          <div class="control-half">
            <button id="fetchBtn" class="button-style" onclick="manualFetch()">Current Readings</button>
          </div>
          <div class="control-half">
             <!-- Status text is now inside the styled span -->
             <p id="status">
                 <span id="statusBadge" class="button-style">Waiting...</span>
             </p>
          </div>
        </div>
      </div>

      <!-- Header Section -->
      <div class="data-section header-content">
        <div class="title-date-container">
          <div class="address-title">WEST WARWICK, QLD</div>
          <div class="date-time">
            <!-- Emojis directly in HTML -->
            <p>📅 <span id="dateVal">-- / -- / ---- (---)</span></p>
            <p>⏰ <span id="timeVal">-- : -- : --</span> AEST</p> <!-- AEST Moved outside span -->
          </div>
        </div>
        <div class="logo-container">
          <img src="/Weather_Station_App.png" alt="Weather Station Icon">
          <img src="/Station_Label.png" alt="Environdata Weather Maestro">
        </div>
      </div>

      <!-- Main Data Columns Section -->
      <div class="data-section wind-logger-container">
        <div class="wind-column">
          <!-- Emojis in HTML, labels via <b> -->
          <p><b>💨 Wind Speed:</b> <span id="windSpeedVal">--</span> km/h</p>
          <p><b>🧭 Wind Direction:</b> <span id="windDirDegVal">--</span>° (<span id="windDirTextVal">--</span>)</p>
          <p><b>💦 Humidity:</b> <span id="humidityVal">--</span>% (<span id="humidityDescVal">--</span>)</p>
          <p><b>🌡️ Temperature:</b> <span id="tempVal" class="temp-value">--°C</span> (<span id="tempDescVal">--</span>)</p>
          <p><b>☀️ Solar Radiation:</b> <span id="solarRadVal">--</span> W/m² <span id="solarEmoji"></span></p> <!-- Separate span for emoji -->
          <p><b>⚫ Black Globe Temp:</b> <span id="blackGlobeTempVal" class="temp-value">--</span>°C</p> <!-- Changed emoji -->
          <p><b>🌱 Garden Bed Temp:</b> <span id="gardenBedTempVal">--</span>°C</p>
          <p><b>🌀 Pressure:</b> <span id="pressureVal">--</span> hPa <span id="pressureEmoji"></span></p> <!-- Separate span for emoji -->
          <div class="rain-container">
            <p><b>🌧️ Rain Since 9AM:</b> <span id="rainSince9Val">--</span> mm</p>
            <p><b>💧 Rain In Last Min:</b> <span id="rainInLastMinVal">--</span> mm</p> <!-- Changed emoji -->
          </div>
        </div>
        <div class="logger-column">
          <div class="big-temp-box" id="airTempBox">
            <span class="value" id="bigTempVal">--°C</span>
            <span class="label">Air Temp</span>
          </div>
          <div class="big-temp-box" id="radiantDiffBox">
            <span class="value" id="radiantDiffVal">--°C</span>
            <span class="label" aria-label="Difference between radiant and air temperature">Rad. Heat Diff</span>
          </div>
          <div class="big-temp-box" id="dewDiffBox">
            <span class="value" id="dewDiffVal">--°C</span>
            <span class="label" aria-label="Temp above dew point">Temp > Dew P.</span>
          </div>
        </div>
      </div>

      <!-- Evaporation and Battery Section -->
      <div class="data-section two-col-container evap-battery">
        <div class="evap-col">
          <p><b>⤴️ Evap/Hr:</b> <span id="evapRateVal">--</span> mm/h</p>
          <p><b>⬆️ Daily Evap:</b> <span id="dailyEvapVal">--</span> mm</p>
          <p><b>💧 Dew Point:</b> <span id="dewPointVal">--</span>°C</p>
          <p><b>🌬️ Max WS Gust:</b> <span id="peakWindGustVal">--</span> km/h</p> <!-- Unit moved here -->
        </div>
        <div class="battery-col">
          <p><b>🔋 Battery:</b> <span id="batteryVal">--</span> V</p> <!-- Unit moved here -->
          <p><b>⚡ Load:</b> <span id="loadVal">--</span> mA</p> <!-- Unit moved here -->
          <p><b>☀️ Solar Panel:</b> <span id="solarPanelVal">--</span> V <span id="solarPanelEmoji"></span></p> <!-- Unit/emoji -->
          <p><b>🔌 Charge:</b> <span id="chargeVal">--</span> mA</p> <!-- Unit moved here -->
        </div>
      </div>

      <!-- Additional Data Section -->
      <div class="data-section">
         <p><b>🌿 Vector Wind Speed:</b> <span id="vectorWindSpeedVal">--</span> km/h</p> <!-- Changed emoji -->
         <p><b>🧭 Vector Wind Direction:</b> <span id="vectorWindDirDegVal">--</span>° (<span id="vectorWindDirTextVal">--</span>)</p>
      </div>

      <!-- Soil Moisture Section -->
      <div class="data-section two-col-container soil-moisture">
        <div class="soiltemp-col">
          <p><b>🌡️ S. Temp 10cm:</b> <span id="soilTemp10Val">--</span>°C</p>
          <p><b>🌡️ S. Temp 20cm:</b> <span id="soilTemp20Val">--</span>°C</p>
          <p><b>🌡️ S. Temp 30cm:</b> <span id="soilTemp30Val">--</span>°C</p>
          <p><b>🌡️ S. Temp 40cm:</b> <span id="soilTemp40Val">--</span>°C</p>
        </div>
        <div class="moisture-col">
          <p><b>💧 Moist. 10cm:</b> <span id="moisture10Val">--</span>%</p>
          <p><b>💧 Moist. 20cm:</b> <span id="moisture20Val">--</span>%</p>
          <p><b>💧 Moist. 30cm:</b> <span id="moisture30Val">--</span>%</p>
          <p><b>💧 Moist. 40cm:</b> <span id="moisture40Val">--</span>%</p>
        </div>
      </div>

    </div> <!-- End #weatherData Card -->

    <!-- Spinner -->
    <div id="spinnerContainer" class="spinner-container">
      <div class="spinner"></div>
    </div>

  </div> <!-- End .main-container -->

  <script>
    /********************
    * HELPER FUNCTIONS *
    ********************/
    function getWindDirection(degrees) {
        const directions = ["N", "NNE", "NE", "ENE", "E", "ESE", "SE", "SSE",
                            "S", "SSW", "SW", "WSW", "W", "WNW", "NW", "NNW"];
        // Ensure degrees is a number and handle potential NaN or non-numeric input
        const numericDegrees = parseFloat(degrees);
        if (isNaN(numericDegrees)) {
            return "--"; // Return a default value if input is not a valid number
        }
        // Normalize degrees to be within 0-360 range
        const normalizedDegrees = (numericDegrees % 360 + 360) % 360;
        return directions[Math.round(normalizedDegrees / 22.5) % 16];
    }

    function formatDateString(dateStr) {
        if (!dateStr || typeof dateStr !== 'string') return "-- / -- / ---- (---)"; // Handle null/undefined/wrong type
        const parts = dateStr.split("/");
        if (parts.length === 3) {
            const [year, month, day] = parts;
            // Basic validation for numeric parts
            if (!/^\d+$/.test(year) || !/^\d+$/.test(month) || !/^\d+$/.test(day)) {
                 return `${dateStr} (Invalid)`;
            }
            const formattedDate = `${day.padStart(2, '0')}/${month.padStart(2, '0')}/${year}`; // Pad day/month
            // Be careful with Date constructor parsing YY format, ensure year is YYYY
            const yearNum = parseInt(year);
            const fullYear = yearNum < 100 ? (yearNum >= 70 ? 1900 + yearNum : 2000 + yearNum) : yearNum; // Simple 2-digit year assumption

            const dateObj = new Date(fullYear, parseInt(month) - 1, parseInt(day)); // Month is 0-indexed
            const dayNames = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];

            if (!isNaN(dateObj.getTime()) && dateObj.getDate() == parseInt(day) && (dateObj.getMonth() + 1) == parseInt(month)) { // Validate date object creation
                return `${formattedDate} (${dayNames[dateObj.getDay()]})`;
            } else {
                 return `${formattedDate} (Invalid Date)`; // Indicate if parsing failed
            }
        }
        return `${dateStr} (Unknown Format)`; // Fallback for unexpected format
    }

    function setStatusBadge(statusText, statusClass) {
        const badge = document.getElementById("statusBadge");
        if (badge) {
            let displayStatus = statusText;
            if (statusClass === 'fetching') {
                 displayStatus = statusText.startsWith('Retrying') ? 'Retrying...' : 'Fetching...';
            } else if (statusClass === 'error') {
                 displayStatus = 'Error';
            } else if (statusClass === 'connected') {
                 displayStatus = 'Connected';
            }

            badge.textContent = displayStatus;
            badge.className = `button-style ${statusClass}`;
        } else {
            console.warn("statusBadge element not found");
        }
    }

    // --- REVISED DYNAMIC CLASS FUNCTIONS ---
    function getTemperatureInfo(temp) {
      let desc = ""; let className = "";
      const tempNum = parseFloat(temp); // Ensure numeric comparison
       if (isNaN(tempNum)) return { desc: "--", className: "" };

      if (tempNum < -10) { desc = "Severely cold"; className = "temp-very-cold"; }
      else if (tempNum < 0) { desc = "Extremely cold"; className = "temp-very-cold"; }
      else if (tempNum < 6) { desc = "Very cold"; className = "temp-cold"; }
      else if (tempNum < 11) { desc = "Cold"; className = "temp-cold"; }
      else if (tempNum < 16) { desc = "Cool"; className = "temp-cool"; }
      else if (tempNum < 21) { desc = "Mild"; className = "temp-mild"; }
      else if (tempNum < 28) { desc = "Warm"; className = "temp-warm"; }
      else if (tempNum < 32) { desc = "Warmer"; className = "temp-hot"; }
      else if (tempNum < 36) { desc = "Hot"; className = "temp-hot"; }
      else if (tempNum < 41) { desc = "Very hot"; className = "temp-very-hot"; }
      else if (tempNum <= 60) { desc = "Extremely hot"; className = "temp-very-hot"; }
      else { desc = ""; className = ""; } // Default/fallback
      return { desc, className };
    }

    function getBigTempBoxAirClass(temp) {
       const tempNum = parseFloat(temp);
       if (isNaN(tempNum)) return '';
       if (tempNum < 6) return 'temp-cold';
       if (tempNum < 11) return 'temp-cool';
       if (tempNum < 21) return 'temp-mild';
       if (tempNum < 32) return 'temp-warm';
       return 'temp-hot';
    }

    function getRadiantDiffClass(diff) {
       const diffNum = parseFloat(diff);
       if (isNaN(diffNum)) return 'dew-neutral'; // Use neutral if NaN
       return diffNum >= 0 ? 'diff-positive' : 'diff-negative';
     }

     function getDewDiffClass(diff) {
        const diffNum = parseFloat(diff);
        if (isNaN(diffNum)) return 'dew-neutral';
        if (diffNum < 1.5) return 'dew-humid';
        // if (diffNum >= 3.0) return 'dew-dry'; // Optional
        return 'dew-neutral';
     }

    function getHumidityDesc(humidity) {
      const humNum = parseFloat(humidity);
      if (isNaN(humNum)) return "--";
      if (humNum <= 20) { return "Very Dry"; }
      else if (humNum <= 40) { return "Dry"; }
      else if (humNum <= 60) { return "Comfortable"; }
      else if (humNum <= 80) { return "Humid"; }
      else { return "Very Humid"; }
    }

    function getMoistureClass(val) {
        const valNum = parseFloat(val);
        if (isNaN(valNum)) return '';
        return (valNum < 20) ? "moisture-dry text-semibold" : "";
    }

    function getSolarRadiationClass(solarRad) {
        const radNum = parseFloat(solarRad);
        if (isNaN(radNum)) return '';
        if (radNum <= 0) return 'solar-zero';
        if (radNum <= 100) return 'solar-low';
        if (radNum <= 600) return 'solar-med';
        if (radNum <= 1100) return 'solar-high';
        return 'solar-very-high';
    }
    function getPressureClass(pressure) {
        const presNum = parseFloat(pressure);
        if (isNaN(presNum)) return '';
        return presNum >= 1020 ? 'pressure-high text-semibold' : '';
    }
    function getBatteryClass(voltage) {
        const voltNum = parseFloat(voltage);
        if (isNaN(voltNum)) return '';
        if (voltNum < 12.5) return 'battery-low text-semibold';
        if (voltNum >= 13.8) return 'battery-full text-semibold';
        return 'battery-ok';
    }
    function getChargeClass(charge, load, voltage) {
         const chargeNum = parseFloat(charge);
         const loadNum = parseFloat(load);
         const voltNum = parseFloat(voltage);
         if (isNaN(chargeNum) || isNaN(loadNum) || isNaN(voltNum)) return '';

         if (voltNum < 13.80) {
             return chargeNum > loadNum ? 'charge-positive text-semibold' : 'charge-negative text-semibold';
         }
         return '';
    }
    function getWindGustClass(gust) {
        const gustNum = parseFloat(gust);
        if (isNaN(gustNum)) return '';
        if (gustNum > 25) return 'wind-gust-high text-semibold';
        if (gustNum > 10) return 'wind-gust-med text-semibold';
        return '';
    }
    function getRainClass(rainAmount) {
        const rainNum = parseFloat(rainAmount);
        if (isNaN(rainNum)) return '';
        return rainNum >= 0.2 ? 'rain-significant text-semibold' : '';
    }


    /*****************************
    * GLOBAL STATE & RETRIES *
    *****************************/
    let initialLoadComplete = false;
    let refreshTimeout = null; // Initialize to null
    let retryAttempts = 0;
    const MAX_RETRY_ATTEMPTS = 3;
    const WEATHER_ENDPOINT = "/weather"; // Make sure this endpoint is correct


    /*****************************
    * MAIN UPDATE FUNCTION *
    *****************************/
    function updateWeatherData(data) {
      console.log("Received data, attempting update..."); // Log start
      if (typeof data !== 'string' || data.trim() === '') {
          console.error("Invalid or empty data received for processing.");
           setStatusBadge("Data Error", "error");
           return;
      }

      // More robust split, handling potential extra commas or whitespace
      const lines = data.replace(/r3\r?\n?/, "").trim().split(",").map(s => s.trim());
      console.log(`Parsed ${lines.length} fields.`);

      // Check minimum expected fields
      if (lines.length < 31) { // Adjusted to 31 based on last index used (30)
        console.error(`Incomplete data: Expected at least 31 fields, got ${lines.length}. Data:`, data);
         setStatusBadge("Data Error", "error");
        return;
      }

      try {
        // --- Helper function to get numeric value or NaN ---
        const getNum = (index) => parseFloat(lines[index]);

        // --- Extract Data (Using helper for safety) ---
        const dateStr = lines[0];
        const timeStr = lines[1];
        const windSpeed = getNum(2);
        const windDirDeg = getNum(3);
        const humidityRaw = getNum(4);
        const temperatureRaw = getNum(5);
        let rainInLastMinRaw = getNum(6);
        const solarRadRaw = getNum(7);
        const pressureRaw = getNum(8);
        const gardenBedTemp = getNum(9);
        const batteryVoltageVal = getNum(10);
        const loadCurrent = getNum(11);
        const rawSolarVoltage = getNum(12);
        const chargeCurrent = getNum(13);
        const peakWindGustVal = getNum(14);
        const vectorWindSpeedVal = getNum(15);
        const vectorWindDirVal = getNum(16);
        const rainSince9 = getNum(17);
        const evapRate = getNum(18);
        // Index 19 seems skipped in original, check data source if needed
        const dailyEvap = getNum(20);
        const dewPoint = getNum(21);
        const soilTemp10 = getNum(22);
        const soilTemp20 = getNum(23);
        const soilTemp30 = getNum(24);
        const soilTemp40 = getNum(25);
        const moisture10Val = getNum(26);
        const moisture20Val = getNum(27);
        const moisture30Val = getNum(28);
        const moisture40Val = getNum(29);
        const blackGlobeTemp = getNum(30);

        // --- Validate Core Data (Check for NaN) ---
         if (isNaN(windSpeed) || isNaN(windDirDeg) || isNaN(humidityRaw) || isNaN(temperatureRaw) || isNaN(pressureRaw) || isNaN(blackGlobeTemp)) {
            console.error("Invalid core numeric data received (NaN found).");
            // Log which specific values are NaN if needed
            console.log({ windSpeed, windDirDeg, humidityRaw, temperatureRaw, pressureRaw, blackGlobeTemp });
            setStatusBadge("Data Error", "error");
            return;
        }

        // --- Update DOM Elements using textContent and classList ---
        // Helper to update text and classes safely
        function updateElement(id, value, baseClass = '', dynamicClass = '') {
          const element = document.getElementById(id);
          if (element) {
            // Format numbers, handle NaN
            let displayValue = value;
            if (typeof value === 'number' && isNaN(value)) {
                displayValue = "--"; // Display placeholder for NaN numbers
            } else if (typeof value === 'number') {
                // Apply default formatting if needed, but often done before calling
            } else if (value === null || typeof value === 'undefined') {
                 displayValue = "--"; // Placeholder for null/undefined
            }

            element.textContent = displayValue;

            // Combine base and dynamic classes
            const classesToAdd = [];
            if (baseClass) classesToAdd.push(...baseClass.split(' ').filter(Boolean));
            if (dynamicClass) classesToAdd.push(...dynamicClass.split(' ').filter(Boolean));
            element.className = classesToAdd.join(' ');
          } else {
            // Log only once per missing ID to avoid flooding console? Or just log it.
             console.warn(`Element with id "${id}" not found.`);
          }
        }

         // Helper to update only classes
         function updateElementClass(id, baseClass = '', dynamicClass = '') {
             const element = document.getElementById(id);
             if (element) {
                const classesToAdd = [];
                if (baseClass) classesToAdd.push(...baseClass.split(' ').filter(Boolean));
                if (dynamicClass) classesToAdd.push(...dynamicClass.split(' ').filter(Boolean));
                element.className = classesToAdd.join(' ');
             } else {
                 console.warn(`Element class update failed: id "${id}" not found.`);
             }
         }

        // DATE & TIME
        updateElement("dateVal", formatDateString(dateStr));
        updateElement("timeVal", timeStr || "--:--:--"); // Provide fallback for time

        // WIND
        updateElement("windSpeedVal", windSpeed.toFixed(1));
        updateElement("windDirDegVal", windDirDeg.toFixed(1));
        updateElement("windDirTextVal", getWindDirection(windDirDeg));

        // HUMIDITY
        updateElement("humidityVal", humidityRaw.toFixed(1));
        updateElement("humidityDescVal", getHumidityDesc(humidityRaw));

        // TEMPERATURE
        const tempInfo = getTemperatureInfo(temperatureRaw);
        updateElement("tempVal", isNaN(temperatureRaw) ? '--°C' : temperatureRaw.toFixed(1) + "°C", 'temp-value', tempInfo.className);
        updateElement("tempDescVal", tempInfo.desc);

        // BIG TEMP BOX - AIR
        const airTempBoxClass = getBigTempBoxAirClass(temperatureRaw);
        updateElement("bigTempVal", isNaN(temperatureRaw) ? '--°C' : temperatureRaw.toFixed(1) + "°C", 'value');
        updateElementClass("airTempBox", 'big-temp-box updated', airTempBoxClass);

        // SOLAR RADIATION
        const solarRad = Math.max(0, solarRadRaw); // Ensure non-negative
        updateElement("solarRadVal", isNaN(solarRad) ? '--' : solarRad.toFixed(1), '', getSolarRadiationClass(solarRad));
        updateElement("solarEmoji", isNaN(solarRad) ? '' : (solarRad < 10 ? "🌙" : "☀️"));

        // BLACK GLOBE TEMP & RADIANT DIFF
        const globeTempInfo = getTemperatureInfo(blackGlobeTemp);
        updateElement("blackGlobeTempVal", isNaN(blackGlobeTemp) ? '--' : blackGlobeTemp.toFixed(1), 'temp-value', globeTempInfo.className);

        const radiantDiff = blackGlobeTemp - temperatureRaw; // Will be NaN if either is NaN
        const radiantDiffFormatted = isNaN(radiantDiff) ? '--°C' : (radiantDiff >= 0 ? "+" : "") + radiantDiff.toFixed(1) + "°C";
        const radiantDiffClass = getRadiantDiffClass(radiantDiff);
        updateElement("radiantDiffVal", radiantDiffFormatted, 'value');
        updateElementClass("radiantDiffBox", 'big-temp-box updated', radiantDiffClass);

         // TEMP ABOVE DEW POINT
         const dewDiff = temperatureRaw - dewPoint; // Can be NaN
         const dewFormatted = isNaN(dewDiff) ? '--°C' : (dewDiff >= 0 ? "+" : "") + dewDiff.toFixed(1) + "°C";
         const dewDiffClass = getDewDiffClass(dewDiff);
         updateElement("dewDiffVal", dewFormatted, 'value');
         updateElementClass("dewDiffBox", 'big-temp-box updated', dewDiffClass);

        // GARDEN BED TEMP
        updateElement("gardenBedTempVal", isNaN(gardenBedTemp) ? '--' : gardenBedTemp.toFixed(1));

        // PRESSURE
        let adjustedPressure = pressureRaw - 1.9; // Can be NaN
        updateElement("pressureVal", isNaN(adjustedPressure) ? '--' : adjustedPressure.toFixed(1), '', getPressureClass(adjustedPressure));
        updateElement("pressureEmoji", isNaN(adjustedPressure) ? '' : (adjustedPressure >= 1020 ? "🐟" : ""));

        // RAIN
         rainInLastMinRaw = isNaN(rainInLastMinRaw) ? 0.0 : rainInLastMinRaw; // Default NaN rain to 0
         updateElement("rainSince9Val", isNaN(rainSince9) ? '--' : rainSince9.toFixed(1), '', getRainClass(rainSince9));
         updateElement("rainInLastMinVal", rainInLastMinRaw.toFixed(1), '', getRainClass(rainInLastMinRaw)); // Already handled NaN

        // BATTERY & CHARGE
        updateElement("batteryVal", isNaN(batteryVoltageVal) ? '--' : batteryVoltageVal.toFixed(1), '', getBatteryClass(batteryVoltageVal));
        updateElement("loadVal", isNaN(loadCurrent) ? '--' : loadCurrent.toFixed(1));

        updateElement("solarPanelVal", isNaN(rawSolarVoltage) ? '--' : rawSolarVoltage.toFixed(1));
        updateElement("solarPanelEmoji", isNaN(rawSolarVoltage) || isNaN(batteryVoltageVal) ? '' : (rawSolarVoltage < batteryVoltageVal ? "🌙" : "☀️"));

        updateElement("chargeVal", isNaN(chargeCurrent) ? '--' : chargeCurrent.toFixed(1), '', getChargeClass(chargeCurrent, loadCurrent, batteryVoltageVal));

        // PEAK WIND GUST
        updateElement("peakWindGustVal", isNaN(peakWindGustVal) ? '--' : peakWindGustVal.toFixed(1), '', getWindGustClass(peakWindGustVal));

        // VECTOR WIND
        updateElement("vectorWindSpeedVal", isNaN(vectorWindSpeedVal) ? '--' : vectorWindSpeedVal.toFixed(1));
        updateElement("vectorWindDirDegVal", isNaN(vectorWindDirVal) ? '--' : vectorWindDirVal.toFixed(1));
        updateElement("vectorWindDirTextVal", getWindDirection(vectorWindDirVal));

        // EVAP & DEW POINT
        updateElement("evapRateVal", isNaN(evapRate) ? '--' : evapRate.toFixed(3));
        updateElement("dailyEvapVal", isNaN(dailyEvap) ? '--' : dailyEvap.toFixed(3));
        updateElement("dewPointVal", isNaN(dewPoint) ? '--' : dewPoint.toFixed(1));

        // SOIL TEMPS
        updateElement("soilTemp10Val", isNaN(soilTemp10) ? '--' : soilTemp10.toFixed(1));
        updateElement("soilTemp20Val", isNaN(soilTemp20) ? '--' : soilTemp20.toFixed(1));
        updateElement("soilTemp30Val", isNaN(soilTemp30) ? '--' : soilTemp30.toFixed(1));
        updateElement("soilTemp40Val", isNaN(soilTemp40) ? '--' : soilTemp40.toFixed(1));

        // SOIL MOISTURE
        updateElement("moisture10Val", isNaN(moisture10Val) ? '--' : moisture10Val.toFixed(1), '', getMoistureClass(moisture10Val));
        updateElement("moisture20Val", isNaN(moisture20Val) ? '--' : moisture20Val.toFixed(1), '', getMoistureClass(moisture20Val));
        updateElement("moisture30Val", isNaN(moisture30Val) ? '--' : moisture30Val.toFixed(1), '', getMoistureClass(moisture30Val));
        updateElement("moisture40Val", isNaN(moisture40Val) ? '--' : moisture40Val.toFixed(1), '', getMoistureClass(moisture40Val));

        // Remove pulse animation class after it runs
        setTimeout(() => {
            document.querySelectorAll('.big-temp-box.updated').forEach(el => el.classList.remove('updated'));
        }, 400);

        console.log("DOM update completed successfully."); // Log success

      } catch (error) {
        console.error("Error during updateWeatherData execution:", error);
         setStatusBadge("Processing Error", "error");
      }
    }


    /*****************************
    * FETCH & AUTO-REFRESH LOGIC *
    *****************************/
    function fetchWeather() {
        console.log("fetchWeather called. Attempt:", retryAttempts + 1);
        const spinnerContainer = document.getElementById("spinnerContainer");
        const fetchBtn = document.getElementById("fetchBtn");

        setStatusBadge(retryAttempts > 0 ? `Retrying ${retryAttempts}/${MAX_RETRY_ATTEMPTS}` : "Fetching", "fetching");
        if(spinnerContainer) spinnerContainer.style.display = "block";
        if(fetchBtn) fetchBtn.disabled = true;

        // Clear previous timeout if any (e.g., from manual fetch)
        if (refreshTimeout) {
            clearTimeout(refreshTimeout);
            refreshTimeout = null;
        }

        fetch(WEATHER_ENDPOINT)
            .then(response => {
                console.log(`Fetch response status: ${response.status}`);
                if (!response.ok) {
                    // Throw an error with status text to be caught below
                    throw new Error(`Server error: ${response.status} ${response.statusText || 'Unknown Status'}`);
                }
                return response.text(); // Get response body as text
            })
            .then(data => {
                console.log("Fetch successful, data received.");
                updateWeatherData(data); // Process the data
                setStatusBadge("Connected", "connected");
                retryAttempts = 0; // Reset retries on success
                if (!initialLoadComplete) {
                    initialLoadComplete = true;
                    console.log("Initial load complete.");
                }
                scheduleNextFetch(); // Schedule the next automatic refresh
            })
            .catch(error => {
                console.error("Fetch error:", error.message); // Log the specific error
                retryAttempts++;

                if (retryAttempts >= MAX_RETRY_ATTEMPTS) {
                    setStatusBadge(`Error (${retryAttempts})`, "error");
                    console.log(`Max retries (${MAX_RETRY_ATTEMPTS}) reached. Scheduling longer retry...`);
                    // Schedule a longer retry (e.g., 30 seconds) after max attempts
                    const retryDelay = 30000;
                    refreshTimeout = setTimeout(fetchWeather, retryDelay); // Still try again later
                } else {
                    // Use 'fetching' state visually during retry attempts
                    setStatusBadge(`Retrying ${retryAttempts}/${MAX_RETRY_ATTEMPTS}`, "fetching");
                    const retryDelay = retryAttempts === 1 ? 1500 : 3000; // Simple backoff
                    refreshTimeout = setTimeout(fetchWeather, retryDelay); // Schedule retry
                    console.log(`Scheduling retry in ${retryDelay}ms...`);
                }
            })
            .finally(() => {
                // Hide spinner ONLY if we are NOT about to retry immediately
                 if (retryAttempts === 0 || retryAttempts >= MAX_RETRY_ATTEMPTS) {
                      if(spinnerContainer) spinnerContainer.style.display = "none";
                      if(fetchBtn) fetchBtn.disabled = false; // Re-enable button after final attempt or success
                 }
                 console.log("Fetch sequence finished (finally block).");
            });
    }

    function scheduleNextFetch() {
        // Clear any existing timeout before scheduling a new one
        if (refreshTimeout) {
            clearTimeout(refreshTimeout);
        }

        const now = new Date();
        const seconds = now.getSeconds();
        const millis = now.getMilliseconds();
        const targetSecond = 20; // Target second past the minute

        // Calculate delay to the next targetSecond
        let delay;
        if (seconds < targetSecond) {
            delay = (targetSecond - seconds) * 1000 - millis;
        } else {
            // Need to go to targetSecond of the *next* minute
            delay = (60 - seconds + targetSecond) * 1000 - millis;
        }

        // Ensure a minimum reasonable delay (e.g., 1 second) to prevent rapid loops if calculation is slightly off
        delay = Math.max(1000, delay);

        console.log(`Scheduling next fetch in ${Math.round(delay/1000)} seconds (at second ${targetSecond}).`);
        refreshTimeout = setTimeout(fetchWeather, delay);
    }

    function manualFetch() {
        console.log("Manual fetch triggered.");
        if (refreshTimeout) {
            clearTimeout(refreshTimeout); // Stop any scheduled fetch
            refreshTimeout = null;
        }
        retryAttempts = 0; // Reset retries on manual fetch
        fetchWeather(); // Fetch immediately
    }

    // Initial Load on window load
    window.addEventListener("load", () => {
        console.log("Window loaded, initiating first fetch.");
        // Set initial status badge state explicitly
        setStatusBadge("Waiting...", ""); // Default gray state
        fetchWeather(); // Start the process
    });

  </script>
</body>
</html>