<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Live weather data from Moore's Weather Station in West Warwick, QLD.">
  <title>Moore's LIVE Weather Data</title>

  <link rel="apple-touch-icon" href="/Weather_Station_App.png">
  <link rel="icon" href="/favicon.ico"> <!-- Optional: Add a favicon -->

  <!-- Google Fonts: Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    /* --- Base Styles & Variables --- */
    :root {
      --font-family-base: "Inter", "system-ui", "Segoe UI", "Helvetica Neue", Arial, sans-serif;
      --color-background: #f8f9fa;
      --color-card-bg: #ffffff;
      --color-text-primary: #212529;
      --color-text-secondary: #555; /* Slightly darker secondary */
      --color-primary: #1e3a8a; /* Header blue */
      --color-accent: #FFA500; /* Orange */
      --color-accent-darker: #e59400;
      --color-accent-text: #4A4A4A;
      --color-border: #e9ecef;
      --color-success: #198754; /* Green */
      --color-success-darker: #146c43;
      --color-warning: #ffc107;
      --color-danger: #dc3545;
      --color-info: #0dcaf0; /* For fetching/retrying */
      --color-info-darker: #0a58ca;
      --color-purple: #6f42c1; /* For Rad Heat Diff negative */
      --color-teal: #20c997;  /* For Temp > Dew P */
      --border-radius-sm: 0.25rem; /* Slightly smaller radius */
      --border-radius-md: 0.5rem;
      --border-radius-lg: 0.6rem;
      --shadow-card: 0 3px 8px rgba(0, 0, 0, 0.07); /* Softer shadow */
      --shadow-button: 0 1px 3px rgba(0, 0, 0, 0.15); /* Softer shadow */

      /* == Font size reduction == */
      --font-size-base: 0.75rem; /* 12px */
      --font-size-sm: 0.6875rem;  /* 11px */
      --font-size-lg: 0.9375rem;  /* 15px */
      --font-size-xl: 1.0625rem;  /* 17px */
      --font-size-value: 1rem;    /* 16px for Big Temp Box value */
    }

    html {
      font-size: 16px;
      box-sizing: border-box;
    }

    *, *:before, *:after {
      box-sizing: inherit;
    }

    body {
      margin: 0;
      background-color: var(--color-background);
      font-family: var(--font-family-base);
      font-size: var(--font-size-base); /* Use variable */
      font-weight: 400;
      line-height: 1.35; /* Tighter */
      letter-spacing: 0.05px; /* Less spacing */
      color: var(--color-text-primary);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
      padding-top: env(safe-area-inset-top, 0);
    }

    .main-container {
      max-width: 400px;
      /* == Reduce vertical margins == */
      margin: 0.5rem auto;
      padding: 0 0.3125rem;
    }

    /* Apply nowrap/ellipsis broadly first */
    p {
      /* == Reduce vertical margins == */
      margin: 0.125rem 0; /* Very tight paragraph spacing */
      line-height: 1.3; /* Tighter */
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      min-height: 1.3em; /* Ensure consistent line height visually */
    }
     /* Allow specific descriptions to wrap if needed */
    #humidityDescVal, #tempDescVal {
        white-space: normal;
        overflow: visible;
        text-overflow: clip;
        min-height: auto; /* Override min-height */
    }


    b, strong {
      font-weight: 600;
      color: var(--color-text-secondary);
      margin-right: 0.25em;
    }

    /* --- Animations (Keep as is) --- */
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.03); } 100% { transform: scale(1); } }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* --- Layout Components --- */
    .freeze-pane {
      position: sticky;
      top: env(safe-area-inset-top, 0);
      z-index: 100;
      background: var(--color-background);
      padding: 0;
      margin-bottom: 0;
    }

    .header-box {
      background-color: var(--color-primary);
      border-radius: var(--border-radius-md) var(--border-radius-md) 0 0;
      /* == Reduce padding == */
      padding: 0.4rem 0.6rem;
      text-align: center;
    }

    .header-box h2 {
      margin: 0;
      font-size: var(--font-size-lg); /* 15px */
      font-weight: 700;
      color: white;
      white-space: nowrap;
    }

    #weatherData {
      background: var(--color-card-bg);
      padding: 0;
      border-radius: 0 0 var(--border-radius-lg) var(--border-radius-lg);
      box-shadow: var(--shadow-card);
      font-size: var(--font-size-base);
      color: var(--color-text-primary);
      text-align: left;
      /* == Reduce bottom margin == */
      margin-bottom: 0.75rem;
    }

    /* --- Control Bar & Buttons --- */
    .control-bar {
      /* == Reduce padding == */
      padding: 0.5rem 0.6rem;
      border-bottom: 1px solid var(--color-border);
    }

    .control-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      /* == Reduce gap == */
      gap: 0.5rem;
    }

    .control-half { display: flex; align-items: center; }
    .control-half:first-child { justify-content: flex-start; }
    .control-half:last-child { justify-content: flex-end; }

    /* Shared button/status styles */
    .button-style {
      /* == Reduce padding & font size == */
      padding: 0.4rem 0.7rem;
      font-size: var(--font-size-base); /* 12px */
      font-weight: 600;
      font-family: var(--font-family-base);
      border: none;
      border-radius: var(--border-radius-sm);
      cursor: pointer;
      transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
      display: inline-block;
      white-space: nowrap;
      line-height: 1.2;
      letter-spacing: 0.2px; /* Slightly tighter */
      text-align: center;
      box-shadow: var(--shadow-button);
    }

    button#fetchBtn { background-color: var(--color-accent); color: var(--color-accent-text); }
    button#fetchBtn:hover { background-color: var(--color-accent-darker); transform: translateY(-1px); }
    button#fetchBtn:disabled { background-color: #adb5bd; color: #fff; cursor: not-allowed; opacity: 0.8; box-shadow: none; transform: none; }

    /* Status Badge styled as a button */
    #status { display: flex; align-items: center; margin: 0; padding: 0; }
    #statusBadge { background-color: #6c757d; color: white; cursor: default; }
    #statusBadge.connected { background-color: var(--color-success); color: white; }
    #statusBadge.fetching { background-color: var(--color-info); color: var(--color-text-primary); }
    #statusBadge.error { background-color: var(--color-danger); color: white; }
    #statusBadge:hover { transform: none; box-shadow: var(--shadow-button); }


    /* --- Data Sections --- */
    .data-section {
      /* == Reduce padding == */
      padding: 0.4rem 0.7rem;
      border-bottom: 1px solid var(--color-border);
    }
    .data-section:last-child { border-bottom: none; }

    /* Header Section within Card */
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      /* == Reduce gap == */
      gap: 0.5rem;
    }

    .title-date-container { display: flex; flex-direction: column; }

    .address-title {
      font-size: 0.9375rem; /* 15px */
      font-weight: 700;
      margin: 0 0 0.1rem 0; /* Tighter margin */
      color: var(--color-primary);
      white-space: nowrap;
    }

    .date-time {
      margin: 0;
      font-size: var(--font-size-sm); /* 11px */
      color: var(--color-text-secondary);
      line-height: 1.25; /* Tighten */
    }
    .date-time p { margin: 0; white-space: nowrap; } /* Even tighter */
    .date-time b { font-weight: 400; color: var(--color-text-secondary); }
    .date-time span { color: var(--color-text-primary); font-weight: 600; }

    .logo-container {
      display: flex;
      gap: 0.4rem; /* Tighter */
      align-items: center;
    }

    .logo-container img {
      height: 35px; /* Further reduce logo */
      width: auto;
      display: block;
      border-radius: var(--border-radius-sm);
    }

    /* == Main Data Layout (Wind/Logger) - ADJUSTED WIDTHS == */
    .wind-logger-container {
      display: flex;
      justify-content: space-between;
      /* == Reduce gap == */
      gap: 0.5rem; /* 8px */
    }

    .wind-column { width: 68%; flex-shrink: 0; } /* More space for text */
    .logger-column {
      width: 32%; /* Less space for boxes */
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      /* == Reduce gap == */
      gap: 0.3rem; /* Tighter stack */
    }

    /* == Big Temp Box - Tighter == */
    .big-temp-box {
      width: 100%;
      /* == Reduce min height & padding == */
      min-height: 50px;
      padding: 0.25rem 0.4rem;
      border: none;
      border-radius: var(--border-radius-md);
      background-color: #6c757d;
      color: white;
      font-family: var(--font-family-base);
      text-align: center;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      transition: background-color 0.3s ease, transform 0.3s ease-in-out;
      box-shadow: 0 1px 2px rgba(0,0,0,0.08); /* Softer shadow */
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.4);
    }

    .big-temp-box.updated { animation: pulse 0.3s ease-in-out; }

    .big-temp-box span.value {
      /* == Reduce font size == */
      font-size: var(--font-size-value); /* 16px */
      font-weight: 700;
      line-height: 1.1;
      display: block;
    }

    .big-temp-box span.label {
      font-size: var(--font-size-sm); /* 11px */
      font-weight: 600;
      line-height: 1.15; /* Tighten */
      margin-top: 0.05rem; /* Very small gap */
      opacity: 0.9;
      display: block;
    }

    /* Dynamic Background Colors for Big Temp Box (Keep as is) */
    .big-temp-box#airTempBox.temp-cold { background-color: #0aadef; }
    .big-temp-box#airTempBox.temp-cool { background-color: #0dcaf0; }
    .big-temp-box#airTempBox.temp-mild { background-color: #2eb350; }
    .big-temp-box#airTempBox.temp-warm { background-color: #ffc107; }
    .big-temp-box#airTempBox.temp-hot { background-color: #dc3545; }
    .big-temp-box#radiantDiffBox.diff-positive { background-color: #fd7e14; }
    .big-temp-box#radiantDiffBox.diff-negative { background-color: var(--color-purple); }
    .big-temp-box#dewDiffBox.dew-dry { background-color: #d63384; }
    .big-temp-box#dewDiffBox.dew-humid { background-color: var(--color-teal); }
    .big-temp-box#dewDiffBox.dew-neutral { background-color: #6c757d; }


    /* == Rain Container - Tighter == */
    .rain-container {
      /* == Reduce margins/padding == */
      margin-top: 0.3rem;
      padding: 0.25rem 0.4rem;
      border: 1px solid var(--color-border);
      border-radius: var(--border-radius-sm);
      background: #f8f9fa;
    }
    .rain-container p { margin: 0.05rem 0; } /* Tight */

    /* Two Column Layouts */
    .two-col-container {
      display: flex;
      justify-content: space-between;
      /* == Reduce gap == */
      gap: 0.5rem;
    }
    .two-col-container > div { width: calc(50% - 0.25rem); }


    /* --- Utility Classes for Dynamic Styling (Keep as is) --- */
    .text-bold { font-weight: 700 !important; }
    .text-semibold { font-weight: 600 !important; }
    .temp-very-cold { color: #104E8B !important; } .temp-cold { color: #4682B4 !important; } .temp-cool { color: #32CD32 !important; } .temp-mild { color: #228B22 !important; }
    .temp-warm { color: #D4A017 !important; } .temp-hot { color: #FF4500 !important; } .temp-very-hot { color: #B22222 !important; }
    .rain-significant { color: #1E90FF !important; font-weight: 600 !important; }
    .solar-low { color: #27408B !important; } .solar-med { color: #DAA520 !important; font-weight: 600 !important; } .solar-high { color: #BF360C !important; font-weight: 600 !important; }
    .solar-very-high { color: #B71C1C !important; font-weight: 600 !important; } .solar-zero { color: #000033 !important; }
    .pressure-high { color: green !important; font-weight: 600 !important; }
    .battery-ok { color: green !important; } .battery-full { color: green !important; font-weight: 600 !important; } .battery-low { color: red !important; }
    .charge-positive { color: green !important; } .charge-negative { color: red !important; }
    .wind-gust-high { color: red !important; font-weight: 600 !important; } .wind-gust-med { color: #FF8C00 !important; font-weight: 600 !important; }
    .moisture-dry { color: #FF8C00 !important; font-weight: 600 !important; }


    /* --- Spinner --- */
    .spinner-container { display: none; margin: 1.25rem auto; width: 30px; height: 30px; position: relative; }
    .spinner { width: 100%; height: 100%; border: 3px solid rgba(0, 0, 0, 0.1); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1s linear infinite; }

  </style>
</head>
<body>
  <!-- HTML Structure remains exactly the same as the previous version -->
  <div class="main-container">

    <!-- Sticky Header -->
    <div class="freeze-pane">
      <div class="header-box">
        <h2>Moore's LIVE Weather Data</h2>
      </div>
    </div>

    <!-- Weather Data Card -->
    <div id="weatherData">

      <!-- Control Button Bar -->
      <div class="control-bar">
        <div class="control-container">
          <div class="control-half">
            <button id="fetchBtn" class="button-style" onclick="manualFetch()">Current Readings</button>
          </div>
          <div class="control-half">
             <p id="status">
                 <span id="statusBadge" class="button-style">Waiting...</span>
             </p>
          </div>
        </div>
      </div>

      <!-- Header Section -->
      <div class="data-section header-content">
        <div class="title-date-container">
          <div class="address-title">WEST WARWICK, QLD</div>
          <div class="date-time">
            <p>ğŸ“… <span id="dateVal">-- / -- / ---- (---)</span></p>
            <p>â° <span id="timeVal">-- : -- : --</span> AEST</p>
          </div>
        </div>
        <div class="logo-container">
          <img src="/Weather_Station_App.png" alt="Weather Station Icon">
          <img src="/Station_Label.png" alt="Environdata Weather Maestro">
        </div>
      </div>

      <!-- Main Data Columns Section -->
      <div class="data-section wind-logger-container">
        <div class="wind-column">
          <p><b>ğŸ’¨ Wind Speed:</b> <span id="windSpeedVal">--</span> km/h</p>
          <p><b>ğŸ§­ Wind Direction:</b> <span id="windDirDegVal">--</span>Â° (<span id="windDirTextVal">--</span>)</p>
          <p><b>ğŸ’¦ Humidity:</b> <span id="humidityVal">--</span>% (<span id="humidityDescVal">--</span>)</p>
          <p><b>ğŸŒ¡ï¸ Temperature:</b> <span id="tempVal" class="temp-value">--Â°C</span> (<span id="tempDescVal">--</span>)</p>
          <p><b>â˜€ï¸ Solar Radiation:</b> <span id="solarRadVal">--</span> W/mÂ² <span id="solarEmoji"></span></p>
          <p><b>âš« Black Globe Temp:</b> <span id="blackGlobeTempVal" class="temp-value">--</span>Â°C</p>
          <p><b>ğŸŒ± Garden Bed Temp:</b> <span id="gardenBedTempVal">--</span>Â°C</p>
          <p><b>ğŸŒ€ Pressure:</b> <span id="pressureVal">--</span> hPa <span id="pressureEmoji"></span></p>
          <div class="rain-container">
            <p><b>ğŸŒ§ï¸ Rain Since 9AM:</b> <span id="rainSince9Val">--</span> mm</p>
            <p><b>ğŸ’§ Rain In Last Min:</b> <span id="rainInLastMinVal">--</span> mm</p>
          </div>
        </div>
        <div class="logger-column">
          <div class="big-temp-box" id="airTempBox">
            <span class="value" id="bigTempVal">--Â°C</span>
            <span class="label">Air Temp</span>
          </div>
          <div class="big-temp-box" id="radiantDiffBox">
            <span class="value" id="radiantDiffVal">--Â°C</span>
            <span class="label" aria-label="Difference between radiant and air temperature">Rad. Heat Diff</span>
          </div>
          <div class="big-temp-box" id="dewDiffBox">
            <span class="value" id="dewDiffVal">--Â°C</span>
            <span class="label" aria-label="Temp above dew point">Temp > Dew P.</span>
          </div>
        </div>
      </div>

      <!-- Evaporation and Battery Section -->
      <div class="data-section two-col-container evap-battery">
        <div class="evap-col">
          <p><b>â¤´ï¸ Evap/Hr:</b> <span id="evapRateVal">--</span> mm/h</p>
          <p><b>â¬†ï¸ Daily Evap:</b> <span id="dailyEvapVal">--</span> mm</p>
          <p><b>ğŸ’§ Dew Point:</b> <span id="dewPointVal">--</span>Â°C</p>
          <p><b>ğŸŒ¬ï¸ Max WS Gust:</b> <span id="peakWindGustVal">--</span> km/h</p>
        </div>
        <div class="battery-col">
          <p><b>ğŸ”‹ Battery:</b> <span id="batteryVal">--</span> V</p>
          <p><b>âš¡ Load:</b> <span id="loadVal">--</span> mA</p>
          <p><b>â˜€ï¸ Solar Panel:</b> <span id="solarPanelVal">--</span> V <span id="solarPanelEmoji"></span></p>
          <p><b>ğŸ”Œ Charge:</b> <span id="chargeVal">--</span> mA</p>
        </div>
      </div>

      <!-- Additional Data Section -->
      <div class="data-section">
         <p><b>ğŸŒ¿ Vector Wind Speed:</b> <span id="vectorWindSpeedVal">--</span> km/h</p>
         <p><b>ğŸ§­ Vector Wind Direction:</b> <span id="vectorWindDirDegVal">--</span>Â° (<span id="vectorWindDirTextVal">--</span>)</p>
      </div>

      <!-- Soil Moisture Section -->
      <div class="data-section two-col-container soil-moisture">
        <div class="soiltemp-col">
          <p><b>ğŸŒ¡ï¸ S. Temp 10cm:</b> <span id="soilTemp10Val">--</span>Â°C</p>
          <p><b>ğŸŒ¡ï¸ S. Temp 20cm:</b> <span id="soilTemp20Val">--</span>Â°C</p>
          <p><b>ğŸŒ¡ï¸ S. Temp 30cm:</b> <span id="soilTemp30Val">--</span>Â°C</p>
          <p><b>ğŸŒ¡ï¸ S. Temp 40cm:</b> <span id="soilTemp40Val">--</span>Â°C</p>
        </div>
        <div class="moisture-col">
          <p><b>ğŸ’§ Moist. 10cm:</b> <span id="moisture10Val">--</span>%</p>
          <p><b>ğŸ’§ Moist. 20cm:</b> <span id="moisture20Val">--</span>%</p>
          <p><b>ğŸ’§ Moist. 30cm:</b> <span id="moisture30Val">--</span>%</p>
          <p><b>ğŸ’§ Moist. 40cm:</b> <span id="moisture40Val">--</span>%</p>
        </div>
      </div>

    </div> <!-- End #weatherData Card -->

    <!-- Spinner -->
    <div id="spinnerContainer" class="spinner-container">
      <div class="spinner"></div>
    </div>

  </div> <!-- End .main-container -->

  <script>
    // ========================================================
    // == FULL JAVASCRIPT - VERIFIED FROM WORKING VERSION ===
    // ========================================================

    /********************
    * HELPER FUNCTIONS *
    ********************/
    function getWindDirection(degrees) {
        const directions = ["N", "NNE", "NE", "ENE", "E", "ESE", "SE", "SSE",
                            "S", "SSW", "SW", "WSW", "W", "WNW", "NW", "NNW"];
        const numericDegrees = parseFloat(degrees);
        if (isNaN(numericDegrees)) { return "--"; }
        const normalizedDegrees = (numericDegrees % 360 + 360) % 360;
        return directions[Math.round(normalizedDegrees / 22.5) % 16];
    }

    function formatDateString(dateStr) {
        if (!dateStr || typeof dateStr !== 'string') return "-- / -- / ---- (---)";
        const parts = dateStr.split("/");
        if (parts.length === 3) {
            const [year, month, day] = parts;
            if (!/^\d+$/.test(year) || !/^\d+$/.test(month) || !/^\d+$/.test(day)) { return `${dateStr} (Invalid)`; }
            const formattedDate = `${day.padStart(2, '0')}/${month.padStart(2, '0')}/${year}`;
            const yearNum = parseInt(year);
            const fullYear = yearNum < 100 ? (yearNum >= 70 ? 1900 + yearNum : 2000 + yearNum) : yearNum;
            const dateObj = new Date(fullYear, parseInt(month) - 1, parseInt(day));
            const dayNames = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
            if (!isNaN(dateObj.getTime()) && dateObj.getDate() == parseInt(day) && (dateObj.getMonth() + 1) == parseInt(month)) {
                return `${formattedDate} (${dayNames[dateObj.getDay()]})`;
            } else { return `${formattedDate} (Invalid Date)`; }
        }
        return `${dateStr} (Unknown Format)`;
    }

    function setStatusBadge(statusText, statusClass) {
        const badge = document.getElementById("statusBadge");
        if (badge) {
            let displayStatus = statusText;
            if (statusClass === 'fetching') { displayStatus = statusText.startsWith('Retrying') ? 'Retrying...' : 'Fetching...'; }
            else if (statusClass === 'error') { displayStatus = 'Error'; }
            else if (statusClass === 'connected') { displayStatus = 'Connected'; }
            badge.textContent = displayStatus;
            badge.className = `button-style ${statusClass}`;
        } else { console.warn("statusBadge element not found"); }
    }

    // --- Dynamic Class Functions ---
    function getTemperatureInfo(temp) {
        let desc = ""; let className = ""; const tempNum = parseFloat(temp);
        if (isNaN(tempNum)) return { desc: "--", className: "" };
        if (tempNum < -10) { desc = "Severely cold"; className = "temp-very-cold"; }
        else if (tempNum < 0) { desc = "Extremely cold"; className = "temp-very-cold"; }
        else if (tempNum < 6) { desc = "Very cold"; className = "temp-cold"; }
        else if (tempNum < 11) { desc = "Cold"; className = "temp-cold"; }
        else if (tempNum < 16) { desc = "Cool"; className = "temp-cool"; }
        else if (tempNum < 21) { desc = "Mild"; className = "temp-mild"; }
        else if (tempNum < 28) { desc = "Warm"; className = "temp-warm"; }
        else if (tempNum < 32) { desc = "Warmer"; className = "temp-hot"; }
        else if (tempNum < 36) { desc = "Hot"; className = "temp-hot"; }
        else if (tempNum < 41) { desc = "Very hot"; className = "temp-very-hot"; }
        else if (tempNum <= 60) { desc = "Extremely hot"; className = "temp-very-hot"; }
        else { desc = ""; className = ""; }
        return { desc, className };
    }
    function getBigTempBoxAirClass(temp) {
        const tempNum = parseFloat(temp); if (isNaN(tempNum)) return '';
        if (tempNum < 6) return 'temp-cold'; if (tempNum < 11) return 'temp-cool';
        if (tempNum < 21) return 'temp-mild'; if (tempNum < 32) return 'temp-warm';
        return 'temp-hot';
    }
    function getRadiantDiffClass(diff) {
        const diffNum = parseFloat(diff); if (isNaN(diffNum)) return 'dew-neutral';
        return diffNum >= 0 ? 'diff-positive' : 'diff-negative';
    }
    function getDewDiffClass(diff) {
        const diffNum = parseFloat(diff); if (isNaN(diffNum)) return 'dew-neutral';
        if (diffNum < 1.5) return 'dew-humid'; return 'dew-neutral';
    }
    function getHumidityDesc(humidity) {
        const humNum = parseFloat(humidity); if (isNaN(humNum)) return "--";
        if (humNum <= 20) return "Very Dry"; else if (humNum <= 40) return "Dry";
        else if (humNum <= 60) return "Comfortable"; else if (humNum <= 80) return "Humid";
        else return "Very Humid";
    }
    function getMoistureClass(val) { const valNum = parseFloat(val); if (isNaN(valNum)) return ''; return (valNum < 20) ? "moisture-dry text-semibold" : ""; }
    function getSolarRadiationClass(solarRad) {
        const radNum = parseFloat(solarRad); if (isNaN(radNum)) return '';
        if (radNum <= 0) return 'solar-zero'; if (radNum <= 100) return 'solar-low';
        if (radNum <= 600) return 'solar-med'; if (radNum <= 1100) return 'solar-high';
        return 'solar-very-high';
    }
    function getPressureClass(pressure) { const presNum = parseFloat(pressure); if (isNaN(presNum)) return ''; return presNum >= 1020 ? 'pressure-high text-semibold' : ''; }
    function getBatteryClass(voltage) {
        const voltNum = parseFloat(voltage); if (isNaN(voltNum)) return '';
        if (voltNum < 12.5) return 'battery-low text-semibold'; if (voltNum >= 13.8) return 'battery-full text-semibold'; return 'battery-ok';
    }
    function getChargeClass(charge, load, voltage) {
        const chargeNum = parseFloat(charge); const loadNum = parseFloat(load); const voltNum = parseFloat(voltage);
        if (isNaN(chargeNum) || isNaN(loadNum) || isNaN(voltNum)) return '';
        if (voltNum < 13.80) { return chargeNum > loadNum ? 'charge-positive text-semibold' : 'charge-negative text-semibold'; } return '';
    }
    function getWindGustClass(gust) { const gustNum = parseFloat(gust); if (isNaN(gustNum)) return ''; if (gustNum > 25) return 'wind-gust-high text-semibold'; if (gustNum > 10) return 'wind-gust-med text-semibold'; return ''; }
    function getRainClass(rainAmount) { const rainNum = parseFloat(rainAmount); if (isNaN(rainNum)) return ''; return rainNum >= 0.2 ? 'rain-significant text-semibold' : ''; }

    /*****************************
    * GLOBAL STATE & RETRIES *
    *****************************/
    let initialLoadComplete = false;
    let refreshTimeout = null;
    let retryAttempts = 0;
    const MAX_RETRY_ATTEMPTS = 3;
    const WEATHER_ENDPOINT = "/weather";

    /*****************************
    * MAIN UPDATE FUNCTION *
    *****************************/
    function updateWeatherData(data) {
      // console.log("Attempting update...");
      if (typeof data !== 'string' || data.trim() === '') { console.error("Invalid data received"); setStatusBadge("Data Error", "error"); return; }
      const lines = data.replace(/r3\r?\n?/, "").trim().split(",").map(s => s.trim());
      if (lines.length < 31) { console.error(`Incomplete data: Got ${lines.length} fields`); setStatusBadge("Data Error", "error"); return; }

      try {
        const getNum = (index) => parseFloat(lines[index]);
        const dateStr = lines[0]; const timeStr = lines[1]; const windSpeed = getNum(2); const windDirDeg = getNum(3);
        const humidityRaw = getNum(4); const temperatureRaw = getNum(5); let rainInLastMinRaw = getNum(6); const solarRadRaw = getNum(7);
        const pressureRaw = getNum(8); const gardenBedTemp = getNum(9); const batteryVoltageVal = getNum(10); const loadCurrent = getNum(11);
        const rawSolarVoltage = getNum(12); const chargeCurrent = getNum(13); const peakWindGustVal = getNum(14); const vectorWindSpeedVal = getNum(15);
        const vectorWindDirVal = getNum(16); const rainSince9 = getNum(17); const evapRate = getNum(18); const dailyEvap = getNum(20);
        const dewPoint = getNum(21); const soilTemp10 = getNum(22); const soilTemp20 = getNum(23); const soilTemp30 = getNum(24);
        const soilTemp40 = getNum(25); const moisture10Val = getNum(26); const moisture20Val = getNum(27); const moisture30Val = getNum(28);
        const moisture40Val = getNum(29); const blackGlobeTemp = getNum(30);

        if (isNaN(windSpeed) || isNaN(windDirDeg) || isNaN(humidityRaw) || isNaN(temperatureRaw) || isNaN(pressureRaw) || isNaN(blackGlobeTemp)) {
           console.error("Invalid core numeric data (NaN found)."); setStatusBadge("Data Error", "error"); return;
        }

        function updateElement(id, value, baseClass = '', dynamicClass = '') {
          const element = document.getElementById(id);
          if (element) {
            let displayValue = value;
            if (typeof value === 'number' && isNaN(value)) { displayValue = "--"; }
            else if (value === null || typeof value === 'undefined') { displayValue = "--"; }
            element.textContent = displayValue;
            const classesToAdd = [];
            if (baseClass) classesToAdd.push(...baseClass.split(' ').filter(Boolean));
            if (dynamicClass) classesToAdd.push(...dynamicClass.split(' ').filter(Boolean));
            element.className = classesToAdd.join(' ');
          } // else { console.warn(`Element ${id} not found`); } // Reduce noise
        }
         function updateElementClass(id, baseClass = '', dynamicClass = '') {
             const element = document.getElementById(id);
             if (element) {
                const classesToAdd = [];
                if (baseClass) classesToAdd.push(...baseClass.split(' ').filter(Boolean));
                if (dynamicClass) classesToAdd.push(...dynamicClass.split(' ').filter(Boolean));
                element.className = classesToAdd.join(' ');
             } // else { console.warn(`Element ${id} not found for class update`); }
         }

        // Update calls...
        updateElement("dateVal", formatDateString(dateStr)); updateElement("timeVal", timeStr || "--:--:--");
        updateElement("windSpeedVal", windSpeed.toFixed(1)); updateElement("windDirDegVal", windDirDeg.toFixed(1)); updateElement("windDirTextVal", getWindDirection(windDirDeg));
        updateElement("humidityVal", humidityRaw.toFixed(1)); updateElement("humidityDescVal", getHumidityDesc(humidityRaw));
        const tempInfo = getTemperatureInfo(temperatureRaw); updateElement("tempVal", isNaN(temperatureRaw) ? '--Â°C' : temperatureRaw.toFixed(1) + "Â°C", 'temp-value', tempInfo.className); updateElement("tempDescVal", tempInfo.desc);
        const airTempBoxClass = getBigTempBoxAirClass(temperatureRaw); updateElement("bigTempVal", isNaN(temperatureRaw) ? '--Â°C' : temperatureRaw.toFixed(1) + "Â°C", 'value'); updateElementClass("airTempBox", 'big-temp-box updated', airTempBoxClass);
        const solarRad = Math.max(0, isNaN(solarRadRaw) ? 0 : solarRadRaw); updateElement("solarRadVal", solarRad.toFixed(1), '', getSolarRadiationClass(solarRad)); updateElement("solarEmoji", solarRad < 10 ? "ğŸŒ™" : "â˜€ï¸");
        const globeTempInfo = getTemperatureInfo(blackGlobeTemp); updateElement("blackGlobeTempVal", isNaN(blackGlobeTemp) ? '--' : blackGlobeTemp.toFixed(1), 'temp-value', globeTempInfo.className);
        const radiantDiff = blackGlobeTemp - temperatureRaw; const radiantDiffFormatted = isNaN(radiantDiff) ? '--Â°C' : (radiantDiff >= 0 ? "+" : "") + radiantDiff.toFixed(1) + "Â°C"; const radiantDiffClass = getRadiantDiffClass(radiantDiff); updateElement("radiantDiffVal", radiantDiffFormatted, 'value'); updateElementClass("radiantDiffBox", 'big-temp-box updated', radiantDiffClass);
        const dewDiff = temperatureRaw - dewPoint; const dewFormatted = isNaN(dewDiff) ? '--Â°C' : (dewDiff >= 0 ? "+" : "") + dewDiff.toFixed(1) + "Â°C"; const dewDiffClass = getDewDiffClass(dewDiff); updateElement("dewDiffVal", dewFormatted, 'value'); updateElementClass("dewDiffBox", 'big-temp-box updated', dewDiffClass);
        updateElement("gardenBedTempVal", isNaN(gardenBedTemp) ? '--' : gardenBedTemp.toFixed(1));
        let adjustedPressure = pressureRaw - 1.9; updateElement("pressureVal", isNaN(adjustedPressure) ? '--' : adjustedPressure.toFixed(1), '', getPressureClass(adjustedPressure)); updateElement("pressureEmoji", isNaN(adjustedPressure) ? '' : (adjustedPressure >= 1020 ? "ğŸŸ" : ""));
        rainInLastMinRaw = isNaN(rainInLastMinRaw) ? 0.0 : rainInLastMinRaw; updateElement("rainSince9Val", isNaN(rainSince9) ? '--' : rainSince9.toFixed(1), '', getRainClass(rainSince9)); updateElement("rainInLastMinVal", rainInLastMinRaw.toFixed(1), '', getRainClass(rainInLastMinRaw));
        updateElement("batteryVal", isNaN(batteryVoltageVal) ? '--' : batteryVoltageVal.toFixed(1), '', getBatteryClass(batteryVoltageVal)); updateElement("loadVal", isNaN(loadCurrent) ? '--' : loadCurrent.toFixed(1));
        updateElement("solarPanelVal", isNaN(rawSolarVoltage) ? '--' : rawSolarVoltage.toFixed(1)); updateElement("solarPanelEmoji", isNaN(rawSolarVoltage) || isNaN(batteryVoltageVal) ? '' : (rawSolarVoltage < batteryVoltageVal ? "ğŸŒ™" : "â˜€ï¸"));
        updateElement("chargeVal", isNaN(chargeCurrent) ? '--' : chargeCurrent.toFixed(1), '', getChargeClass(chargeCurrent, loadCurrent, batteryVoltageVal));
        updateElement("peakWindGustVal", isNaN(peakWindGustVal) ? '--' : peakWindGustVal.toFixed(1), '', getWindGustClass(peakWindGustVal));
        updateElement("vectorWindSpeedVal", isNaN(vectorWindSpeedVal) ? '--' : vectorWindSpeedVal.toFixed(1)); updateElement("vectorWindDirDegVal", isNaN(vectorWindDirVal) ? '--' : vectorWindDirVal.toFixed(1)); updateElement("vectorWindDirTextVal", getWindDirection(vectorWindDirVal));
        updateElement("evapRateVal", isNaN(evapRate) ? '--' : evapRate.toFixed(3)); updateElement("dailyEvapVal", isNaN(dailyEvap) ? '--' : dailyEvap.toFixed(3)); updateElement("dewPointVal", isNaN(dewPoint) ? '--' : dewPoint.toFixed(1));
        updateElement("soilTemp10Val", isNaN(soilTemp10) ? '--' : soilTemp10.toFixed(1)); updateElement("soilTemp20Val", isNaN(soilTemp20) ? '--' : soilTemp20.toFixed(1)); updateElement("soilTemp30Val", isNaN(soilTemp30) ? '--' : soilTemp30.toFixed(1)); updateElement("soilTemp40Val", isNaN(soilTemp40) ? '--' : soilTemp40.toFixed(1));
        updateElement("moisture10Val", isNaN(moisture10Val) ? '--' : moisture10Val.toFixed(1), '', getMoistureClass(moisture10Val)); updateElement("moisture20Val", isNaN(moisture20Val) ? '--' : moisture20Val.toFixed(1), '', getMoistureClass(moisture20Val)); updateElement("moisture30Val", isNaN(moisture30Val) ? '--' : moisture30Val.toFixed(1), '', getMoistureClass(moisture30Val)); updateElement("moisture40Val", isNaN(moisture40Val) ? '--' : moisture40Val.toFixed(1), '', getMoistureClass(moisture40Val));

        setTimeout(() => { document.querySelectorAll('.big-temp-box.updated').forEach(el => el.classList.remove('updated')); }, 400);
        // console.log("DOM update success.");

      } catch (error) { console.error("Error in updateWeatherData:", error); setStatusBadge("Processing Error", "error"); }
    }


    /*****************************
    * FETCH & AUTO-REFRESH LOGIC *
    *****************************/
    function fetchWeather() {
        const spinnerContainer = document.getElementById("spinnerContainer");
        const fetchBtn = document.getElementById("fetchBtn");
        setStatusBadge(retryAttempts > 0 ? `Retrying...` : "Fetching...", "fetching");
        if(spinnerContainer) spinnerContainer.style.display = "block";
        if(fetchBtn) fetchBtn.disabled = true;
        if (refreshTimeout) { clearTimeout(refreshTimeout); refreshTimeout = null; }

        fetch(WEATHER_ENDPOINT)
            .then(response => {
                if (!response.ok) { throw new Error(`Server error: ${response.status} ${response.statusText || 'Unknown'}`); }
                return response.text();
            })
            .then(data => {
                updateWeatherData(data);
                setStatusBadge("Connected", "connected");
                retryAttempts = 0;
                if (!initialLoadComplete) { initialLoadComplete = true; }
                scheduleNextFetch();
            })
            .catch(error => {
                console.error("Fetch error:", error.message);
                retryAttempts++;
                if (retryAttempts >= MAX_RETRY_ATTEMPTS) {
                    setStatusBadge(`Error`, "error"); // Simplified
                    const retryDelay = 30000; // Longer delay
                    refreshTimeout = setTimeout(fetchWeather, retryDelay);
                } else {
                    setStatusBadge(`Retrying...`, "fetching"); // Simplified
                    const retryDelay = retryAttempts === 1 ? 1500 : 3000;
                    refreshTimeout = setTimeout(fetchWeather, retryDelay);
                }
            })
            .finally(() => {
                 if (retryAttempts === 0 || retryAttempts >= MAX_RETRY_ATTEMPTS) {
                      if(spinnerContainer) spinnerContainer.style.display = "none";
                      if(fetchBtn) fetchBtn.disabled = false;
                 }
            });
    }

    function scheduleNextFetch() {
        if (refreshTimeout) { clearTimeout(refreshTimeout); }
        const now = new Date(); const seconds = now.getSeconds(); const millis = now.getMilliseconds();
        const targetSecond = 20;
        let delay = (seconds < targetSecond) ? (targetSecond - seconds) * 1000 - millis : (60 - seconds + targetSecond) * 1000 - millis;
        delay = Math.max(1000, delay); // Min 1 sec delay
        // console.log(`Scheduling next fetch in ${Math.round(delay/1000)}s`);
        refreshTimeout = setTimeout(fetchWeather, delay);
    }

    function manualFetch() {
        console.log("Manual fetch triggered.");
        if (refreshTimeout) { clearTimeout(refreshTimeout); refreshTimeout = null; }
        retryAttempts = 0;
        fetchWeather();
    }

    window.addEventListener("load", () => {
        console.log("Window loaded, initiating first fetch.");
        setStatusBadge("Waiting...", ""); // Initial state
        fetchWeather();
    });

  </script>
</body>
</html>