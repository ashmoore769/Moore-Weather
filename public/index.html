<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Link the apple-touch-icon relative to the root if served statically -->
  <link rel="apple-touch-icon" href="/Weather_Station_App.png">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Rubik:wght@600&display=swap" rel="stylesheet">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"> <!-- Added user-scalable=no -->
  <title>Moore's LIVE Weather Data</title>
  <style>
    /* Base Styles */
    :root {
        --bg-color: #f4f4f4;
        --card-bg: #ffffff;
        --primary-text: #222;
        --header-bg: #00008B;
        --header-text: white;
        --button-bg: #FFA500;
        --button-text: black;
        --button-hover-bg: #e59400;
        --status-connected-bg: #006400;
        --status-connected-text: white;
        --status-connected-border: #006400;
        --status-fetching-text: #DAA520;
        --status-fetching-border: #DAA520;
        --status-error-text: #B22222;
        --status-error-border: #B22222;
        --border-color: #ccc;
        --shadow-color: rgba(0, 0, 0, 0.08);
        --inset-shadow-color: rgba(0, 0, 0, 0.25);
        --outer-shadow-color: rgba(0, 0, 0, 0.2);
        --label-text: #555; /* Softer label color */
    }

    body {
      margin: 0;
      background-color: var(--bg-color);
      font-family: "Inter", "system-ui", "Segoe UI", "Helvetica Neue", Arial, sans-serif;
      font-size: 13.5px;
      font-weight: 400;
      line-height: 1.35;
      letter-spacing: 0.15px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
      padding-top: env(safe-area-inset-top, 0);
      color: var(--primary-text);
    }

    .main-container {
      max-width: 400px;
      margin: 10px auto;
      padding: 0 5px;
    }

    /* --- Animations --- */
    @keyframes pulse {
      0% { transform: scale(1); box-shadow: inset 0 0 4px var(--inset-shadow-color), 0 2px 6px var(--outer-shadow-color); }
      50% { transform: scale(1.03); box-shadow: inset 0 0 6px var(--inset-shadow-color), 0 4px 8px var(--outer-shadow-color); }
      100% { transform: scale(1); box-shadow: inset 0 0 4px var(--inset-shadow-color), 0 2px 6px var(--outer-shadow-color); }
    }

    .big-temp-box.updated {
      animation: pulse 0.3s ease-in-out;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* --- Sticky Header & Controls --- */
    .freeze-pane {
      position: sticky;
      top: env(safe-area-inset-top, 0);
      z-index: 100;
      background: var(--bg-color);
      padding: 0; /* reduce from 5px 0 to 0 */
    }

    .header-box {
      background-color: var(--header-bg);
      border-radius: 10px;
      padding: 5px;         /* was 5px */
      text-align: center;
    }

    .header-box h2 {
      margin: 0;
      font-size: 18px;
      font-weight: bold;
      color: var(--header-text);
      padding: 4px 0;       /* was 6px 0 */
      white-space: nowrap;
    }

    .control-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 2px;        /* reduce horizontal padding */
      margin-bottom: 0;      /* remove bottom margin */
      margin-top: 2px;       /* optional: add a little space if needed */
    }

    .control-half {
      width: 50%;
      text-align: center;
      white-space: nowrap;
    }

    button {
      padding: 6px 12px;
      font-size: 14px;
      font-weight: 600;
      font-family: "Inter", "system-ui", "Segoe UI", "Helvetica Neue", Arial, sans-serif;
      background-color: var(--button-bg);
      color: var(--button-text);
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.1s ease, box-shadow 0.3s ease;
      display: inline-block;
      margin: 2px 0;
      white-space: nowrap;
      line-height: 1.2;
      letter-spacing: 0.3px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.15);
    }

    button:hover:not(:disabled) {
      background-color: var(--button-hover-bg);
      transform: scale(1.02);
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    button:disabled {
      background-color: gray;
      cursor: not-allowed;
      opacity: 0.7;
      box-shadow: none;
      transform: none;
    }

    #status {
      /* Parent p tag styling minimal */
      padding: 0;
      margin: 0;
    }

    /* Default badge style for all statuses */
    .status-badge {
      display: inline-block;
      padding: 6px 12px;
      font-size: 14px;
      font-weight: bold;
      border-radius: 10px;
      background-color: var(--card-bg); /* Default light background */
      color: var(--label-text);        /* Default text color */
      border: 2px solid var(--label-text); /* Default border */
      line-height: 1;
      transition: all 0.3s ease;
      white-space: nowrap;
    }

    .status-badge.connected {
      background-color: var(--status-connected-bg);
      color: var(--status-connected-text);
      border-color: var(--status-connected-border);
    }

    .status-badge.fetching {
      color: var(--status-fetching-text);
      border-color: var(--status-fetching-border);
      background-color: var(--card-bg);
    }

    .status-badge.error {
      color: var(--status-error-text);
      border-color: var(--status-error-border);
      background-color: var(--card-bg);
    }


    /* --- Spinner --- */
    .spinner-container {
      display: none;
      margin: 20px auto;
      width: 40px;
      height: 40px;
    }

    .spinner {
      width: 100%;
      height: 100%;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #007bff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    /* --- Weather Data Container & Content --- */
    #weatherData {
      background: var(--card-bg);
      padding: 8px 10px 12px 10px;
      border-radius: 12px;
      box-shadow: 0 2px 4px var(--shadow-color);
      font-size: 13.5px;
      color: var(--primary-text);
      text-align: left;
      margin-top: 5px; /* Space below controls */
      margin-bottom: 15px;
    }

    #weatherData p {
      margin: 2px 0;
      line-height: 1.3;
      white-space: nowrap;
    }
    /* Add styling for bold labels within <p> */
    #weatherData p b {
        color: var(--label-text); /* Use the softer label color */
        font-weight: 600;         /* Keep it slightly bolder than normal text */
        display: inline-block;    /* Ensures consistent spacing */
        min-width: 120px;        /* Align values somewhat (adjust as needed) */
    }
    #weatherData p b::after {
        content: ": ";           /* Add colon separator */
    }

     /* Adjust specific labels if needed */
    #weatherData .soil-moisture p b,
    #weatherData .evap-battery p b {
        min-width: 95px;
    }
    #weatherData .rain-container p b {
        min-width: 100px;
    }
    /* Remove min-width for multi-line items if they exist or adjust */
    #weatherData .address-title b, /* Example if address was bolded */
    #weatherData .date-time p b {
      min-width: auto;
      /* display: inline; Optional: If min-width is not desired */
    }


    hr {
      border: none;
      border-top: 1px solid var(--border-color);
      margin: 5px 0;
      clear: both;
      width: 100%;
    }

    /* --- Header Layout within Weather Data --- */
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 5px 0;
      white-space: nowrap;
    }

    .title-date-container {
      display: flex;
      flex-direction: column;
      white-space: nowrap;
    }

    .address-title {
      font-size: 18px;
      font-weight: bold;
      margin: 0 0 2px 0;
      color: var(--header-bg); /* Use header color for title */
      white-space: nowrap;
    }

    .date-time { margin: 0; }
    .date-time p { margin: 0; line-height: 1.3; }
     /* Override bold label style for date/time */
    .date-time p b { color: var(--label-text); font-weight: 600; min-width: 45px;} /* Ensure date/time labels align */
    .date-time p b::after { content: ": "; }


    .logo-container {
      display: flex;
      gap: 5px;
      margin: 0;
      padding: 0;
    }

    .logo-container img {
      height: 60px;
      width: auto;
      margin: 0;
      display: block;
      border-radius: 8px;
    }
    .logo-container img:last-child {
        padding-right: 4px; /* Prevent touching edge */
    }

    /* --- Main Data Layout --- */
    .wind-logger-container {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      margin: 5px 0;
      white-space: nowrap;
    }

    .wind-column { width: 60%; }
    .logger-column {
      width: 40%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .big-temp-box {
        width: 98px;
        height: 38px; /* Reduced height */
        padding: 4px 6px; /* Adjusted padding */
        border-radius: 10px;
        background: linear-gradient(to bottom, rgba(255,255,255,0.1), rgba(0,0,0,0.15)); /* Base gradient */
        box-shadow:
            inset 0 0 4px var(--inset-shadow-color),
            0 2px 6px var(--outer-shadow-color);
        font-size: 16px; /* Slightly smaller main temp */
        font-family: 'Rubik', sans-serif; /* Use Rubik */
        font-weight: 600; /* Bold */
        text-align: center;
        color: var(--header-text); /* White text */
        text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        display: flex;
        flex-direction: column;
        justify-content: center; /* Center content vertically */
        align-items: center;
        word-wrap: break-word;
        line-height: 1;
        letter-spacing: 0.2px;
        border: 1px solid rgba(255,255,255,0.4); /* Subtle border */
        transition: background-color 0.3s ease, box-shadow 0.3s ease, transform 0.1s ease;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }

    .big-temp-box span.label {
      font-size: 11px; /* Slightly smaller label */
      font-weight: 600;
      color: white; /* Keep label white */
      margin-top: 2px; /* Small gap */
      line-height: 1.1;
      letter-spacing: 0.2px;
    }

    /* Spacing between the two temp boxes */
    .big-temp-box + .big-temp-box {
      margin-top: 8px;
    }

    /* --- Other Data Sections --- */
    .rain-container {
      margin-top: 7px;
      margin-bottom: 3px;
      padding: 1px 8px; /* Add horizontal padding */
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background: #f9f9f9; /* Slightly off-white */
    }

    .evap-battery, .soil-moisture {
      display: flex;
      justify-content: space-between;
      margin: 5px 0;
    }

    .evap-col { width: 52%; }
    .battery-col { width: 48%; }
    .soiltemp-col, .moisture-col { width: 48%; }

    /* --- Media Queries --- */
    @media only screen and (max-width: 600px) {
      .main-container {
        max-width: 100%; /* Use full width */
        margin: 5px auto;
        padding: 0 5px;
      }
      .header-box { padding: 0; } /* Remove padding on small screens */
       #weatherData p b { min-width: 110px; } /* Adjust label width for mobile */
       #weatherData .soil-moisture p b,
       #weatherData .evap-battery p b { min-width: 85px; }
       #weatherData .rain-container p b { min-width: 90px; }
       .date-time p b { min-width: 40px;} /* Adjust date/time label */

    }
     @media only screen and (max-width: 360px) {
         #weatherData p b { min-width: 100px; } /* Further adjust for very small screens */
         #weatherData .soil-moisture p b,
         #weatherData .evap-battery p b { min-width: 75px; }
         #weatherData .rain-container p b { min-width: 80px; }
         .date-time p b { min-width: 35px;}
         .logo-container img { height: 50px; } /* Shrink logos slightly */
         .address-title { font-size: 16px; }
         .header-box h2 { font-size: 16px; }
     }
  </style>
</head>
<body>
  <div class="main-container">
    <!-- Sticky Header -->
    <div class="freeze-pane">
      <div class="header-box">
        <h2>Moore's LIVE Weather Data</h2>
      </div>
      <div class="control-container">
        <div class="control-half">
          <button id="fetchBtn" onclick="manualFetch()">CURRENT READINGS</button>
        </div>
        <div class="control-half">
           <!-- Status container -->
          <p id="status" aria-live="polite">
            <span id="statusBadge" class="status-badge">Status: Waiting...</span>
          </p>
        </div>
      </div>
    </div>

    <!-- Weather Data Section -->
    <div id="weatherData">
      <!-- Header Section -->
      <div class="header-content">
        <div class="title-date-container">
          <div class="address-title">WEST WARWICK, QLD</div>
          <div class="date-time">
            <p><b>Date</b><span id="dateVal">--</span></p>
            <p><b>Time</b><span id="timeVal">--</span></p>
          </div>
        </div>
        <div class="logo-container">
           <!-- Ensure paths are relative to the 'public' dir root -->
          <img src="/Weather_Station_App.png" alt="Weather Station Icon">
          <img src="/Station_Label.png" alt="Environdata Weather Maestro">
        </div>
      </div>
      <hr>

      <!-- Main Data Columns -->
      <div class="wind-logger-container">
        <div class="wind-column">
          <p><b>Wind Speed</b><span id="windSpeedVal">--</span> km/h</p>
          <p><b>Wind Dir.</b><span id="windDirDegVal">--</span>¬∞ (<span id="windDirTextVal">--</span>)</p>
          <p><b>Humidity</b><span id="humidityVal">--</span>% (<span id="humidityDescVal">--</span>)</p>
          <p><b>Temperature</b>
            <span id="tempVal" style="font-weight:bold;">--</span>
            (<span id="tempDescVal">--</span>)
          </p>
          <p><b>Solar Rad.</b><span id="solarRadVal">--</span></p>
          <p><b>Black Globe</b><span id="blackGlobeTempVal">--</span>¬∞C</p>
          <p><b>Garden Bed</b><span id="gardenBedTempVal">--</span>¬∞C</p>
          <p><b>Pressure</b><span id="pressureVal">--</span></p>
          <div class="rain-container">
            <p><b>Rain Since 9AM</b><span id="rainSince9Val">--</span></p>
            <p><b>Rain / Last Min</b><span id="rainInLastMinVal">--</span></p>
          </div>
        </div>
        <div class="logger-column">
          <div class="big-temp-box" id="airTempBox">
            <span id="bigTempVal">--¬∞C</span>
            <span class="label">Air Temp</span>
          </div>
          <div class="big-temp-box" id="radiantDiffBox">
            <span id="radiantDiffVal">--</span>
            <span class="label" aria-label="Difference between black globe and air temperature">Rad. Heat Diff</span>
          </div>
        </div>
      </div>
      <hr>
      <!-- Evaporation and Battery Section -->
      <div class="evap-battery">
        <div class="evap-col">
          <p><b>Evap/Hr</b><span id="evapRateVal">--</span> mm/h</p>
          <p><b>Daily Evap</b><span id="dailyEvapVal">--</span> mm</p>
          <p><b>Dew Point</b><span id="dewPointVal">--</span>¬∞C</p>
          <p><b>Max WS Gust</b><span id="peakWindGustVal">--</span></p>
        </div>
        <div class="battery-col">
          <p><b>Battery</b><span id="batteryVal">--</span></p>
          <p><b>Load</b><span id="loadVal">--</span> mA</p>
          <p><b>Solar Panel</b><span id="solarPanelVal">--</span></p>
          <p><b>Charge</b><span id="chargeVal">--</span></p>
        </div>
      </div>
      <hr>
      <!-- Additional Data -->
      <p><b>Vector Wind Spd</b><span id="vectorWindSpeedVal">--</span> km/h</p>
      <p><b>Vector Wind Dir</b>
        <span id="vectorWindDirDegVal">--</span>¬∞ (<span id="vectorWindDirTextVal">--</span>)
      </p>
      <hr>
      <div class="soil-moisture">
        <div class="soiltemp-col">
          <p><b>S.Temp 10cm</b><span id="soilTemp10Val">--</span>¬∞C</p>
          <p><b>S.Temp 20cm</b><span id="soilTemp20Val">--</span>¬∞C</p>
          <p><b>S.Temp 30cm</b><span id="soilTemp30Val">--</span>¬∞C</p>
          <p><b>S.Temp 40cm</b><span id="soilTemp40Val">--</span>¬∞C</p>
        </div>
        <div class="moisture-col">
          <p><b>Moist. 10cm</b><span id="moisture10Val">--</span>%</p>
          <p><b>Moist. 20cm</b><span id="moisture20Val">--</span>%</p>
          <p><b>Moist. 30cm</b><span id="moisture30Val">--</span>%</p>
          <p><b>Moist. 40cm</b><span id="moisture40Val">--</span>%</p>
        </div>
      </div>
      <hr>
    </div>

    <!-- Spinner -->
    <div id="spinnerContainer" class="spinner-container">
      <div class="spinner"></div>
    </div>
  </div>

  <script>
    /********************
    * HELPER FUNCTIONS *
    ********************/
    function getWindDirection(degrees) {
      const directions = ["N", "NNE", "NE", "ENE", "E", "ESE", "SE", "SSE",
        "S", "SSW", "SW", "WSW", "W", "WNW", "NW", "NNW"];
      return directions[Math.round(degrees / 22.5) % 16];
    }

    function setStatusBadge(statusText, statusClass) {
      const icons = {
        connected: "‚úÖ",
        fetching: "üîÑ",
        error: "‚ö†Ô∏è",
        waiting: "‚è≥" // Added waiting state
      };
      const icon = icons[statusClass] || "";
      const badge = document.getElementById("statusBadge");
      badge.textContent = `${icon} Status: ${statusText}`;
      // Ensure class list manipulation is robust
      badge.classList.remove('connected', 'fetching', 'error', 'waiting'); // Remove all possible classes
      badge.classList.add(statusClass); // Add the current class
    }

    function formatDateString(dateStr) {
      // Input format expected: YYYY/MM/DD
      const parts = dateStr.split("/");
      if (parts.length === 3) {
        const [year, month, day] = parts;
        // Check if parts are valid numbers for a date
        if (!isNaN(year) && !isNaN(month) && !isNaN(day)) {
            const dateObj = new Date(Number(year), Number(month) - 1, Number(day));
             // Check if the created date is valid (e.g., not Feb 30)
            if (dateObj && dateObj.getFullYear() == year && dateObj.getMonth() == month - 1 && dateObj.getDate() == day) {
                const formattedDate = `${day}/${month}/${year}`;
                const dayNames = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
                return `${formattedDate} (${dayNames[dateObj.getDay()]})`;
            }
        }
      }
      console.warn("Could not parse date string:", dateStr);
      return dateStr; // Return original if parsing fails
    }

    function getTemperatureColorAndDesc(temp) {
      let color, desc;
      if (temp < -20) { color = "#000000"; desc = ""; }
      else if (temp < -10) { color = "#191970"; desc = "Severely cold"; }
      else if (temp < 0) { color = "#00008B"; desc = "Extremely cold"; }
      else if (temp < 6) { color = "#104E8B"; desc = "Very cold"; }
      else if (temp < 11) { color = "#4682B4"; desc = "Cold"; }
      else if (temp < 16) { color = "#32CD32"; desc = "Cool"; }
      else if (temp < 21) { color = "#228B22"; desc = "Mild"; }
      else if (temp < 28) { color = "#D4A017"; desc = "Warm"; }
      else if (temp < 32) { color = "#FF8C00"; desc = "Warmer"; }
      else if (temp < 36) { color = "#FF4500"; desc = "Hot"; }
      else if (temp < 41) { color = "#B22222"; desc = "Very hot"; }
      else if (temp <= 60) { color = "#8B0000"; desc = "Extremely hot"; }
      else { color = "#000000"; desc = ""; }
      return { color, desc };
    }

    function getHumidityDesc(humidity) {
      if (humidity <= 20) { return "Very Dry"; }
      else if (humidity <= 40) { return "Dry"; }
      else if (humidity <= 60) { return "Comfortable"; }
      else if (humidity <= 80) { return "Humid"; }
      else { return "Very Humid"; }
    }

    function colorMoisture(val) {
        if (isNaN(val)) return '--'; // Handle NaN input gracefully
        let display = val.toFixed(1);
        if (val < 20) { display = `<span style="color:#FF8C00; font-weight:bold;">${display}</span>`; }
        return display;
    }

    // Helper to safely get value from lines array
    function safeGetLineValue(lines, index, defaultValue = NaN) {
        const val = parseFloat(lines[index]);
        return isNaN(val) ? defaultValue : val;
    }

    /*****************************
    * GLOBAL STATE & RETRIES *
    *****************************/
    let initialLoadComplete = false;
    let refreshTimeout;
    let retryAttempts = 0;
    const MAX_RETRY_ATTEMPTS = 3; // Short-term retries
    const LONG_RETRY_DELAY = 30000; // 30 seconds for longer backoff
    const WEATHER_ENDPOINT = "/weather"; // Relative path for server endpoint

    /*****************************
    * MAIN UPDATE FUNCTION *
    *****************************/
    function updateWeatherData(data) {
      console.log("Raw CSV data received length:", data.length);
      const lines = data.replace(/r3\r?\n?/, "").trim().split(",");
      console.log("Parsed lines array count:", lines.length);

      // More robust check for expected data length
      if (lines.length < 31) { // Expecting 31 fields (index 0 to 30) based on usage
        console.error("Incomplete data received. Expected >= 31 fields, got:", lines.length, lines);
        setStatusBadge("Data Error", "error");
        // Optional: Show partial data if desired, or clear the display
        // document.getElementById("weatherData").innerHTML = "<b>Error:</b> Incomplete or malformed data.";
        return; // Stop processing if data structure is wrong
      }

      try {
        // Extract data using safe helper
        const dateStr = lines[0] || '--';
        const timeStr = lines[1] || '--';
        const windSpeed = safeGetLineValue(lines, 2);
        const windDirDeg = safeGetLineValue(lines, 3);
        const humidityRaw = safeGetLineValue(lines, 4);
        const temperatureRaw = safeGetLineValue(lines, 5);
        let rainInLastMinRaw = safeGetLineValue(lines, 6, 0.0); // Default to 0 if NaN
        const solarRadRaw = safeGetLineValue(lines, 7);
        const pressureRaw = safeGetLineValue(lines, 8);
        const gardenBedTemp = safeGetLineValue(lines, 9);
        const batteryVoltageVal = safeGetLineValue(lines, 10);
        const loadCurrent = safeGetLineValue(lines, 11);
        const rawSolarVoltage = safeGetLineValue(lines, 12);
        const chargeCurrent = safeGetLineValue(lines, 13);
        const peakWindGustVal = safeGetLineValue(lines, 14);
        const vectorWindSpeedVal = safeGetLineValue(lines, 15);
        const vectorWindDirVal = safeGetLineValue(lines, 16);
        const rainSince9 = safeGetLineValue(lines, 17);
        const evapRate = safeGetLineValue(lines, 18);
        // Index 19 seems unused based on original code, skipping
        const dailyEvap = safeGetLineValue(lines, 20);
        const dewPoint = safeGetLineValue(lines, 21);
        const soilTemp10 = safeGetLineValue(lines, 22);
        const soilTemp20 = safeGetLineValue(lines, 23);
        const soilTemp30 = safeGetLineValue(lines, 24);
        const soilTemp40 = safeGetLineValue(lines, 25);
        const moisture10Val = safeGetLineValue(lines, 26);
        const moisture20Val = safeGetLineValue(lines, 27);
        const moisture30Val = safeGetLineValue(lines, 28);
        const moisture40Val = safeGetLineValue(lines, 29);
        const blackGlobeTemp = safeGetLineValue(lines, 30);

        // *** UPDATE DOM ELEMENTS ***

        // DATE & TIME
        document.getElementById("dateVal").textContent = formatDateString(dateStr);
        document.getElementById("timeVal").textContent = timeStr ? timeStr + " AEST" : '--';

        // WIND
        document.getElementById("windSpeedVal").textContent = !isNaN(windSpeed) ? windSpeed.toFixed(1) : '--';
        document.getElementById("windDirDegVal").textContent = !isNaN(windDirDeg) ? windDirDeg.toFixed(1) : '--';
        document.getElementById("windDirTextVal").textContent = !isNaN(windDirDeg) ? getWindDirection(windDirDeg) : '--';

        // HUMIDITY
        document.getElementById("humidityVal").textContent = !isNaN(humidityRaw) ? humidityRaw.toFixed(1) : '--';
        document.getElementById("humidityDescVal").textContent = !isNaN(humidityRaw) ? getHumidityDesc(humidityRaw) : '--';

        // TEMPERATURE
        const tempSpan = document.getElementById("tempVal");
        const bigTempElement = document.getElementById("bigTempVal");
        const bigTempContainer = document.getElementById("airTempBox");
        if (!isNaN(temperatureRaw)) {
            const tempData = getTemperatureColorAndDesc(temperatureRaw);
            tempSpan.textContent = temperatureRaw.toFixed(1) + "¬∞C";
            tempSpan.style.color = tempData.color;
            document.getElementById("tempDescVal").textContent = tempData.desc;

            bigTempElement.textContent = temperatureRaw.toFixed(1) + "¬∞C";
            bigTempContainer.style.backgroundColor = tempData.color;
            bigTempElement.style.color = "#FFF"; // Ensure text remains white

            // Trigger pulse animation
            bigTempContainer.classList.add('updated');
            setTimeout(() => bigTempContainer.classList.remove('updated'), 300); // Match animation duration
        } else {
            tempSpan.textContent = '--¬∞C';
            tempSpan.style.color = 'inherit';
            document.getElementById("tempDescVal").textContent = '--';
            bigTempElement.textContent = '--¬∞C';
            bigTempContainer.style.backgroundColor = 'grey'; // Default color
        }

        // RAIN SINCE 9AM
        let rainSince9Display = !isNaN(rainSince9) ? rainSince9.toFixed(1) + " mm" : '-- mm';
        if (!isNaN(rainSince9) && rainSince9 >= 0.2) {
          rainSince9Display = `<span style="color:#1E90FF; font-weight:bold;">${rainSince9Display}</span>`;
        }
        document.getElementById("rainSince9Val").innerHTML = rainSince9Display;

        // RAIN IN LAST MINUTE (already defaulted to 0.0 if NaN)
        let rainInLastMinDisplay = rainInLastMinRaw.toFixed(1) + " mm";
        if (rainInLastMinRaw >= 0.2) {
          rainInLastMinDisplay = `<span style="color:#1E90FF; font-weight:bold;">${rainInLastMinDisplay}</span>`;
        }
        document.getElementById("rainInLastMinVal").innerHTML = rainInLastMinDisplay;

        // SOLAR RADIATION
        const solarRad = !isNaN(solarRadRaw) ? Math.max(0, solarRadRaw) : NaN;
        let solarRadDisplay = '-- W/m¬≤';
        if (!isNaN(solarRad)) {
            let solarRadColor = solarRad === 0 ? "#000033" :
                solarRad <= 100 ? "#000080" :
                solarRad <= 299 ? "#27408B" :
                solarRad <= 600 ? "#DAA520" :
                solarRad <= 800 ? "#FF9933" :
                solarRad <= 1100 ? "#BF360C" : "#B71C1C";
            solarRadDisplay = solarRad.toFixed(1) + " W/m¬≤";
            if (solarRad < 10) solarRadDisplay += " üåô";
            solarRadDisplay = `<span style="font-weight:${solarRad > 0 ? 'bold' : 'normal'}; color:${solarRadColor};">${solarRadDisplay}</span>`;
        }
        document.getElementById("solarRadVal").innerHTML = solarRadDisplay;

        // BLACK GLOBE & RADIANT HEAT DIFF
        const globeElem = document.getElementById("blackGlobeTempVal");
        const radiantDiffElem = document.getElementById("radiantDiffVal");
        const radiantDiffBox = document.getElementById("radiantDiffBox");
        if (!isNaN(blackGlobeTemp)) {
            const globeTempData = getTemperatureColorAndDesc(blackGlobeTemp);
            globeElem.textContent = blackGlobeTemp.toFixed(1);
            globeElem.style.color = globeTempData.color;

            if (!isNaN(temperatureRaw)) {
                const radiantDiff = blackGlobeTemp - temperatureRaw;
                const diffFormatted = (radiantDiff >= 0 ? "+" : "") + radiantDiff.toFixed(1) + "¬∞C";
                radiantDiffElem.textContent = diffFormatted;
                // Set color theme based on difference
                radiantDiffBox.style.backgroundColor = radiantDiff >= 0 ? "#d94a38" : "#4682B4"; // Warm red / Steel blue
                radiantDiffElem.style.color = "white";
            } else {
                 radiantDiffElem.textContent = '--¬∞C';
                 radiantDiffBox.style.backgroundColor = 'grey';
            }
        } else {
            globeElem.textContent = '--';
            globeElem.style.color = 'inherit';
            radiantDiffElem.textContent = '--¬∞C';
            radiantDiffBox.style.backgroundColor = 'grey';
        }


        // GARDEN BED TEMP
        document.getElementById("gardenBedTempVal").textContent = !isNaN(gardenBedTemp) ? gardenBedTemp.toFixed(1) : '--';

        // PRESSURE (with 1.9 hPa offset)
        let pressureDisplay = '-- hPa';
        if (!isNaN(pressureRaw)) {
            let adjustedPressure = pressureRaw - 1.9; // Apply offset
            pressureDisplay = adjustedPressure.toFixed(1) + " hPa";
            if (adjustedPressure >= 1020) {
                pressureDisplay = `<span style="color:green; font-weight:bold;">${pressureDisplay} üêü</span>`;
            }
        }
        document.getElementById("pressureVal").innerHTML = pressureDisplay;

        // BATTERY
        let batteryVoltageDisplay = '-- V';
        if (!isNaN(batteryVoltageVal)) {
            const batteryVoltage = batteryVoltageVal.toFixed(1);
            let batteryColor = batteryVoltageVal < 12.5 ? "red" : (batteryVoltageVal >= 13.8 ? "green; font-weight:bold;" : "green");
            batteryVoltageDisplay = `<span style="color:${batteryColor};">${batteryVoltage} V</span>`;
        }
        document.getElementById("batteryVal").innerHTML = batteryVoltageDisplay;

        // LOAD
        document.getElementById("loadVal").textContent = !isNaN(loadCurrent) ? loadCurrent.toFixed(1) : '--';

        // SOLAR PANEL
        let solarPanelDisplay = '-- V';
        if (!isNaN(rawSolarVoltage) && !isNaN(batteryVoltageVal)) {
            // Display 0.0V if solar voltage is lower than battery (indicates night/no charge)
            solarPanelDisplay = (rawSolarVoltage < batteryVoltageVal || rawSolarVoltage < 1.0 ) // Added threshold for low light
                              ? "0.0 V üåô"
                              : rawSolarVoltage.toFixed(1) + " V ‚òÄÔ∏è";
        }
        document.getElementById("solarPanelVal").textContent = solarPanelDisplay;

        // CHARGE
        let chargeDisplay = '-- mA';
         if (!isNaN(chargeCurrent) && !isNaN(loadCurrent) && !isNaN(batteryVoltageVal)) {
            chargeDisplay = chargeCurrent.toFixed(1) + " mA";
            // Color based on whether charge > load, only if battery isn't fully charged (e.g., < 13.8V)
             if (batteryVoltageVal < 13.80) {
                chargeDisplay = chargeCurrent > loadCurrent
                    ? `<span style="color:green;">${chargeDisplay}</span>`
                    : `<span style="color:red;">${chargeDisplay}</span>`;
             } else {
                 // If battery is full, just display the value (might still be charging slightly)
                 chargeDisplay = `<span style="color:green;">${chargeDisplay}</span>`; // Show as green if charging, even if full
             }
        }
        document.getElementById("chargeVal").innerHTML = chargeDisplay;


        // PEAK WIND GUST
        let peakWindGustDisplay = '-- km/h';
        if (!isNaN(peakWindGustVal)) {
            peakWindGustDisplay = peakWindGustVal.toFixed(1) + " km/h";
            if (peakWindGustVal > 25) {
                peakWindGustDisplay = `<span style="color:red; font-weight:bold;">${peakWindGustDisplay}</span>`;
            } else if (peakWindGustVal > 10) {
                peakWindGustDisplay = `<span style="color:#FF8C00; font-weight:bold;">${peakWindGustDisplay}</span>`;
            }
        }
        document.getElementById("peakWindGustVal").innerHTML = peakWindGustDisplay;

        // VECTOR WIND
        document.getElementById("vectorWindSpeedVal").textContent = !isNaN(vectorWindSpeedVal) ? vectorWindSpeedVal.toFixed(1) : '--';
        document.getElementById("vectorWindDirDegVal").textContent = !isNaN(vectorWindDirVal) ? vectorWindDirVal.toFixed(1) : '--';
        document.getElementById("vectorWindDirTextVal").textContent = !isNaN(vectorWindDirVal) ? getWindDirection(vectorWindDirVal) : '--';

        // EVAP & DEW POINT
        document.getElementById("evapRateVal").textContent = !isNaN(evapRate) ? evapRate.toFixed(3) : '--';
        document.getElementById("dailyEvapVal").textContent = !isNaN(dailyEvap) ? dailyEvap.toFixed(3) : '--';
        document.getElementById("dewPointVal").textContent = !isNaN(dewPoint) ? dewPoint.toFixed(1) : '--';

        // SOIL TEMPS & MOISTURE
        document.getElementById("soilTemp10Val").textContent = !isNaN(soilTemp10) ? soilTemp10.toFixed(1) : '--';
        document.getElementById("soilTemp20Val").textContent = !isNaN(soilTemp20) ? soilTemp20.toFixed(1) : '--';
        document.getElementById("soilTemp30Val").textContent = !isNaN(soilTemp30) ? soilTemp30.toFixed(1) : '--';
        document.getElementById("soilTemp40Val").textContent = !isNaN(soilTemp40) ? soilTemp40.toFixed(1) : '--';

        document.getElementById("moisture10Val").innerHTML = colorMoisture(moisture10Val);
        document.getElementById("moisture20Val").innerHTML = colorMoisture(moisture20Val);
        document.getElementById("moisture30Val").innerHTML = colorMoisture(moisture30Val);
        document.getElementById("moisture40Val").innerHTML = colorMoisture(moisture40Val);

      } catch (error) {
        console.error("Error parsing or updating data:", error);
        setStatusBadge("Processing Error", "error");
        // Consider leaving old data displayed or clearing fields
        // document.getElementById("weatherData").innerHTML = "<b>Error:</b> An error occurred while processing the data.";
      }
    }


    /*****************************
     * FETCH & AUTO-REFRESH LOGIC *
     *****************************/
    function fetchWeather() {
        const spinnerContainer = document.getElementById("spinnerContainer");
        const fetchBtn = document.getElementById("fetchBtn");

        setStatusBadge("Fetching", "fetching");
        spinnerContainer.style.display = "block";
        fetchBtn.disabled = true;

        fetch(WEATHER_ENDPOINT)
            .then(response => {
                if (!response.ok) {
                    // Server errors (like 503 if cache is empty) should trigger retries
                    throw new Error(`Server responded ${response.status} - ${response.statusText}`);
                }
                return response.text();
            })
            .then(data => {
                if (!data || data.trim() === "") {
                    throw new Error("Received empty data from server");
                }
                updateWeatherData(data);
                setStatusBadge("Connected", "connected");
                retryAttempts = 0; // Reset retries on success
                if (!initialLoadComplete) {
                    initialLoadComplete = true;
                }
                scheduleNextFetch(); // Schedule next fetch after successful update
            })
            .catch(error => {
                console.error("Fetch error:", error.message);
                retryAttempts++;

                if (retryAttempts <= MAX_RETRY_ATTEMPTS) {
                    // Retry quickly a few times
                    setStatusBadge(`Retrying (${retryAttempts}/${MAX_RETRY_ATTEMPTS})`, "fetching");
                    const retryDelay = retryAttempts === 1 ? 500 : 1000; // Short delays for initial retries
                    console.log(`Retrying fetch in ${retryDelay}ms...`);
                    refreshTimeout = setTimeout(fetchWeather, retryDelay);
                } else {
                    // After max retries, switch to longer retry intervals
                    setStatusBadge("Error", "error");
                    console.log(`Max retries reached. Retrying in ${LONG_RETRY_DELAY / 1000}s...`);
                    refreshTimeout = setTimeout(fetchWeather, LONG_RETRY_DELAY); // Use the longer delay
                }
            })
            .finally(() => {
                // Hide spinner only if not actively retrying with 'fetching' status
                 if (!document.getElementById("statusBadge").classList.contains('fetching')) {
                    spinnerContainer.style.display = "none";
                 }
                fetchBtn.disabled = false; // Always re-enable button after an attempt finishes
            });
    }

    function scheduleNextFetch() {
        if (refreshTimeout) {
            clearTimeout(refreshTimeout);
        }
        const now = new Date();
        const seconds = now.getSeconds();
        const milliseconds = now.getMilliseconds();
        let delay;

        // Target 20 seconds past the minute
        if (seconds < 20) {
            delay = (20 - seconds) * 1000 - milliseconds;
        } else {
            // If we are at 20s or later, schedule for 20s past the *next* minute
            delay = ((60 - seconds) + 20) * 1000 - milliseconds;
        }

        // Ensure minimum delay to avoid rapid loops if calculation is off
        delay = Math.max(delay, 1000);

        console.log(`Next automatic fetch scheduled in ${Math.round(delay / 1000)}s`);
        refreshTimeout = setTimeout(fetchWeather, delay);
    }

    function manualFetch() {
        console.log("Manual fetch requested.");
        if (refreshTimeout) {
            clearTimeout(refreshTimeout); // Cancel any scheduled fetch
        }
        retryAttempts = 0; // Reset retry counter on manual fetch
        fetchWeather(); // Fetch immediately
    }

     // Initial state setup
    setStatusBadge("Waiting", "waiting");
    window.addEventListener("load", () => {
        console.log("Page loaded, initiating first fetch...");
        fetchWeather(); // Start the fetch cycle on load
    });
  </script>
</body>
</html>